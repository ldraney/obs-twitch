<!DOCTYPE html>
<html>
<head>
  <title>Midnight Rain - Cosmic Lofi Experience</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/tone@14"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #030308;
      font-family: 'Consolas', 'Monaco', monospace;
    }

    #canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
    }

    /* Floating Controls Panel */
    .controls {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 100;
      background: rgba(3, 3, 8, 0.9);
      border: 1px solid rgba(100, 140, 180, 0.15);
      border-radius: 12px;
      padding: 20px;
      min-width: 200px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
    }

    .title {
      color: #6a9fcf;
      font-size: 18px;
      font-weight: bold;
      letter-spacing: 2px;
      margin-bottom: 15px;
      text-shadow: 0 0 20px rgba(100, 160, 210, 0.3);
    }

    .subtitle {
      color: #445;
      font-size: 11px;
      margin-bottom: 15px;
      font-style: italic;
    }

    .play-btn {
      width: 100%;
      padding: 14px 20px;
      font-size: 14px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 2px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
      background: linear-gradient(135deg, #4a6a8a 0%, #3a5070 100%);
      color: #fff;
      box-shadow: 0 4px 20px rgba(70, 100, 140, 0.3);
    }

    .play-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 30px rgba(70, 100, 140, 0.5);
    }

    .play-btn.playing {
      background: linear-gradient(135deg, #5a7a9a 0%, #4a6080 100%);
      box-shadow: 0 4px 20px rgba(90, 120, 160, 0.4);
    }

    .control-row {
      margin-top: 15px;
    }

    .control-label {
      display: flex;
      justify-content: space-between;
      color: #445;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 6px;
    }

    .control-value {
      color: #6a9fcf;
      font-weight: bold;
    }

    input[type="range"] {
      width: 100%;
      height: 6px;
      -webkit-appearance: none;
      appearance: none;
      background: rgba(100, 160, 210, 0.1);
      border-radius: 3px;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      background: #6a9fcf;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(100, 160, 210, 0.5);
    }

    input[type="range"]::-moz-range-thumb {
      width: 16px;
      height: 16px;
      background: #6a9fcf;
      border-radius: 50%;
      cursor: pointer;
      border: none;
      box-shadow: 0 0 10px rgba(100, 160, 210, 0.5);
    }

    /* Section Indicator */
    .section-indicator {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid rgba(255, 255, 255, 0.03);
    }

    .current-section {
      font-size: 22px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 4px;
      text-align: center;
      color: #6a9fcf;
      text-shadow: 0 0 30px currentColor;
      transition: color 0.3s;
    }

    .section-time {
      text-align: center;
      color: #445;
      font-size: 11px;
      margin-top: 8px;
    }

    /* Timeline at bottom */
    .timeline {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 50px;
      z-index: 100;
      background: linear-gradient(to top, rgba(3, 3, 8, 0.9), transparent);
      display: flex;
      align-items: flex-end;
      padding: 10px 20px;
    }

    .timeline-track {
      flex: 1;
      height: 30px;
      display: flex;
      border-radius: 6px;
      overflow: hidden;
      position: relative;
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.5);
    }

    .timeline-section {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: filter 0.2s, transform 0.1s;
      color: rgba(255, 255, 255, 0.7);
      border-right: 1px solid rgba(0, 0, 0, 0.3);
    }

    .timeline-section:last-child { border-right: none; }
    .timeline-section:hover { filter: brightness(1.3); }
    .timeline-section.active { filter: brightness(1.5); transform: scaleY(1.05); }

    .timeline-section.stillness { background: linear-gradient(180deg, #1a1a2a, #0a0a15); }
    .timeline-section.drops { background: linear-gradient(180deg, #2a3a4a, #1a2530); }
    .timeline-section.downpour { background: linear-gradient(180deg, #3a4a5a, #2a3540); }
    .timeline-section.thunder { background: linear-gradient(180deg, #4a5a6a, #3a4550); }
    .timeline-section.clearing { background: linear-gradient(180deg, #3a4a5a, #2a3540); }
    .timeline-section.aftermath { background: linear-gradient(180deg, #1a2a3a, #0a1520); }

    .playhead {
      position: absolute;
      width: 3px;
      height: 100%;
      background: #8ac;
      box-shadow: 0 0 12px #8ac;
      top: 0;
      left: 0;
      pointer-events: none;
      z-index: 10;
      border-radius: 2px;
    }

    /* Mobile adjustments */
    @media (max-width: 600px) {
      .controls {
        top: 10px;
        left: 10px;
        right: 10px;
        min-width: auto;
        padding: 15px;
      }

      .title { font-size: 14px; }
      .play-btn { padding: 12px 16px; font-size: 12px; }
      .timeline-section { font-size: 7px; }
    }

    .hint {
      position: fixed;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      color: #334;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 2px;
      z-index: 50;
    }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>

  <div class="controls">
    <div class="title">Midnight Rain</div>
    <div class="subtitle">// melancholy lofi experience</div>

    <button id="playBtn" class="play-btn">Begin</button>

    <div class="control-row">
      <div class="control-label">
        <span>Volume</span>
        <span class="control-value" id="volVal">-12 dB</span>
      </div>
      <input type="range" id="volumeSlider" min="-30" max="0" value="-12">
    </div>

    <div class="control-row">
      <div class="control-label">
        <span>BPM</span>
        <span class="control-value" id="bpmVal">70</span>
      </div>
      <input type="range" id="bpmSlider" min="60" max="80" value="70">
    </div>

    <div class="section-indicator">
      <div class="current-section" id="currentSection">Ready</div>
      <div class="section-time" id="sectionTime">0:00 / 3:26</div>
    </div>
  </div>

  <div class="timeline">
    <div class="timeline-track" id="timeline">
      <div class="playhead" id="playhead"></div>
    </div>
  </div>

  <div class="hint">Click timeline to jump</div>

  <script type="module">
    // ============================================================================
    // IMPORTS
    // ============================================================================

    import { CosmicVisuals } from '../visuals/cosmic/index.js';
    import { AudioAnalyzer } from '../lib/audio-analysis.js';

    // ============================================================================
    // GLOBAL STATE
    // ============================================================================

    const canvas = document.getElementById('canvas');

    let isInitialized = false;
    let isPlaying = false;
    let currentSectionIndex = 0;

    // Modules
    let visuals = null;
    let audioAnalyzer = null;

    // Audio nodes
    let masterFilter, reverb, delay, compressor;
    let kick, snare, hihat, rimshot;
    let piano, pad, bass;
    let rainNoise, rainFilter;
    let filterLFO;
    let drumLoop, pianoLoop, bassLoop, padLoop;

    // Song structure (60 bars @ 70 BPM = ~3:26)
    const songStructure = [
      { name: 'stillness', startBar: 0, bars: 8, label: 'Stillness', color: '#4a6080' },
      { name: 'drops', startBar: 8, bars: 12, label: 'First Drops', color: '#5a7090' },
      { name: 'downpour', startBar: 20, bars: 16, label: 'Downpour', color: '#6a80a0' },
      { name: 'thunder', startBar: 36, bars: 12, label: 'Thunder', color: '#7a90b0' },
      { name: 'clearing', startBar: 48, bars: 8, label: 'Clearing', color: '#5a7090' },
      { name: 'aftermath', startBar: 56, bars: 4, label: 'Aftermath', color: '#3a5070' }
    ];
    const totalBars = 60;

    // Section configurations
    const sectionConfigs = {
      stillness: {
        rain: true, pad: true, piano: false, kick: false, snare: false, bass: false,
        filterFreq: 400, reverbWet: 0.85, padVol: -22, pianoVol: -Infinity
      },
      drops: {
        rain: true, pad: true, piano: true, kick: false, snare: false, bass: false,
        filterFreq: 600, reverbWet: 0.75, padVol: -18, pianoVol: -14
      },
      downpour: {
        rain: true, pad: true, piano: true, kick: true, snare: true, bass: true,
        filterFreq: 1000, reverbWet: 0.65, padVol: -14, pianoVol: -10
      },
      thunder: {
        rain: true, pad: true, piano: true, kick: true, snare: true, bass: true,
        filterFreq: 1400, reverbWet: 0.55, padVol: -10, pianoVol: -8
      },
      clearing: {
        rain: true, pad: true, piano: true, kick: false, snare: false, bass: true,
        filterFreq: 800, reverbWet: 0.7, padVol: -16, pianoVol: -12
      },
      aftermath: {
        rain: true, pad: true, piano: true, kick: false, snare: false, bass: false,
        filterFreq: 350, reverbWet: 0.9, padVol: -24, pianoVol: -18
      }
    };

    // ============================================================================
    // INITIALIZE VISUALS (moody blue/indigo theme)
    // ============================================================================

    visuals = new CosmicVisuals(canvas, {
      baseHue: 220,           // Blue instead of purple
      hueShiftRange: 20,      // Subtle shift
      nebulaCount: 40,        // More nebula for rain-like effect
      starSpeeds: [0.05, 0.1, 0.2],  // Slower, more contemplative
      maxShootingStars: 3,
      enableAurora: true,
      auroraSpeed: 0.003      // Slow, subtle aurora
    });

    // ============================================================================
    // AUDIO INITIALIZATION
    // ============================================================================

    async function initAudio() {
      if (isInitialized) return;

      await Tone.start();

      // Initialize audio analyzer
      audioAnalyzer = new AudioAnalyzer({ bandCount: 8 });
      audioAnalyzer.init();

      Tone.Transport.bpm.value = 70;
      Tone.Transport.swing = 0.15;  // More swing for jazz feel
      Tone.Transport.swingSubdivision = '16n';

      // Compressor
      compressor = new Tone.Compressor({
        threshold: -20,
        ratio: 4,
        attack: 0.01,
        release: 0.25
      }).toDestination();

      // Master filter (warm, muffled)
      masterFilter = new Tone.Filter({
        frequency: 800,
        type: 'lowpass',
        rolloff: -24,
        Q: 0.6
      }).connect(compressor);

      // Filter LFO (gentle breathing)
      filterLFO = new Tone.LFO({
        frequency: 0.03,
        min: 500,
        max: 1200,
        type: 'sine'
      });

      // Large reverb (rainy night ambience)
      reverb = new Tone.Reverb({ decay: 6, wet: 0.7 });
      await reverb.generate();
      reverb.connect(masterFilter);

      // Delay (echoes in the night)
      delay = new Tone.FeedbackDelay('8n.', 0.35);  // Dotted 8th (~0.64s at 70bpm, within 1s limit)
      delay.wet.value = 0.2;
      delay.connect(masterFilter);

      // Rain noise (filtered pink noise)
      rainFilter = new Tone.Filter({
        frequency: 1200,
        type: 'bandpass',
        Q: 0.8
      }).connect(compressor);
      rainNoise = new Tone.Noise('pink');
      rainNoise.connect(rainFilter);
      rainNoise.volume.value = -28;

      // Soft kick
      kick = new Tone.MembraneSynth({
        pitchDecay: 0.06,
        octaves: 3,
        oscillator: { type: 'sine' },
        envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.3 }
      }).connect(masterFilter);
      kick.volume.value = -Infinity;

      // Brush snare (soft, jazzy)
      snare = new Tone.NoiseSynth({
        noise: { type: 'white' },
        envelope: { attack: 0.01, decay: 0.12, sustain: 0, release: 0.08 }
      }).connect(reverb);
      snare.volume.value = -Infinity;

      // Soft hi-hat
      hihat = new Tone.MetalSynth({
        frequency: 250,
        envelope: { attack: 0.001, decay: 0.06, release: 0.01 },
        harmonicity: 5,
        modulationIndex: 15,
        resonance: 4000,
        octaves: 1
      }).connect(reverb);
      hihat.volume.value = -Infinity;

      // Rimshot for accents
      rimshot = new Tone.NoiseSynth({
        noise: { type: 'pink' },
        envelope: { attack: 0.001, decay: 0.05, sustain: 0, release: 0.03 }
      }).connect(delay);
      rimshot.volume.value = -Infinity;

      // Sparse piano (the heart of the melancholy)
      piano = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: 'triangle' },
        envelope: { attack: 0.02, decay: 1.5, sustain: 0.3, release: 2 }
      });
      const pianoFilter = new Tone.Filter({
        frequency: 2000,
        type: 'lowpass',
        rolloff: -12
      }).connect(delay).connect(reverb);
      piano.connect(pianoFilter);
      piano.volume.value = -Infinity;

      // Warm pad (underlying emotion)
      pad = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: 'sine' },
        envelope: { attack: 2, decay: 1.5, sustain: 0.6, release: 4 }
      });
      const padChorus = new Tone.Chorus({
        frequency: 0.2,
        delayTime: 4,
        depth: 0.5,
        wet: 0.4
      }).connect(reverb);
      await padChorus.start();
      pad.connect(padChorus);
      pad.volume.value = -20;

      // Deep bass
      bass = new Tone.Synth({
        oscillator: { type: 'sine' },
        envelope: { attack: 0.08, decay: 0.4, sustain: 0.5, release: 0.6 }
      }).connect(masterFilter);
      bass.volume.value = -Infinity;

      createPatterns();
      scheduleStructure();
      buildTimeline();

      // Set initial volume
      Tone.Destination.volume.value = -12;

      isInitialized = true;
    }

    // ============================================================================
    // PATTERNS
    // ============================================================================

    function createPatterns() {
      // Minimal, jazzy drum loop
      drumLoop = new Tone.Loop((time) => {
        const bar = parseInt(Tone.Transport.position.split(':')[0]);
        const beat = parseInt(Tone.Transport.position.split(':')[1]);
        const sixteenth = Math.floor(parseFloat(Tone.Transport.position.split(':')[2]) / 0.25);

        const humanize = () => (Math.random() - 0.5) * 0.025;
        const velVar = () => 0.6 + Math.random() * 0.4;

        // Sparse kick: beat 1, sometimes ghost on 4+
        if (beat === 0 && sixteenth === 0) {
          kick.triggerAttackRelease('C1', '4n', time + humanize(), velVar());
        }
        if (beat === 3 && sixteenth === 2 && Math.random() > 0.5) {
          kick.triggerAttackRelease('C1', '8n', time + humanize(), velVar() * 0.5);
        }

        // Brush snare on 2 and 4 (very soft)
        if ((beat === 1 || beat === 3) && sixteenth === 0) {
          snare.triggerAttackRelease('16n', time + humanize(), velVar() * 0.4);
        }

        // Ghost snares
        if (sixteenth === 2 && (beat === 0 || beat === 2) && Math.random() > 0.6) {
          snare.triggerAttackRelease('32n', time + humanize(), velVar() * 0.2);
        }

        // Soft hi-hat on offbeats
        if (sixteenth % 2 === 1 && Math.random() > 0.3) {
          const vel = 0.15 + Math.random() * 0.2;
          hihat.triggerAttackRelease('32n', time + humanize(), vel);

          // Occasional shooting star on hi-hat
          if (Math.random() > 0.85 && visuals) {
            visuals.spawnShootingStar();
          }
        }

        // Rimshot accents (very sparse)
        if (bar % 4 === 3 && beat === 3 && sixteenth === 0 && Math.random() > 0.5) {
          rimshot.triggerAttackRelease('16n', time + humanize(), velVar() * 0.5);
        }
      }, '16n');

      // Melancholy piano - sparse, emotional
      // Minor chord progression: Am - Em - Dm - Am (then variation)
      const pianoPatterns = [
        // Bar 1-2: Am (sparse)
        [
          { time: '0:0:0', notes: ['A3'], dur: '2n', vel: 0.5 },
          { time: '0:2:0', notes: ['E4'], dur: '4n', vel: 0.4 },
          { time: '0:3:2', notes: ['C4'], dur: '8n', vel: 0.3 },
          { time: '1:1:0', notes: ['A3', 'E4'], dur: '2n', vel: 0.45 },
        ],
        // Bar 3-4: Em
        [
          { time: '0:0:0', notes: ['E3'], dur: '2n', vel: 0.5 },
          { time: '0:2:2', notes: ['B3'], dur: '4n', vel: 0.4 },
          { time: '1:0:0', notes: ['G3'], dur: '4n', vel: 0.35 },
          { time: '1:2:0', notes: ['E4', 'B3'], dur: '2n', vel: 0.45 },
        ],
        // Bar 5-6: Dm
        [
          { time: '0:0:0', notes: ['D3'], dur: '2n', vel: 0.5 },
          { time: '0:2:0', notes: ['F3'], dur: '4n', vel: 0.4 },
          { time: '0:3:0', notes: ['A3'], dur: '8n', vel: 0.35 },
          { time: '1:1:0', notes: ['D4'], dur: '4n', vel: 0.4 },
          { time: '1:3:0', notes: ['F4'], dur: '8n', vel: 0.3 },
        ],
        // Bar 7-8: Am -> E (tension)
        [
          { time: '0:0:0', notes: ['A3'], dur: '4n', vel: 0.5 },
          { time: '0:2:0', notes: ['C4'], dur: '4n', vel: 0.4 },
          { time: '1:0:0', notes: ['E3', 'G#3', 'B3'], dur: '2n', vel: 0.55 },
        ],
      ];

      let patternIndex = 0;
      pianoLoop = new Tone.Loop((time) => {
        const pattern = pianoPatterns[patternIndex % pianoPatterns.length];
        pattern.forEach(({ notes, dur, vel }) => {
          // Add slight humanization
          const noteVel = vel * (0.9 + Math.random() * 0.2);
          piano.triggerAttackRelease(
            notes,
            dur,
            time + (Math.random() - 0.5) * 0.02,
            noteVel
          );
        });
        patternIndex++;
      }, '2m');

      // Warm pad (follows chord roots)
      const padChords = [
        { notes: ['A2', 'E3', 'A3'] },      // Am
        { notes: ['E2', 'B2', 'E3'] },      // Em
        { notes: ['D2', 'A2', 'D3'] },      // Dm
        { notes: ['A2', 'E3', 'A3'] },      // Am
      ];
      let padIndex = 0;

      padLoop = new Tone.Loop((time) => {
        const chord = padChords[padIndex % padChords.length];
        pad.triggerAttackRelease(
          chord.notes,
          '2m',
          time + (Math.random() - 0.5) * 0.1,
          0.35 + Math.random() * 0.15
        );
        padIndex++;
      }, '2m');

      // Deep bass
      const bassNotes = ['A1', 'E1', 'D1', 'A1'];
      let bassIndex = 0;

      bassLoop = new Tone.Loop((time) => {
        const note = bassNotes[bassIndex % bassNotes.length];
        bass.triggerAttackRelease(
          note,
          '2m',
          time + (Math.random() - 0.5) * 0.03,
          0.55 + Math.random() * 0.2
        );
        bassIndex++;
      }, '2m');
    }

    // ============================================================================
    // SONG STRUCTURE
    // ============================================================================

    function scheduleStructure() {
      Tone.Transport.cancel();

      songStructure.forEach((section, index) => {
        Tone.Transport.schedule((time) => {
          currentSectionIndex = index;
          applySection(section.name, time);
          Tone.Draw.schedule(() => updateSectionDisplay(section, index), time);
        }, `${section.startBar}:0:0`);
      });

      // Smooth filter automation
      Tone.Transport.schedule((time) => {
        masterFilter.frequency.exponentialRampTo(600, 6, time);
      }, '6:0:0');

      Tone.Transport.schedule((time) => {
        masterFilter.frequency.exponentialRampTo(1000, 10, time);
      }, '18:0:0');

      Tone.Transport.schedule((time) => {
        masterFilter.frequency.exponentialRampTo(1400, 8, time);
      }, '34:0:0');

      Tone.Transport.schedule((time) => {
        masterFilter.frequency.exponentialRampTo(800, 6, time);
      }, '46:0:0');

      Tone.Transport.schedule((time) => {
        masterFilter.frequency.exponentialRampTo(350, 4, time);
        pad.volume.rampTo(-28, 4, time);
        piano.volume.rampTo(-22, 4, time);
      }, '56:0:0');

      // Enable looping
      Tone.Transport.loop = true;
      Tone.Transport.loopStart = 0;
      Tone.Transport.loopEnd = `${totalBars}:0:0`;
    }

    function applySection(name, time) {
      const config = sectionConfigs[name];
      const rampTime = 0.8;

      masterFilter.frequency.rampTo(config.filterFreq, rampTime, time);
      reverb.wet.rampTo(config.reverbWet, rampTime, time);

      kick.volume.rampTo(config.kick ? -10 : -Infinity, 0.5, time);
      snare.volume.rampTo(config.snare ? -16 : -Infinity, 0.5, time);
      hihat.volume.rampTo(config.kick ? -22 : -Infinity, 0.5, time);
      rimshot.volume.rampTo(config.snare ? -18 : -Infinity, 0.5, time);
      bass.volume.rampTo(config.bass ? -8 : -Infinity, 0.5, time);
      pad.volume.rampTo(config.padVol, 0.5, time);
      piano.volume.rampTo(config.pianoVol, 0.5, time);
    }

    function updateSectionDisplay(section, index) {
      const el = document.getElementById('currentSection');
      el.textContent = section.label;
      el.style.color = section.color;

      document.querySelectorAll('.timeline-section').forEach((s, i) => {
        s.classList.toggle('active', i === index);
      });
    }

    // ============================================================================
    // TIMELINE
    // ============================================================================

    function buildTimeline() {
      const timeline = document.getElementById('timeline');
      timeline.innerHTML = '<div class="playhead" id="playhead"></div>';

      songStructure.forEach((section, index) => {
        const div = document.createElement('div');
        div.className = `timeline-section ${section.name}`;
        div.style.width = `${(section.bars / totalBars) * 100}%`;
        div.textContent = section.label;
        div.addEventListener('click', () => jumpToSection(index));
        timeline.appendChild(div);
      });
    }

    function jumpToSection(index) {
      if (!isInitialized) return;

      const section = songStructure[index];
      currentSectionIndex = index;
      Tone.Transport.position = `${section.startBar}:0:0`;
      applySection(section.name, Tone.now());
      updateSectionDisplay(section, index);

      if (!isPlaying) startPlayback();
    }

    // ============================================================================
    // PLAYBACK
    // ============================================================================

    async function startPlayback() {
      if (!isInitialized) await initAudio();
      if (isPlaying) return;

      drumLoop.start(0);
      pianoLoop.start(0);
      padLoop.start(0);
      bassLoop.start(0);
      rainNoise.start();
      filterLFO.start();

      Tone.Transport.start();
      isPlaying = true;

      document.getElementById('playBtn').textContent = 'Stop';
      document.getElementById('playBtn').classList.add('playing');
    }

    function stopPlayback() {
      drumLoop.stop();
      pianoLoop.stop();
      padLoop.stop();
      bassLoop.stop();
      rainNoise.stop();
      filterLFO.stop();

      Tone.Transport.stop();
      Tone.Transport.position = 0;
      isPlaying = false;
      currentSectionIndex = 0;

      document.getElementById('playBtn').textContent = 'Begin';
      document.getElementById('playBtn').classList.remove('playing');
      document.getElementById('currentSection').textContent = 'Ready';
      document.getElementById('currentSection').style.color = '#6a9fcf';
      document.getElementById('playhead').style.left = '0%';
    }

    // ============================================================================
    // RENDER LOOP
    // ============================================================================

    function render() {
      // Get audio features
      const audioFeatures = audioAnalyzer ? audioAnalyzer.analyze() : {
        rms: 0, bass: 0, mid: 0, high: 0, bands: new Array(8).fill(0), pulse: 0
      };

      // Update and draw visuals
      visuals.update(audioFeatures, 1.0);
      visuals.draw();

      // Update UI
      if (isPlaying) {
        updateProgress();
      }

      requestAnimationFrame(render);
    }

    function updateProgress() {
      const position = Tone.Transport.position;
      const parts = position.split(':');
      const bar = parseInt(parts[0]);
      const beat = parseInt(parts[1]);
      const progressBars = bar + beat / 4;
      const percent = (progressBars / totalBars) * 100;

      document.getElementById('playhead').style.left = `${Math.min(percent, 100)}%`;

      const bpm = Tone.Transport.bpm.value;
      const secondsPerBar = (60 / bpm) * 4;
      const currentSeconds = progressBars * secondsPerBar;
      const totalSeconds = totalBars * secondsPerBar;

      const formatTime = (s) => {
        const m = Math.floor(s / 60);
        const sec = Math.floor(s % 60).toString().padStart(2, '0');
        return `${m}:${sec}`;
      };

      document.getElementById('sectionTime').textContent =
        `${formatTime(currentSeconds)} / ${formatTime(totalSeconds)}`;
    }

    // ============================================================================
    // EVENT LISTENERS
    // ============================================================================

    document.getElementById('playBtn').addEventListener('click', async () => {
      if (isPlaying) {
        stopPlayback();
      } else {
        if (!isInitialized) await initAudio();
        Tone.Transport.position = 0;
        currentSectionIndex = 0;
        applySection('stillness', Tone.now());
        updateSectionDisplay(songStructure[0], 0);
        startPlayback();
      }
    });

    document.getElementById('volumeSlider').addEventListener('input', (e) => {
      const vol = parseFloat(e.target.value);
      Tone.Destination.volume.value = vol;
      document.getElementById('volVal').textContent = `${vol} dB`;
    });

    document.getElementById('bpmSlider').addEventListener('input', (e) => {
      const val = parseInt(e.target.value);
      document.getElementById('bpmVal').textContent = val;
      Tone.Transport.bpm.value = val;
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', async (e) => {
      if (e.key === ' ') {
        e.preventDefault();
        if (isPlaying) {
          stopPlayback();
        } else {
          if (!isInitialized) await initAudio();
          Tone.Transport.position = 0;
          applySection('stillness', Tone.now());
          updateSectionDisplay(songStructure[0], 0);
          startPlayback();
        }
      }

      const num = parseInt(e.key);
      if (num >= 1 && num <= 6 && isInitialized) {
        jumpToSection(num - 1);
      }
    });

    // Touch support
    canvas.addEventListener('touchstart', async (e) => {
      if (!isPlaying) {
        e.preventDefault();
        if (!isInitialized) await initAudio();
        Tone.Transport.position = 0;
        applySection('stillness', Tone.now());
        updateSectionDisplay(songStructure[0], 0);
        startPlayback();
      }
    }, { passive: false });

    // Build initial timeline
    function buildInitialTimeline() {
      const timeline = document.getElementById('timeline');
      timeline.innerHTML = '<div class="playhead" id="playhead"></div>';

      songStructure.forEach((section) => {
        const div = document.createElement('div');
        div.className = `timeline-section ${section.name}`;
        div.style.width = `${(section.bars / totalBars) * 100}%`;
        div.textContent = section.label;
        timeline.appendChild(div);
      });
    }

    buildInitialTimeline();

    // Cleanup
    window.addEventListener('beforeunload', () => {
      if (isPlaying) stopPlayback();
      if (visuals) visuals.dispose();
      if (audioAnalyzer) audioAnalyzer.dispose();
    });

    // Start render loop
    render();
  </script>
</body>
</html>
