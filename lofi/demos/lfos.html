<!DOCTYPE html>
<html>
<head>
  <title>LFOs - Demo</title>
  <script src="https://unpkg.com/tone@14"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #eee;
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .container { max-width: 1000px; margin: 0 auto; }
    h1 { color: #e94560; margin-bottom: 10px; }
    h2 { color: #4ecdc4; margin-top: 30px; margin-bottom: 15px; }
    .subtitle { color: #888; margin-bottom: 30px; }

    .section {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }

    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }

    .control {
      background: rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 8px;
    }
    .control label {
      display: block;
      color: #888;
      font-size: 12px;
      margin-bottom: 5px;
    }
    .control .value {
      color: #e94560;
      font-weight: bold;
      float: right;
    }
    .control input[type="range"] {
      width: 100%;
      margin-top: 5px;
      accent-color: #4ecdc4;
    }
    .control select {
      width: 100%;
      padding: 8px;
      background: #2a2a4e;
      color: #eee;
      border: 1px solid #444;
      border-radius: 4px;
      font-size: 14px;
    }

    button {
      background: #e94560;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 8px;
      margin: 5px;
      transition: all 0.2s;
    }
    button:hover { background: #ff6b6b; transform: scale(1.02); }
    button:active { transform: scale(0.98); }
    button:disabled { background: #444; cursor: not-allowed; transform: none; }
    button.secondary {
      background: #4ecdc4;
    }
    button.secondary:hover { background: #6ee7df; }
    button.active {
      background: #4ecdc4;
      box-shadow: 0 0 15px rgba(78, 205, 196, 0.5);
    }

    .selector-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 15px 0;
    }
    .selector-btn {
      background: rgba(255,255,255,0.1);
      border: 2px solid #444;
      padding: 10px 20px;
      color: #888;
      font-size: 14px;
    }
    .selector-btn.active {
      background: rgba(233, 69, 96, 0.2);
      border-color: #e94560;
      color: #e94560;
    }
    .selector-btn:hover {
      border-color: #666;
      transform: none;
    }

    /* LFO Visualization */
    .lfo-visual-container {
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    #lfoCanvas {
      width: 100%;
      height: 150px;
      background: rgba(0,0,0,0.5);
      border-radius: 8px;
    }
    .visual-labels {
      display: flex;
      justify-content: space-between;
      color: #666;
      font-size: 11px;
      margin-top: 8px;
    }
    .lfo-value-display {
      text-align: center;
      margin-top: 10px;
      font-size: 24px;
      font-weight: bold;
      color: #4ecdc4;
    }
    .lfo-value-label {
      font-size: 12px;
      color: #888;
      font-weight: normal;
    }

    /* Presets */
    .presets {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 15px 0;
    }
    .preset-btn {
      background: rgba(78, 205, 196, 0.15);
      color: #4ecdc4;
      border: 2px solid #4ecdc4;
      padding: 12px 18px;
      font-size: 13px;
    }
    .preset-btn:hover {
      background: rgba(78, 205, 196, 0.3);
      transform: translateY(-2px);
    }
    .preset-btn.active {
      background: #4ecdc4;
      color: #1a1a2e;
      font-weight: bold;
    }

    .info-box {
      background: rgba(78, 205, 196, 0.1);
      border-left: 4px solid #4ecdc4;
      padding: 15px;
      margin: 15px 0;
      border-radius: 0 8px 8px 0;
    }
    .info-box strong { color: #4ecdc4; }

    .tip-box {
      background: rgba(233, 69, 96, 0.1);
      border-left: 4px solid #e94560;
      padding: 15px;
      margin: 15px 0;
      border-radius: 0 8px 8px 0;
    }
    .tip-box strong { color: #e94560; }

    #status {
      padding: 12px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      font-size: 14px;
      color: #888;
      text-align: center;
      margin: 15px 0;
    }

    .play-controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      margin: 20px 0;
    }

    /* Parameter indicator */
    .param-indicator {
      height: 8px;
      background: rgba(0,0,0,0.3);
      border-radius: 4px;
      margin: 10px 0;
      overflow: hidden;
    }
    .param-indicator-fill {
      height: 100%;
      background: linear-gradient(90deg, #e94560, #4ecdc4);
      border-radius: 4px;
      transition: width 0.05s;
    }

    .target-info {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin: 20px 0;
    }
    .target-card {
      background: rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      border: 2px solid transparent;
      transition: all 0.2s;
    }
    .target-card.active {
      border-color: #e94560;
      background: rgba(233, 69, 96, 0.1);
    }
    .target-card h4 {
      color: #4ecdc4;
      margin: 0 0 8px 0;
      font-size: 14px;
    }
    .target-card .current-value {
      font-size: 18px;
      font-weight: bold;
      color: #e94560;
    }
    .target-card .unit {
      font-size: 12px;
      color: #888;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>LFOs (Low Frequency Oscillators)</h1>
    <p class="subtitle">Add movement and animation to your sound with slow modulation</p>

    <div id="status">Click "Start Audio" to begin experimenting with LFOs</div>

    <div class="section">
      <h2>1. LFO Target</h2>
      <p>Choose what parameter the LFO will modulate:</p>

      <div class="selector-group" id="targetSelector">
        <button class="selector-btn active" data-target="filter">Filter Cutoff</button>
        <button class="selector-btn" data-target="volume">Volume (Tremolo)</button>
        <button class="selector-btn" data-target="pan">Pan (Auto-Pan)</button>
      </div>

      <div class="target-info">
        <div class="target-card active" id="filterCard">
          <h4>Filter Cutoff</h4>
          <div class="current-value" id="filterValue">800</div>
          <div class="unit">Hz</div>
        </div>
        <div class="target-card" id="volumeCard">
          <h4>Volume</h4>
          <div class="current-value" id="volumeValue">100</div>
          <div class="unit">%</div>
        </div>
        <div class="target-card" id="panCard">
          <h4>Pan</h4>
          <div class="current-value" id="panValue">C</div>
          <div class="unit">L/C/R</div>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>2. LFO Shape</h2>
      <p>Different waveforms create different modulation character:</p>

      <div class="selector-group" id="shapeSelector">
        <button class="selector-btn active" data-shape="sine">Sine (Smooth)</button>
        <button class="selector-btn" data-shape="triangle">Triangle (Linear)</button>
        <button class="selector-btn" data-shape="square">Square (Stepped)</button>
        <button class="selector-btn" data-shape="sawtooth">Sawtooth (Ramp)</button>
      </div>

      <div class="lfo-visual-container">
        <canvas id="lfoCanvas"></canvas>
        <div class="visual-labels">
          <span>Max</span>
          <span>LFO Output</span>
          <span>Min</span>
        </div>
        <div class="lfo-value-display">
          <span class="lfo-value-label">Current LFO Value: </span>
          <span id="lfoValueText">0.50</span>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>3. LFO Controls</h2>

      <div class="controls-grid">
        <div class="control">
          <label>Rate (Frequency) <span class="value" id="rateVal">0.5 Hz</span></label>
          <input type="range" id="lfoRate" min="0.1" max="10" step="0.1" value="0.5">
        </div>
        <div class="control">
          <label>Depth (Amount) <span class="value" id="depthVal">50%</span></label>
          <input type="range" id="lfoDepth" min="0" max="100" step="5" value="50">
        </div>
      </div>

      <div class="controls-grid">
        <div class="control">
          <label>Min Value <span class="value" id="minVal">400 Hz</span></label>
          <input type="range" id="lfoMin" min="100" max="2000" step="50" value="400">
        </div>
        <div class="control">
          <label>Max Value <span class="value" id="maxVal">2000 Hz</span></label>
          <input type="range" id="lfoMax" min="500" max="4000" step="50" value="2000">
        </div>
      </div>

      <div class="param-indicator">
        <div class="param-indicator-fill" id="paramIndicator" style="width: 50%"></div>
      </div>

      <div class="tip-box">
        <strong>Tip:</strong> For lofi, keep rates slow (0.1-2 Hz) and depths subtle (20-50%). Fast or extreme settings sound modern and aggressive.
      </div>
    </div>

    <div class="section">
      <h2>4. Presets</h2>
      <p>Try these classic lofi LFO configurations:</p>

      <div class="presets">
        <button class="preset-btn" data-preset="subtleWobble">Subtle Wobble</button>
        <button class="preset-btn" data-preset="slowSweep">Slow Filter Sweep</button>
        <button class="preset-btn" data-preset="tremolo">Tremolo</button>
        <button class="preset-btn" data-preset="autoPan">Auto-Pan</button>
      </div>
    </div>

    <div class="section">
      <h2>5. Listen</h2>
      <p>Play a sustained chord to hear the LFO modulation:</p>

      <div class="play-controls">
        <button id="startAudio">Start Audio</button>
        <button id="playChord" disabled>Play Chord</button>
        <button id="holdChord" disabled>Hold Chord</button>
        <button id="stopChord" disabled>Stop</button>
      </div>

      <div class="info-box">
        <strong>What to listen for:</strong>
        <ul style="margin: 10px 0; padding-left: 20px;">
          <li><strong>Filter:</strong> Sound opens and closes, like breathing</li>
          <li><strong>Volume:</strong> Pulsing, wavering effect (tremolo)</li>
          <li><strong>Pan:</strong> Sound moves between left and right speakers</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    // State
    let audioStarted = false;
    let synth = null;
    let filter = null;
    let panner = null;
    let gain = null;
    let lfo = null;
    let reverb = null;
    let isHolding = false;
    let animationId = null;

    // Current settings
    let currentTarget = 'filter';
    let currentShape = 'sine';
    let currentRate = 0.5;
    let currentDepth = 0.5;
    let currentMin = 400;
    let currentMax = 2000;

    // Canvas setup
    const canvas = document.getElementById('lfoCanvas');
    const ctx = canvas.getContext('2d');
    let lfoHistory = [];
    const historyLength = 200;

    function resizeCanvas() {
      canvas.width = canvas.offsetWidth * window.devicePixelRatio;
      canvas.height = canvas.offsetHeight * window.devicePixelRatio;
      ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    // Initialize audio
    async function initAudio() {
      await Tone.start();

      // Create synth with warm pad sound
      synth = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: 'triangle' },
        envelope: {
          attack: 0.2,
          decay: 0.3,
          sustain: 0.7,
          release: 1.5
        }
      });
      synth.volume.value = -12;

      // Create filter
      filter = new Tone.Filter({
        frequency: 800,
        type: 'lowpass',
        rolloff: -12,
        Q: 1
      });

      // Create panner
      panner = new Tone.Panner(0);

      // Create gain for tremolo
      gain = new Tone.Gain(1);

      // Create reverb for some space
      reverb = new Tone.Reverb({ decay: 2, wet: 0.3 });
      await reverb.generate();

      // Create LFO
      lfo = new Tone.LFO({
        frequency: currentRate,
        min: currentMin,
        max: currentMax,
        type: currentShape
      });

      // Chain: synth -> filter -> gain -> panner -> reverb -> destination
      synth.connect(filter);
      filter.connect(gain);
      gain.connect(panner);
      panner.connect(reverb);
      reverb.toDestination();

      // Connect LFO to filter by default
      lfo.connect(filter.frequency);
      lfo.start();

      audioStarted = true;
      updateStatus('Audio ready! Play a chord to hear the LFO modulation.');

      document.getElementById('startAudio').disabled = true;
      document.getElementById('playChord').disabled = false;
      document.getElementById('holdChord').disabled = false;

      // Start visualization
      startVisualization();
    }

    function updateStatus(msg) {
      document.getElementById('status').textContent = msg;
    }

    // Update LFO connection based on target
    function updateLFOTarget() {
      if (!lfo) return;

      // Disconnect from all targets
      try { lfo.disconnect(); } catch(e) {}

      // Reset all targets to neutral
      filter.frequency.value = 800;
      gain.gain.value = 1;
      panner.pan.value = 0;

      // Update min/max ranges based on target
      if (currentTarget === 'filter') {
        lfo.min = currentMin;
        lfo.max = currentMax;
        lfo.connect(filter.frequency);
        updateMinMaxLabels('Hz', 100, 2000, 500, 4000);
      } else if (currentTarget === 'volume') {
        // Volume goes from (1-depth) to 1
        const minVol = 1 - currentDepth;
        lfo.min = minVol;
        lfo.max = 1;
        lfo.connect(gain.gain);
        updateMinMaxLabels('%', 0, 100, 0, 100);
      } else if (currentTarget === 'pan') {
        // Pan goes from -1 to 1
        lfo.min = -currentDepth;
        lfo.max = currentDepth;
        lfo.connect(panner.pan);
        updateMinMaxLabels('', -100, 0, 0, 100);
      }

      // Update target cards
      document.querySelectorAll('.target-card').forEach(card => card.classList.remove('active'));
      document.getElementById(currentTarget + 'Card').classList.add('active');
    }

    function updateMinMaxLabels(unit, minMin, minMax, maxMin, maxMax) {
      const minSlider = document.getElementById('lfoMin');
      const maxSlider = document.getElementById('lfoMax');

      if (currentTarget === 'filter') {
        minSlider.min = 100;
        minSlider.max = 2000;
        minSlider.value = currentMin;
        maxSlider.min = 500;
        maxSlider.max = 4000;
        maxSlider.value = currentMax;
        document.getElementById('minVal').textContent = currentMin + ' Hz';
        document.getElementById('maxVal').textContent = currentMax + ' Hz';
      } else {
        // Hide min/max for volume and pan (controlled by depth)
        minSlider.disabled = true;
        maxSlider.disabled = true;
        document.getElementById('minVal').textContent = 'N/A';
        document.getElementById('maxVal').textContent = 'N/A';
      }

      if (currentTarget === 'filter') {
        minSlider.disabled = false;
        maxSlider.disabled = false;
      }
    }

    // Update target value displays
    function updateTargetDisplays() {
      if (!lfo || !filter || !gain || !panner) return;

      // Get current LFO value (0-1 normalized)
      const now = Tone.now();

      // Calculate approximate LFO value based on shape and time
      let lfoValue;
      const phase = (now * currentRate) % 1;

      switch (currentShape) {
        case 'sine':
          lfoValue = (Math.sin(phase * Math.PI * 2) + 1) / 2;
          break;
        case 'triangle':
          lfoValue = phase < 0.5 ? phase * 2 : 2 - phase * 2;
          break;
        case 'square':
          lfoValue = phase < 0.5 ? 1 : 0;
          break;
        case 'sawtooth':
          lfoValue = phase;
          break;
        default:
          lfoValue = 0.5;
      }

      // Apply depth
      lfoValue = 0.5 + (lfoValue - 0.5) * currentDepth;

      // Update displays based on current target
      if (currentTarget === 'filter') {
        const filterFreq = currentMin + (currentMax - currentMin) * lfoValue;
        document.getElementById('filterValue').textContent = Math.round(filterFreq);
      } else if (currentTarget === 'volume') {
        const vol = Math.round((1 - currentDepth + currentDepth * lfoValue) * 100);
        document.getElementById('volumeValue').textContent = vol;
      } else if (currentTarget === 'pan') {
        const panVal = (lfoValue - 0.5) * 2 * currentDepth;
        let panText = 'C';
        if (panVal < -0.1) panText = 'L' + Math.round(Math.abs(panVal) * 100);
        else if (panVal > 0.1) panText = 'R' + Math.round(panVal * 100);
        document.getElementById('panValue').textContent = panText;
      }

      // Update LFO value text
      document.getElementById('lfoValueText').textContent = lfoValue.toFixed(2);

      // Update parameter indicator
      document.getElementById('paramIndicator').style.width = (lfoValue * 100) + '%';

      return lfoValue;
    }

    // Visualization
    function startVisualization() {
      function draw() {
        const width = canvas.offsetWidth;
        const height = canvas.offsetHeight;

        ctx.clearRect(0, 0, width, height);

        // Get current LFO value
        const lfoValue = updateTargetDisplays();

        // Add to history
        lfoHistory.push(lfoValue);
        if (lfoHistory.length > historyLength) {
          lfoHistory.shift();
        }

        // Draw grid lines
        ctx.strokeStyle = 'rgba(255,255,255,0.1)';
        ctx.lineWidth = 1;
        for (let i = 0; i <= 4; i++) {
          const y = (i / 4) * height;
          ctx.beginPath();
          ctx.moveTo(0, y);
          ctx.lineTo(width, y);
          ctx.stroke();
        }

        // Draw center line
        ctx.strokeStyle = 'rgba(255,255,255,0.2)';
        ctx.beginPath();
        ctx.moveTo(0, height / 2);
        ctx.lineTo(width, height / 2);
        ctx.stroke();

        // Draw LFO history
        if (lfoHistory.length > 1) {
          ctx.strokeStyle = '#e94560';
          ctx.lineWidth = 2;
          ctx.beginPath();

          for (let i = 0; i < lfoHistory.length; i++) {
            const x = (i / historyLength) * width;
            const y = height - lfoHistory[i] * height;

            if (i === 0) {
              ctx.moveTo(x, y);
            } else {
              ctx.lineTo(x, y);
            }
          }
          ctx.stroke();

          // Draw current position dot
          const lastX = ((lfoHistory.length - 1) / historyLength) * width;
          const lastY = height - lfoHistory[lfoHistory.length - 1] * height;

          ctx.fillStyle = '#4ecdc4';
          ctx.beginPath();
          ctx.arc(lastX, lastY, 6, 0, Math.PI * 2);
          ctx.fill();

          // Glow effect
          ctx.shadowColor = '#4ecdc4';
          ctx.shadowBlur = 15;
          ctx.fill();
          ctx.shadowBlur = 0;
        }

        animationId = requestAnimationFrame(draw);
      }

      draw();
    }

    function stopVisualization() {
      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }
    }

    // Play controls
    async function playChord() {
      if (!audioStarted) return;
      synth.triggerAttackRelease(['D3', 'F3', 'A3', 'C4'], '2n');
      updateStatus('Playing Dm7 chord - listen for the LFO modulation!');
    }

    async function holdChord() {
      if (!audioStarted) return;
      if (!isHolding) {
        synth.triggerAttack(['D3', 'F3', 'A3', 'C4']);
        isHolding = true;
        document.getElementById('holdChord').classList.add('active');
        document.getElementById('stopChord').disabled = false;
        updateStatus('Holding chord - adjust LFO settings to hear changes in real-time');
      }
    }

    function stopChord() {
      if (isHolding) {
        synth.triggerRelease(['D3', 'F3', 'A3', 'C4']);
        isHolding = false;
        document.getElementById('holdChord').classList.remove('active');
        document.getElementById('stopChord').disabled = true;
        updateStatus('Stopped. Click "Hold Chord" to continue experimenting.');
      }
    }

    // Apply preset
    function applyPreset(presetName) {
      let preset;
      switch (presetName) {
        case 'subtleWobble':
          preset = { target: 'filter', shape: 'sine', rate: 0.3, depth: 30, min: 600, max: 1500 };
          updateStatus('Subtle Wobble: Very slow sine wave on filter for gentle breathing effect');
          break;
        case 'slowSweep':
          preset = { target: 'filter', shape: 'triangle', rate: 0.15, depth: 70, min: 400, max: 2500 };
          updateStatus('Slow Filter Sweep: Linear ramp through a wide frequency range');
          break;
        case 'tremolo':
          preset = { target: 'volume', shape: 'sine', rate: 4, depth: 40, min: 0, max: 100 };
          updateStatus('Tremolo: Classic amplitude modulation for pulsing effect');
          break;
        case 'autoPan':
          preset = { target: 'pan', shape: 'sine', rate: 0.2, depth: 80, min: 0, max: 100 };
          updateStatus('Auto-Pan: Slow stereo movement from left to right');
          break;
        default:
          return;
      }

      // Update UI
      currentTarget = preset.target;
      currentShape = preset.shape;
      currentRate = preset.rate;
      currentDepth = preset.depth / 100;
      currentMin = preset.min;
      currentMax = preset.max;

      // Update selectors
      document.querySelectorAll('#targetSelector .selector-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.target === preset.target);
      });
      document.querySelectorAll('#shapeSelector .selector-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.shape === preset.shape);
      });

      // Update sliders
      document.getElementById('lfoRate').value = preset.rate;
      document.getElementById('rateVal').textContent = preset.rate + ' Hz';
      document.getElementById('lfoDepth').value = preset.depth;
      document.getElementById('depthVal').textContent = preset.depth + '%';
      document.getElementById('lfoMin').value = preset.min;
      document.getElementById('lfoMax').value = preset.max;

      // Update audio
      if (lfo) {
        lfo.type = currentShape;
        lfo.frequency.value = currentRate;
        updateLFOTarget();
      }

      // Highlight active preset
      document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.preset === presetName);
      });
    }

    // Event Listeners
    document.getElementById('startAudio').addEventListener('click', initAudio);
    document.getElementById('playChord').addEventListener('click', playChord);
    document.getElementById('holdChord').addEventListener('click', holdChord);
    document.getElementById('stopChord').addEventListener('click', stopChord);

    // Target selector
    document.querySelectorAll('#targetSelector .selector-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#targetSelector .selector-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentTarget = btn.dataset.target;
        updateLFOTarget();
        // Clear preset highlight
        document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
      });
    });

    // Shape selector
    document.querySelectorAll('#shapeSelector .selector-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#shapeSelector .selector-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentShape = btn.dataset.shape;
        if (lfo) lfo.type = currentShape;
        lfoHistory = []; // Clear history for clean visual
        document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
      });
    });

    // Rate control
    document.getElementById('lfoRate').addEventListener('input', (e) => {
      currentRate = parseFloat(e.target.value);
      document.getElementById('rateVal').textContent = currentRate.toFixed(1) + ' Hz';
      if (lfo) lfo.frequency.value = currentRate;
      document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
    });

    // Depth control
    document.getElementById('lfoDepth').addEventListener('input', (e) => {
      currentDepth = parseInt(e.target.value) / 100;
      document.getElementById('depthVal').textContent = e.target.value + '%';
      updateLFOTarget();
      document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
    });

    // Min control
    document.getElementById('lfoMin').addEventListener('input', (e) => {
      currentMin = parseInt(e.target.value);
      document.getElementById('minVal').textContent = currentMin + ' Hz';
      if (lfo && currentTarget === 'filter') {
        lfo.min = currentMin;
      }
      document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
    });

    // Max control
    document.getElementById('lfoMax').addEventListener('input', (e) => {
      currentMax = parseInt(e.target.value);
      document.getElementById('maxVal').textContent = currentMax + ' Hz';
      if (lfo && currentTarget === 'filter') {
        lfo.max = currentMax;
      }
      document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
    });

    // Preset buttons
    document.querySelectorAll('.preset-btn').forEach(btn => {
      btn.addEventListener('click', () => applyPreset(btn.dataset.preset));
    });

    // Cleanup
    window.addEventListener('beforeunload', () => {
      stopVisualization();
      if (synth) {
        synth.releaseAll();
        synth.dispose();
      }
      if (lfo) lfo.dispose();
      if (filter) filter.dispose();
      if (panner) panner.dispose();
      if (gain) gain.dispose();
      if (reverb) reverb.dispose();
    });

    // Initialize display values
    updateMinMaxLabels('Hz', 100, 2000, 500, 4000);
  </script>
</body>
</html>
