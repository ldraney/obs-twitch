<!DOCTYPE html>
<html>
<head>
  <title>Builds and Drops - Demo</title>
  <script src="https://unpkg.com/tone@14"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #eee;
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .container { max-width: 900px; margin: 0 auto; }
    h1 { color: #e94560; margin-bottom: 10px; }
    h2 { color: #4ecdc4; margin-top: 30px; }
    h3 { color: #888; margin-bottom: 10px; }
    .subtitle { color: #888; margin-bottom: 30px; }

    .section {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }

    .control {
      background: rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 8px;
    }
    .control label {
      display: block;
      color: #888;
      font-size: 12px;
      margin-bottom: 5px;
    }
    .control .value {
      color: #e94560;
      font-weight: bold;
      float: right;
    }
    .control input[type="range"] {
      width: 100%;
      margin-top: 5px;
    }

    button {
      background: #e94560;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 8px;
      margin: 5px;
      transition: transform 0.1s, background 0.2s;
    }
    button:hover { background: #ff6b6b; transform: scale(1.02); }
    button:active { transform: scale(0.98); }
    button:disabled { background: #444; cursor: not-allowed; transform: none; }
    button.secondary {
      background: #4ecdc4;
    }
    button.secondary:hover { background: #6ee7df; }
    button.active {
      background: #4ecdc4;
      box-shadow: 0 0 15px rgba(78, 205, 196, 0.5);
    }

    .preset-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid #444;
      padding: 8px 16px;
      font-size: 14px;
    }
    .preset-btn:hover {
      background: rgba(255,255,255,0.15);
    }

    .info-box {
      background: rgba(78, 205, 196, 0.1);
      border-left: 4px solid #4ecdc4;
      padding: 15px;
      margin: 15px 0;
      border-radius: 0 8px 8px 0;
    }
    .info-box.tip {
      background: rgba(233, 69, 96, 0.1);
      border-left-color: #e94560;
    }

    #status {
      text-align: center;
      padding: 10px;
      color: #888;
      font-size: 14px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      margin: 10px 0;
    }

    /* Energy Meter */
    .energy-container {
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      padding: 20px;
      margin: 15px 0;
    }
    .energy-meter {
      height: 40px;
      background: rgba(0,0,0,0.5);
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }
    .energy-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #4ecdc4 0%, #e94560 50%, #ff6b6b 100%);
      border-radius: 8px;
      transition: width 0.1s ease-out;
    }
    .energy-label {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-weight: bold;
      color: white;
      text-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    .energy-markers {
      display: flex;
      justify-content: space-between;
      color: #666;
      font-size: 11px;
      margin-top: 5px;
    }

    /* Parameter Display */
    .param-display {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin: 15px 0;
    }
    .param-box {
      background: rgba(0,0,0,0.3);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    .param-box .label {
      color: #888;
      font-size: 12px;
      margin-bottom: 5px;
    }
    .param-box .value {
      font-size: 24px;
      font-weight: bold;
      color: #e94560;
    }
    .param-box .unit {
      color: #666;
      font-size: 12px;
    }

    /* Toggle Switches */
    .toggles {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin: 15px 0;
    }
    .toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(0,0,0,0.2);
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
    }
    .toggle input {
      display: none;
    }
    .toggle .switch {
      width: 40px;
      height: 22px;
      background: #444;
      border-radius: 11px;
      position: relative;
      transition: background 0.2s;
    }
    .toggle .switch::after {
      content: '';
      position: absolute;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: left 0.2s;
    }
    .toggle input:checked + .switch {
      background: #4ecdc4;
    }
    .toggle input:checked + .switch::after {
      left: 20px;
    }
    .toggle span {
      color: #888;
      font-size: 14px;
    }

    /* Main Action Buttons */
    .action-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    .action-buttons button {
      min-width: 150px;
      padding: 15px 30px;
      font-size: 18px;
    }
    .build-btn {
      background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
    }
    .build-btn:hover {
      background: linear-gradient(135deg, #6ee7df 0%, #5dc4a9 100%);
    }
    .drop-btn {
      background: linear-gradient(135deg, #e94560 0%, #c73b52 100%);
    }
    .drop-btn:hover {
      background: linear-gradient(135deg, #ff6b6b 0%, #e94560 100%);
    }
    .sequence-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .sequence-btn:hover {
      background: linear-gradient(135deg, #7b93ff 0%, #8b5fc7 100%);
    }

    /* Presets Grid */
    .presets-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      margin: 15px 0;
    }

    /* Phase Indicator */
    .phase-indicator {
      text-align: center;
      padding: 15px;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      margin: 15px 0;
    }
    .phase-indicator .phase {
      font-size: 24px;
      font-weight: bold;
      color: #4ecdc4;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    .phase-indicator .phase.building {
      color: #e94560;
      animation: pulse 0.5s ease-in-out infinite;
    }
    .phase-indicator .phase.dropping {
      color: #ff6b6b;
      animation: flash 0.2s ease-in-out;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    @keyframes flash {
      0% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }

    @media (max-width: 600px) {
      .param-display {
        grid-template-columns: 1fr;
      }
      .action-buttons {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Builds and Drops</h1>
    <p class="subtitle">Create tension and release with subtle lofi dynamics</p>

    <div id="status">Click "Start Audio" to begin</div>

    <div class="section">
      <h2>1. Interactive Build and Drop</h2>
      <p>Experience how builds create tension and drops provide release. Watch the energy meter rise during builds.</p>

      <div style="text-align: center; margin: 15px 0;">
        <button id="startAudio">Start Audio</button>
        <button id="stopAudio" disabled>Stop Audio</button>
      </div>

      <div class="phase-indicator">
        <div class="phase" id="phaseText">Ready</div>
      </div>

      <div class="energy-container">
        <h3>Energy Level</h3>
        <div class="energy-meter">
          <div class="energy-fill" id="energyFill"></div>
          <span class="energy-label" id="energyLabel">0%</span>
        </div>
        <div class="energy-markers">
          <span>Chill</span>
          <span>Building</span>
          <span>Peak</span>
        </div>
      </div>

      <div class="param-display">
        <div class="param-box">
          <div class="label">Filter Cutoff</div>
          <div class="value" id="filterValue">1200</div>
          <div class="unit">Hz</div>
        </div>
        <div class="param-box">
          <div class="label">Reverb</div>
          <div class="value" id="reverbValue">30</div>
          <div class="unit">%</div>
        </div>
        <div class="param-box">
          <div class="label">Volume</div>
          <div class="value" id="volumeValue">-12</div>
          <div class="unit">dB</div>
        </div>
      </div>

      <div class="action-buttons">
        <button class="build-btn" id="buildBtn">Build</button>
        <button class="drop-btn" id="dropBtn">Drop</button>
        <button class="sequence-btn" id="sequenceBtn">Build + Drop</button>
      </div>

      <div class="controls">
        <div class="control">
          <label>Build Duration <span class="value" id="buildDurVal">4 bars</span></label>
          <input type="range" id="buildDuration" min="2" max="8" step="1" value="4">
        </div>
        <div class="control">
          <label>Build Intensity <span class="value" id="buildIntensityVal">Medium</span></label>
          <input type="range" id="buildIntensity" min="1" max="3" step="1" value="2">
        </div>
      </div>

      <h3>Build Elements</h3>
      <div class="toggles">
        <label class="toggle">
          <input type="checkbox" id="toggleFilter" checked>
          <div class="switch"></div>
          <span>Filter Sweep</span>
        </label>
        <label class="toggle">
          <input type="checkbox" id="toggleReverb" checked>
          <div class="switch"></div>
          <span>Reverb Rise</span>
        </label>
        <label class="toggle">
          <input type="checkbox" id="toggleNoise">
          <div class="switch"></div>
          <span>Rising Noise</span>
        </label>
        <label class="toggle">
          <input type="checkbox" id="toggleRoll">
          <div class="switch"></div>
          <span>Drum Roll</span>
        </label>
      </div>

      <div class="info-box">
        <strong>What you're hearing:</strong> The build gradually increases filter brightness,
        reverb, and optional elements. The drop instantly resets to a warm, intimate sound.
        In lofi, these changes are subtle - notice how the build never gets too intense.
      </div>
    </div>

    <div class="section">
      <h2>2. Presets</h2>
      <p>Quick build-drop patterns for different vibes.</p>

      <div class="presets-grid">
        <button class="preset-btn" data-preset="subtle">Subtle Lofi Build</button>
        <button class="preset-btn" data-preset="filter">Filter Sweep Only</button>
        <button class="preset-btn" data-preset="tension">Tension + Release</button>
        <button class="preset-btn" data-preset="gentle">Gentle Rise</button>
        <button class="preset-btn" data-preset="dramatic">Dramatic Build</button>
        <button class="preset-btn" data-preset="quick">Quick Build</button>
      </div>

      <div class="info-box tip">
        <strong>Tip:</strong> Start with "Subtle Lofi Build" - it demonstrates the restrained
        energy that defines lofi music. Compare it to "Dramatic Build" to hear the difference
        between lofi and more intense electronic styles.
      </div>
    </div>

    <div class="section">
      <h2>3. EDM vs Lofi Comparison</h2>
      <p>Hear the difference between aggressive EDM builds and gentle lofi builds.</p>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 8px; text-align: center;">
          <h3 style="color: #e94560;">EDM Style</h3>
          <p style="color: #888; font-size: 12px;">Wide filter range, loud, intense</p>
          <button id="edmBuild">Play EDM Build</button>
        </div>
        <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 8px; text-align: center;">
          <h3 style="color: #4ecdc4;">Lofi Style</h3>
          <p style="color: #888; font-size: 12px;">Subtle, warm, chill</p>
          <button id="lofiBuild" class="secondary">Play Lofi Build</button>
        </div>
      </div>

      <div class="info-box">
        <strong>Key differences:</strong><br>
        <strong>EDM:</strong> Filter 200-16000 Hz, volume +6dB, 80% reverb<br>
        <strong>Lofi:</strong> Filter 800-3500 Hz, volume +3dB, 50% reverb<br>
        The lofi build maintains a relaxed vibe while still creating movement.
      </div>
    </div>

    <div class="section">
      <h2>4. Manual Control</h2>
      <p>Build your own tension with direct parameter control.</p>

      <div class="controls">
        <div class="control">
          <label>Filter Cutoff <span class="value" id="manualFilterVal">1200 Hz</span></label>
          <input type="range" id="manualFilter" min="200" max="6000" step="50" value="1200">
        </div>
        <div class="control">
          <label>Reverb Wet <span class="value" id="manualReverbVal">30%</span></label>
          <input type="range" id="manualReverb" min="10" max="90" step="5" value="30">
        </div>
        <div class="control">
          <label>Volume <span class="value" id="manualVolumeVal">-12 dB</span></label>
          <input type="range" id="manualVolume" min="-20" max="-4" step="1" value="-12">
        </div>
      </div>

      <div style="text-align: center;">
        <button id="resetManual" class="secondary">Reset to Default</button>
      </div>
    </div>
  </div>

  <script>
    // Global state
    let audioStarted = false;
    let isPlaying = false;
    let buildInProgress = false;
    let currentEnergy = 0;
    let animationId = null;

    // Audio nodes
    let synth = null;
    let filter = null;
    let reverb = null;
    let noise = null;
    let noiseFilter = null;
    let snare = null;

    // Default values
    const defaults = {
      filter: 1200,
      reverb: 0.3,
      volume: -12
    };

    // Intensity presets
    const intensitySettings = {
      1: { filterMax: 2500, volumeBoost: 2, reverbMax: 0.45 },
      2: { filterMax: 3500, volumeBoost: 4, reverbMax: 0.55 },
      3: { filterMax: 5000, volumeBoost: 6, reverbMax: 0.70 }
    };

    // Initialize audio
    async function initAudio() {
      await Tone.start();

      filter = new Tone.Filter({
        frequency: defaults.filter,
        type: 'lowpass',
        rolloff: -12,
        Q: 1.5
      }).toDestination();

      reverb = new Tone.Reverb(2.5);
      await reverb.generate();
      reverb.wet.value = defaults.reverb;
      filter.connect(reverb);
      reverb.connect(Tone.Destination);

      synth = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: 'triangle' },
        envelope: { attack: 0.15, decay: 0.3, sustain: 0.5, release: 1.2 }
      });
      synth.volume.value = defaults.volume;
      synth.connect(filter);

      // Noise for rising effect
      noiseFilter = new Tone.Filter(200, 'highpass').toDestination();
      noise = new Tone.Noise('white');
      noise.volume.value = -30;
      noise.connect(noiseFilter);

      // Snare for drum roll
      snare = new Tone.NoiseSynth({
        noise: { type: 'white' },
        envelope: { attack: 0.001, decay: 0.15, sustain: 0, release: 0.1 }
      }).toDestination();
      snare.volume.value = -15;

      audioStarted = true;
      updateStatus('Audio ready! Try the Build and Drop buttons.');
    }

    function updateStatus(msg) {
      document.getElementById('status').textContent = msg;
    }

    function updatePhase(phase) {
      const el = document.getElementById('phaseText');
      el.textContent = phase;
      el.className = 'phase';
      if (phase === 'Building...') el.classList.add('building');
      if (phase === 'DROP!') el.classList.add('dropping');
    }

    function updateEnergy(value) {
      currentEnergy = Math.max(0, Math.min(100, value));
      document.getElementById('energyFill').style.width = currentEnergy + '%';
      document.getElementById('energyLabel').textContent = Math.round(currentEnergy) + '%';
    }

    function updateParamDisplay() {
      if (!filter) return;

      document.getElementById('filterValue').textContent = Math.round(filter.frequency.value);
      document.getElementById('reverbValue').textContent = Math.round(reverb.wet.value * 100);
      document.getElementById('volumeValue').textContent = synth.volume.value.toFixed(1);

      // Calculate energy based on current params
      const filterEnergy = (filter.frequency.value - 600) / (5000 - 600) * 40;
      const reverbEnergy = (reverb.wet.value - 0.2) / (0.8 - 0.2) * 30;
      const volumeEnergy = (synth.volume.value - (-15)) / ((-6) - (-15)) * 30;
      updateEnergy(filterEnergy + reverbEnergy + volumeEnergy);

      // Update manual sliders
      document.getElementById('manualFilter').value = filter.frequency.value;
      document.getElementById('manualFilterVal').textContent = Math.round(filter.frequency.value) + ' Hz';
      document.getElementById('manualReverb').value = reverb.wet.value * 100;
      document.getElementById('manualReverbVal').textContent = Math.round(reverb.wet.value * 100) + '%';
      document.getElementById('manualVolume').value = synth.volume.value;
      document.getElementById('manualVolumeVal').textContent = synth.volume.value.toFixed(1) + ' dB';
    }

    function startParamUpdate() {
      function update() {
        if (!isPlaying) return;
        updateParamDisplay();
        animationId = requestAnimationFrame(update);
      }
      update();
    }

    function stopParamUpdate() {
      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }
    }

    // Start/stop audio
    document.getElementById('startAudio').addEventListener('click', async () => {
      if (!audioStarted) {
        await initAudio();
      }
      startPlaying();
      document.getElementById('startAudio').disabled = true;
      document.getElementById('stopAudio').disabled = false;
    });

    document.getElementById('stopAudio').addEventListener('click', () => {
      stopPlaying();
      document.getElementById('startAudio').disabled = false;
      document.getElementById('stopAudio').disabled = true;
    });

    function startPlaying() {
      if (isPlaying) return;
      isPlaying = true;

      // Play lofi chord progression
      synth.triggerAttack(['D3', 'F3', 'A3', 'C4']);
      startParamUpdate();
      updatePhase('Playing');
    }

    function stopPlaying() {
      if (!isPlaying) return;
      isPlaying = false;

      synth.releaseAll();
      noise.stop();
      stopParamUpdate();
      updatePhase('Ready');
      updateEnergy(0);

      // Reset params
      if (filter) {
        filter.frequency.cancelScheduledValues(Tone.now());
        filter.frequency.value = defaults.filter;
        reverb.wet.cancelScheduledValues(Tone.now());
        reverb.wet.value = defaults.reverb;
        synth.volume.cancelScheduledValues(Tone.now());
        synth.volume.value = defaults.volume;
      }
    }

    // Build function
    function triggerBuild(durationBars = 4, intensity = 2, options = {}) {
      if (!audioStarted || buildInProgress) return;

      buildInProgress = true;
      updatePhase('Building...');

      const bpm = 75;
      const duration = (durationBars * 4) / (bpm / 60);
      const settings = intensitySettings[intensity];

      const useFilter = options.filter !== false;
      const useReverb = options.reverb !== false;
      const useNoise = options.noise === true;
      const useRoll = options.roll === true;

      const now = Tone.now();

      // Filter sweep
      if (useFilter) {
        filter.frequency.cancelScheduledValues(now);
        filter.frequency.setValueAtTime(800, now);
        filter.frequency.exponentialRampTo(settings.filterMax, duration, now);
      }

      // Reverb rise
      if (useReverb) {
        reverb.wet.cancelScheduledValues(now);
        reverb.wet.setValueAtTime(0.2, now);
        reverb.wet.linearRampTo(settings.reverbMax, duration, now);
      }

      // Volume swell
      synth.volume.cancelScheduledValues(now);
      synth.volume.setValueAtTime(-15, now);
      synth.volume.linearRampTo(-15 + settings.volumeBoost, duration, now);

      // Rising noise
      if (useNoise) {
        noiseFilter.frequency.setValueAtTime(200, now);
        noiseFilter.frequency.exponentialRampTo(6000, duration, now);
        noise.volume.setValueAtTime(-35, now);
        noise.volume.linearRampTo(-20, duration, now);
        noise.start(now);
        noise.stop(now + duration);
      }

      // Drum roll
      if (useRoll) {
        const numHits = Math.floor(duration * 4);
        for (let i = 0; i < numHits; i++) {
          const t = (i / numHits) * duration;
          const velocity = 0.2 + (i / numHits) * 0.5;
          snare.triggerAttackRelease('16n', now + t, velocity);
        }
      }

      // Track build progress
      setTimeout(() => {
        buildInProgress = false;
        updatePhase('Peak');
      }, duration * 1000);

      updateStatus(`Building over ${durationBars} bars (${duration.toFixed(1)}s)`);
    }

    // Drop function
    function triggerDrop() {
      if (!audioStarted) return;

      buildInProgress = false;
      updatePhase('DROP!');

      const now = Tone.now();

      // Cancel all automation
      filter.frequency.cancelScheduledValues(now);
      reverb.wet.cancelScheduledValues(now);
      synth.volume.cancelScheduledValues(now);
      noise.stop();

      // Instant reset to warm sound
      filter.frequency.setValueAtTime(1000, now);
      reverb.wet.setValueAtTime(0.35, now);
      synth.volume.setValueAtTime(-10, now);

      // Quick recovery to normal
      filter.frequency.rampTo(1200, 1);
      reverb.wet.rampTo(0.3, 1);
      synth.volume.rampTo(-12, 0.5);

      setTimeout(() => {
        updatePhase('Playing');
      }, 500);

      updateStatus('DROP! Parameters reset to warm, intimate sound');
    }

    // Build button
    document.getElementById('buildBtn').addEventListener('click', async () => {
      if (!audioStarted) await initAudio();
      if (!isPlaying) {
        startPlaying();
        document.getElementById('startAudio').disabled = true;
        document.getElementById('stopAudio').disabled = false;
      }

      const duration = parseInt(document.getElementById('buildDuration').value);
      const intensity = parseInt(document.getElementById('buildIntensity').value);

      triggerBuild(duration, intensity, {
        filter: document.getElementById('toggleFilter').checked,
        reverb: document.getElementById('toggleReverb').checked,
        noise: document.getElementById('toggleNoise').checked,
        roll: document.getElementById('toggleRoll').checked
      });
    });

    // Drop button
    document.getElementById('dropBtn').addEventListener('click', async () => {
      if (!audioStarted) await initAudio();
      if (!isPlaying) {
        startPlaying();
        document.getElementById('startAudio').disabled = true;
        document.getElementById('stopAudio').disabled = false;
      }
      triggerDrop();
    });

    // Build + Drop sequence
    document.getElementById('sequenceBtn').addEventListener('click', async () => {
      if (!audioStarted) await initAudio();
      if (!isPlaying) {
        startPlaying();
        document.getElementById('startAudio').disabled = true;
        document.getElementById('stopAudio').disabled = false;
      }

      const duration = parseInt(document.getElementById('buildDuration').value);
      const intensity = parseInt(document.getElementById('buildIntensity').value);

      triggerBuild(duration, intensity, {
        filter: document.getElementById('toggleFilter').checked,
        reverb: document.getElementById('toggleReverb').checked,
        noise: document.getElementById('toggleNoise').checked,
        roll: document.getElementById('toggleRoll').checked
      });

      // Schedule drop
      const bpm = 75;
      const buildTime = (duration * 4) / (bpm / 60) * 1000;
      setTimeout(() => {
        triggerDrop();
      }, buildTime);
    });

    // Duration slider
    document.getElementById('buildDuration').addEventListener('input', (e) => {
      document.getElementById('buildDurVal').textContent = e.target.value + ' bars';
    });

    // Intensity slider
    document.getElementById('buildIntensity').addEventListener('input', (e) => {
      const labels = { 1: 'Subtle', 2: 'Medium', 3: 'Intense' };
      document.getElementById('buildIntensityVal').textContent = labels[e.target.value];
    });

    // Presets
    const presets = {
      subtle: { duration: 4, intensity: 1, filter: true, reverb: true, noise: false, roll: false },
      filter: { duration: 4, intensity: 2, filter: true, reverb: false, noise: false, roll: false },
      tension: { duration: 6, intensity: 2, filter: true, reverb: true, noise: true, roll: false },
      gentle: { duration: 8, intensity: 1, filter: true, reverb: true, noise: false, roll: false },
      dramatic: { duration: 4, intensity: 3, filter: true, reverb: true, noise: true, roll: true },
      quick: { duration: 2, intensity: 2, filter: true, reverb: false, noise: false, roll: true }
    };

    document.querySelectorAll('.preset-btn[data-preset]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const preset = presets[btn.dataset.preset];
        if (!preset) return;

        if (!audioStarted) await initAudio();
        if (!isPlaying) {
          startPlaying();
          document.getElementById('startAudio').disabled = true;
          document.getElementById('stopAudio').disabled = false;
        }

        // Update UI
        document.getElementById('buildDuration').value = preset.duration;
        document.getElementById('buildDurVal').textContent = preset.duration + ' bars';
        document.getElementById('buildIntensity').value = preset.intensity;
        const labels = { 1: 'Subtle', 2: 'Medium', 3: 'Intense' };
        document.getElementById('buildIntensityVal').textContent = labels[preset.intensity];

        document.getElementById('toggleFilter').checked = preset.filter;
        document.getElementById('toggleReverb').checked = preset.reverb;
        document.getElementById('toggleNoise').checked = preset.noise;
        document.getElementById('toggleRoll').checked = preset.roll;

        // Trigger build + drop
        triggerBuild(preset.duration, preset.intensity, preset);

        const bpm = 75;
        const buildTime = (preset.duration * 4) / (bpm / 60) * 1000;
        setTimeout(() => {
          triggerDrop();
        }, buildTime);

        updateStatus(`Preset: ${btn.textContent}`);
      });
    });

    // EDM vs Lofi comparison
    document.getElementById('edmBuild').addEventListener('click', async () => {
      if (!audioStarted) await initAudio();
      if (!isPlaying) {
        startPlaying();
        document.getElementById('startAudio').disabled = true;
        document.getElementById('stopAudio').disabled = false;
      }

      const now = Tone.now();
      const duration = 4;

      // EDM-style aggressive build
      filter.frequency.cancelScheduledValues(now);
      filter.frequency.setValueAtTime(200, now);
      filter.frequency.exponentialRampTo(12000, duration, now);

      reverb.wet.cancelScheduledValues(now);
      reverb.wet.setValueAtTime(0.1, now);
      reverb.wet.linearRampTo(0.85, duration, now);

      synth.volume.cancelScheduledValues(now);
      synth.volume.setValueAtTime(-18, now);
      synth.volume.linearRampTo(-6, duration, now);

      // Rising noise
      noiseFilter.frequency.setValueAtTime(100, now);
      noiseFilter.frequency.exponentialRampTo(12000, duration, now);
      noise.volume.setValueAtTime(-25, now);
      noise.volume.linearRampTo(-10, duration, now);
      noise.start(now);
      noise.stop(now + duration);

      // Intense drum roll
      const numHits = 32;
      for (let i = 0; i < numHits; i++) {
        const t = (i / numHits) * duration;
        const velocity = 0.3 + (i / numHits) * 0.7;
        snare.triggerAttackRelease('16n', now + t, velocity);
      }

      updatePhase('EDM Building!');
      updateStatus('EDM-style build: Wide filter range, loud, intense');

      setTimeout(() => {
        triggerDrop();
      }, duration * 1000);
    });

    document.getElementById('lofiBuild').addEventListener('click', async () => {
      if (!audioStarted) await initAudio();
      if (!isPlaying) {
        startPlaying();
        document.getElementById('startAudio').disabled = true;
        document.getElementById('stopAudio').disabled = false;
      }

      const now = Tone.now();
      const duration = 4;

      // Lofi-style subtle build
      filter.frequency.cancelScheduledValues(now);
      filter.frequency.setValueAtTime(800, now);
      filter.frequency.exponentialRampTo(3000, duration, now);

      reverb.wet.cancelScheduledValues(now);
      reverb.wet.setValueAtTime(0.25, now);
      reverb.wet.linearRampTo(0.5, duration, now);

      synth.volume.cancelScheduledValues(now);
      synth.volume.setValueAtTime(-14, now);
      synth.volume.linearRampTo(-10, duration, now);

      updatePhase('Lofi Building...');
      updateStatus('Lofi-style build: Subtle, warm, chill');

      setTimeout(() => {
        triggerDrop();
      }, duration * 1000);
    });

    // Manual controls
    document.getElementById('manualFilter').addEventListener('input', (e) => {
      if (!filter) return;
      const val = parseInt(e.target.value);
      filter.frequency.value = val;
      document.getElementById('manualFilterVal').textContent = val + ' Hz';
    });

    document.getElementById('manualReverb').addEventListener('input', (e) => {
      if (!reverb) return;
      const val = parseInt(e.target.value) / 100;
      reverb.wet.value = val;
      document.getElementById('manualReverbVal').textContent = Math.round(val * 100) + '%';
    });

    document.getElementById('manualVolume').addEventListener('input', (e) => {
      if (!synth) return;
      const val = parseFloat(e.target.value);
      synth.volume.value = val;
      document.getElementById('manualVolumeVal').textContent = val.toFixed(1) + ' dB';
    });

    document.getElementById('resetManual').addEventListener('click', () => {
      if (!filter) return;

      filter.frequency.cancelScheduledValues(Tone.now());
      filter.frequency.value = defaults.filter;
      reverb.wet.cancelScheduledValues(Tone.now());
      reverb.wet.value = defaults.reverb;
      synth.volume.cancelScheduledValues(Tone.now());
      synth.volume.value = defaults.volume;

      document.getElementById('manualFilter').value = defaults.filter;
      document.getElementById('manualFilterVal').textContent = defaults.filter + ' Hz';
      document.getElementById('manualReverb').value = defaults.reverb * 100;
      document.getElementById('manualReverbVal').textContent = Math.round(defaults.reverb * 100) + '%';
      document.getElementById('manualVolume').value = defaults.volume;
      document.getElementById('manualVolumeVal').textContent = defaults.volume + ' dB';

      updateStatus('Parameters reset to defaults');
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      stopPlaying();
    });
  </script>
</body>
</html>
