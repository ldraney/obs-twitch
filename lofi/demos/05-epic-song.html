<!DOCTYPE html>
<html>
<head>
  <title>Epic Song - Final Project Demo</title>
  <script src="https://unpkg.com/tone@14"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #eee;
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .container { max-width: 1100px; margin: 0 auto; }

    /* Header with achievement styling */
    .header {
      text-align: center;
      margin-bottom: 30px;
      position: relative;
    }
    .header::before {
      content: '';
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      width: 200px;
      height: 4px;
      background: linear-gradient(90deg, transparent, #e94560, #4ecdc4, transparent);
    }
    h1 {
      color: #e94560;
      margin-bottom: 5px;
      font-size: 36px;
      text-shadow: 0 0 30px rgba(233, 69, 96, 0.3);
    }
    .subtitle {
      color: #888;
      font-size: 16px;
      margin-bottom: 20px;
    }
    .badge {
      display: inline-block;
      background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
      color: #1a1a2e;
      padding: 8px 20px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    #status {
      text-align: center;
      padding: 12px;
      color: #888;
      font-size: 14px;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      margin: 15px 0;
    }

    .section {
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      padding: 25px;
      margin: 20px 0;
      border: 1px solid rgba(255,255,255,0.05);
    }

    h2 { color: #4ecdc4; margin-top: 0; }
    h3 { color: #888; margin-bottom: 10px; }

    /* Main Transport Controls */
    .main-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
      margin: 25px 0;
    }

    button {
      background: #e94560;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 8px;
      margin: 5px;
      transition: transform 0.1s, background 0.2s, box-shadow 0.2s;
    }
    button:hover { background: #ff6b6b; transform: scale(1.02); }
    button:active { transform: scale(0.98); }
    button:disabled { background: #444; cursor: not-allowed; transform: none; }
    button.secondary { background: #4ecdc4; color: #1a1a2e; }
    button.secondary:hover { background: #6ee7df; }

    .play-btn {
      font-size: 20px;
      padding: 18px 45px;
      background: linear-gradient(135deg, #e94560 0%, #ff6b6b 100%);
      box-shadow: 0 4px 20px rgba(233, 69, 96, 0.3);
      border-radius: 12px;
    }
    .play-btn:hover {
      background: linear-gradient(135deg, #ff6b6b 0%, #ff8888 100%);
      box-shadow: 0 6px 30px rgba(233, 69, 96, 0.5);
    }
    .play-btn:disabled {
      background: #444;
      box-shadow: none;
    }

    /* Timeline */
    .timeline-container {
      background: rgba(0,0,0,0.4);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }
    .timeline {
      display: flex;
      height: 70px;
      border-radius: 10px;
      overflow: hidden;
      position: relative;
      box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
    }
    .timeline-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      border-right: 1px solid rgba(0,0,0,0.3);
    }
    .timeline-section:last-child { border-right: none; }
    .timeline-section:hover { filter: brightness(1.15); }
    .timeline-section.active {
      filter: brightness(1.3);
      box-shadow: inset 0 0 30px rgba(255,255,255,0.15);
    }
    .timeline-section.intro { background: linear-gradient(180deg, #3a506b 0%, #2c3e50 100%); }
    .timeline-section.verseA { background: linear-gradient(180deg, #5c7a99 0%, #4a6278 100%); }
    .timeline-section.verseB { background: linear-gradient(180deg, #667eea 0%, #5563c0 100%); }
    .timeline-section.breakdown { background: linear-gradient(180deg, #2c3e50 0%, #1a252f 100%); }
    .timeline-section.climax { background: linear-gradient(180deg, #e94560 0%, #c73b52 100%); }
    .timeline-section.outro { background: linear-gradient(180deg, #3a506b 0%, #2c3e50 100%); }

    .section-name { font-size: 13px; margin-bottom: 4px; }
    .section-bars { font-size: 10px; opacity: 0.7; }

    .playhead {
      position: absolute;
      width: 4px;
      height: 100%;
      background: #fff;
      box-shadow: 0 0 15px #fff, 0 0 30px rgba(255,255,255,0.5);
      top: 0;
      left: 0;
      pointer-events: none;
      transition: left 0.1s linear;
      z-index: 10;
      border-radius: 2px;
    }

    /* Progress Bar */
    .progress-container {
      margin: 15px 0;
    }
    .progress-bar {
      height: 8px;
      background: rgba(0,0,0,0.4);
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #4ecdc4, #e94560, #ff6b6b);
      border-radius: 4px;
      transition: width 0.1s linear;
    }
    .progress-info {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 12px;
      color: #666;
    }

    /* Current Section Display */
    .current-section-display {
      text-align: center;
      padding: 25px;
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
      margin: 20px 0;
    }
    .current-section-name {
      font-size: 56px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 6px;
      color: #e94560;
      text-shadow: 0 0 40px rgba(233, 69, 96, 0.4);
      transition: color 0.3s;
    }
    .current-bar {
      font-size: 16px;
      color: #666;
      margin-top: 8px;
    }

    /* Section Jump Buttons */
    .section-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      margin: 20px 0;
    }
    .section-btn {
      background: rgba(255,255,255,0.08);
      border: 2px solid #444;
      padding: 12px 20px;
      color: #888;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 1px;
      min-width: 120px;
    }
    .section-btn:hover { border-color: #666; background: rgba(255,255,255,0.12); }
    .section-btn.intro:hover, .section-btn.intro.active { border-color: #3a506b; background: #3a506b; color: #fff; }
    .section-btn.verseA:hover, .section-btn.verseA.active { border-color: #5c7a99; background: #5c7a99; color: #fff; }
    .section-btn.verseB:hover, .section-btn.verseB.active { border-color: #667eea; background: #667eea; color: #fff; }
    .section-btn.breakdown:hover, .section-btn.breakdown.active { border-color: #2c3e50; background: #2c3e50; color: #fff; }
    .section-btn.climax:hover, .section-btn.climax.active { border-color: #e94560; background: #e94560; color: #fff; }
    .section-btn.outro:hover, .section-btn.outro.active { border-color: #3a506b; background: #3a506b; color: #fff; }

    /* Element Status Grid */
    .elements-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
      margin: 20px 0;
    }
    .element-card {
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
      padding: 18px;
      text-align: center;
      border: 2px solid transparent;
      transition: all 0.3s;
    }
    .element-card.active {
      border-color: #4ecdc4;
      background: rgba(78, 205, 196, 0.1);
      box-shadow: 0 0 20px rgba(78, 205, 196, 0.2);
    }
    .element-icon {
      font-size: 28px;
      margin-bottom: 8px;
      transition: transform 0.2s;
      color: #444;
    }
    .element-card.active .element-icon {
      color: #4ecdc4;
      transform: scale(1.1);
    }
    .element-name {
      font-size: 12px;
      font-weight: bold;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .element-card.active .element-name { color: #4ecdc4; }
    .element-status {
      font-size: 10px;
      margin-top: 5px;
      color: #444;
    }
    .element-card.active .element-status { color: #4ecdc4; }

    /* Volume Control */
    .volume-control {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      background: rgba(0,0,0,0.2);
      padding: 15px 25px;
      border-radius: 10px;
      margin: 15px 0;
    }
    .volume-control label { color: #888; font-size: 14px; }
    .volume-control input[type="range"] {
      width: 200px;
      accent-color: #e94560;
    }
    .volume-value {
      color: #e94560;
      font-weight: bold;
      min-width: 50px;
    }

    /* Transport Info */
    .transport-info {
      display: flex;
      justify-content: center;
      gap: 25px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    .transport-display {
      background: rgba(0,0,0,0.3);
      padding: 12px 25px;
      border-radius: 8px;
      text-align: center;
    }
    .transport-value {
      font-size: 24px;
      font-weight: bold;
      color: #e94560;
    }
    .transport-label {
      font-size: 10px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Info Box */
    .info-box {
      background: rgba(78, 205, 196, 0.1);
      border-left: 4px solid #4ecdc4;
      padding: 15px;
      margin: 15px 0;
      border-radius: 0 8px 8px 0;
      font-size: 14px;
    }
    .info-box.achievement {
      background: linear-gradient(135deg, rgba(233, 69, 96, 0.1) 0%, rgba(78, 205, 196, 0.1) 100%);
      border-left-color: #e94560;
      border: 2px solid rgba(233, 69, 96, 0.3);
      border-radius: 8px;
      text-align: center;
      padding: 20px;
    }
    .info-box.achievement strong {
      color: #e94560;
      font-size: 16px;
    }

    /* Code Export Section */
    .code-section {
      background: rgba(0,0,0,0.4);
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }
    .code-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .code-header h3 { margin: 0; color: #888; }
    pre {
      background: rgba(0,0,0,0.5);
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 12px;
      color: #aaa;
      max-height: 300px;
      margin: 0;
    }
    code { color: #4ecdc4; }

    /* Legend */
    .legend {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
      margin: 15px 0;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #888;
    }
    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
    }
    .legend-color.intro { background: #3a506b; }
    .legend-color.verseA { background: #5c7a99; }
    .legend-color.verseB { background: #667eea; }
    .legend-color.breakdown { background: #2c3e50; }
    .legend-color.climax { background: #e94560; }
    .legend-color.outro { background: #3a506b; }

    /* Celebration overlay */
    .celebration {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    .celebration.active { display: flex; }
    .celebration h2 {
      font-size: 48px;
      color: #4ecdc4;
      text-shadow: 0 0 40px #4ecdc4;
      animation: pulse 1s ease-in-out infinite;
    }
    .celebration p { color: #888; font-size: 18px; margin: 20px 0; }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.02); }
    }

    @media (max-width: 800px) {
      .elements-grid { grid-template-columns: repeat(3, 1fr); }
      .timeline-section { font-size: 9px; }
      .current-section-name { font-size: 36px; }
    }

    @media (max-width: 500px) {
      .elements-grid { grid-template-columns: repeat(2, 1fr); }
      .section-buttons { flex-direction: column; align-items: center; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>The Epic Song</h1>
      <p class="subtitle">Project 5: Your Complete Lofi Track - The Final Boss</p>
      <div class="badge">Course Completion Project</div>
    </div>

    <div id="status">Click "Start Audio" to initialize the audio engine</div>

    <div class="section">
      <div class="main-controls">
        <button id="startBtn">Start Audio</button>
        <button id="playBtn" class="play-btn" disabled>Play Full Song</button>
        <button id="stopBtn" class="secondary" disabled>Stop</button>
      </div>

      <div class="volume-control">
        <label>Master Volume</label>
        <input type="range" id="volumeSlider" min="-30" max="0" value="-6">
        <span class="volume-value" id="volumeValue">-6 dB</span>
      </div>

      <div class="transport-info">
        <div class="transport-display">
          <div class="transport-value" id="bpmDisplay">80</div>
          <div class="transport-label">BPM</div>
        </div>
        <div class="transport-display">
          <div class="transport-value" id="positionDisplay">0:0:0</div>
          <div class="transport-label">Position</div>
        </div>
        <div class="transport-display">
          <div class="transport-value" id="timeDisplay">0:00</div>
          <div class="transport-label">Time</div>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>Song Timeline</h2>
      <p>Click any section to jump there. Watch the playhead move through your complete track.</p>

      <div class="legend">
        <div class="legend-item"><div class="legend-color intro"></div> Intro (8)</div>
        <div class="legend-item"><div class="legend-color verseA"></div> Verse A (16)</div>
        <div class="legend-item"><div class="legend-color verseB"></div> Verse B (16)</div>
        <div class="legend-item"><div class="legend-color breakdown"></div> Breakdown (8)</div>
        <div class="legend-item"><div class="legend-color climax"></div> Climax (16)</div>
        <div class="legend-item"><div class="legend-color outro"></div> Outro (8)</div>
      </div>

      <div class="timeline-container">
        <div class="timeline" id="timeline">
          <div class="playhead" id="playhead"></div>
        </div>
      </div>

      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-info">
          <span id="currentTime">0:00</span>
          <span id="totalTime">~2:15</span>
        </div>
      </div>

      <div class="current-section-display">
        <div class="current-section-name" id="currentSectionName">READY</div>
        <div class="current-bar">Bar <span id="currentBar">0</span> / <span id="totalBars">72</span></div>
      </div>
    </div>

    <div class="section">
      <h2>Jump to Section</h2>
      <p>Skip directly to any part of your song.</p>

      <div class="section-buttons">
        <button class="section-btn intro" data-section="intro">Intro</button>
        <button class="section-btn verseA" data-section="verseA">Verse A</button>
        <button class="section-btn verseB" data-section="verseB">Verse B</button>
        <button class="section-btn breakdown" data-section="breakdown">Breakdown</button>
        <button class="section-btn climax" data-section="climax">Climax</button>
        <button class="section-btn outro" data-section="outro">Outro</button>
      </div>
    </div>

    <div class="section">
      <h2>Active Elements</h2>
      <p>See which instruments are playing in the current section.</p>

      <div class="elements-grid">
        <div class="element-card" id="drumsCard">
          <div class="element-icon">&#x1F941;</div>
          <div class="element-name">Drums</div>
          <div class="element-status">OFF</div>
        </div>
        <div class="element-card" id="bassCard">
          <div class="element-icon">&#x1F3B8;</div>
          <div class="element-name">Bass</div>
          <div class="element-status">OFF</div>
        </div>
        <div class="element-card" id="chordsCard">
          <div class="element-icon">&#x1F3B9;</div>
          <div class="element-name">Chords</div>
          <div class="element-status">OFF</div>
        </div>
        <div class="element-card" id="melodyCard">
          <div class="element-icon">&#x1F3B5;</div>
          <div class="element-name">Melody</div>
          <div class="element-status">OFF</div>
        </div>
        <div class="element-card active" id="vinylCard">
          <div class="element-icon">&#x1F4BF;</div>
          <div class="element-name">Vinyl</div>
          <div class="element-status">ALWAYS ON</div>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>Export Your Song</h2>
      <p>View the complete code structure for this track.</p>

      <div class="code-section">
        <div class="code-header">
          <h3>Song Structure Code</h3>
          <button id="copyBtn" class="secondary" style="padding: 8px 16px; font-size: 12px;">Copy Code</button>
        </div>
        <pre><code id="codeDisplay">// Structure: 72 bars total at 80 BPM (~2:15)
const structure = [
  { name: 'intro', startBar: 0, bars: 8 },
  { name: 'verseA', startBar: 8, bars: 16 },
  { name: 'verseB', startBar: 24, bars: 16 },
  { name: 'breakdown', startBar: 40, bars: 8 },
  { name: 'climax', startBar: 48, bars: 16 },
  { name: 'outro', startBar: 64, bars: 8 }
];

// Schedule each section
structure.forEach(section => {
  Tone.Transport.schedule((time) => {
    applySection(section.name, time);
  }, `${section.startBar}:0:0`);
});

// Section configurations
const sections = {
  intro: { drums: false, bass: false, chords: true, melody: false, filterFreq: 600 },
  verseA: { drums: true, bass: true, chords: true, melody: false, filterFreq: 1400 },
  verseB: { drums: true, bass: true, chords: true, melody: true, filterFreq: 1800 },
  breakdown: { drums: false, bass: false, chords: true, melody: false, filterFreq: 400 },
  climax: { drums: true, bass: true, chords: true, melody: true, filterFreq: 2800 },
  outro: { drums: false, bass: false, chords: true, melody: false, filterFreq: 500 }
};</code></pre>
      </div>

      <div class="info-box achievement">
        <strong>Congratulations!</strong><br>
        You have completed the Lofi Music Production course.<br>
        This track demonstrates mastery of all core concepts.
      </div>
    </div>
  </div>

  <div class="celebration" id="celebration">
    <h2>Song Complete!</h2>
    <p>You just played your first complete lofi track.</p>
    <button id="closeBtn" class="secondary">Continue</button>
  </div>

  <script>
    // =====================
    // GLOBAL STATE
    // =====================
    let isInitialized = false;
    let isPlaying = false;
    let currentSectionIndex = 0;

    // Audio nodes
    let masterFilter, reverb, delay;
    let kick, snare, hihat, chords, bass, melody;
    let vinyl, vinylFilter;
    let drumLoop, chordLoop, bassLoop, melodyLoop;

    // Song structure
    const songStructure = [
      { name: 'intro', startBar: 0, bars: 8, label: 'Intro' },
      { name: 'verseA', startBar: 8, bars: 16, label: 'Verse A' },
      { name: 'verseB', startBar: 24, bars: 16, label: 'Verse B' },
      { name: 'breakdown', startBar: 40, bars: 8, label: 'Breakdown' },
      { name: 'climax', startBar: 48, bars: 16, label: 'Climax' },
      { name: 'outro', startBar: 64, bars: 8, label: 'Outro' }
    ];
    const totalBars = 72;

    // Section configurations
    const sectionConfigs = {
      intro: {
        drums: false, bass: false, chords: true, melody: false,
        filterFreq: 600, reverbWet: 0.6, chordsVol: -15
      },
      verseA: {
        drums: true, bass: true, chords: true, melody: false,
        filterFreq: 1400, reverbWet: 0.35, chordsVol: -10
      },
      verseB: {
        drums: true, bass: true, chords: true, melody: true,
        filterFreq: 1800, reverbWet: 0.4, chordsVol: -10
      },
      breakdown: {
        drums: false, bass: false, chords: true, melody: false,
        filterFreq: 400, reverbWet: 0.7, chordsVol: -18
      },
      climax: {
        drums: true, bass: true, chords: true, melody: true,
        filterFreq: 2800, reverbWet: 0.45, chordsVol: -6
      },
      outro: {
        drums: false, bass: false, chords: true, melody: false,
        filterFreq: 500, reverbWet: 0.6, chordsVol: -20
      }
    };

    // =====================
    // AUDIO INITIALIZATION
    // =====================
    async function initAudio() {
      if (isInitialized) return;

      await Tone.start();

      // Transport
      Tone.Transport.bpm.value = 80;
      Tone.Transport.swing = 0.15;
      Tone.Transport.swingSubdivision = '16n';

      // Master filter
      masterFilter = new Tone.Filter({
        frequency: 2000,
        type: 'lowpass',
        rolloff: -12,
        Q: 1
      }).toDestination();

      // Reverb
      reverb = new Tone.Reverb(2.5);
      await reverb.generate();
      reverb.wet.value = 0.35;
      reverb.connect(Tone.Destination);

      // Delay
      delay = new Tone.FeedbackDelay('8n.', 0.2);
      delay.wet.value = 0.12;
      delay.connect(masterFilter);

      // Vinyl noise
      vinylFilter = new Tone.Filter(1200, 'lowpass').connect(Tone.Destination);
      vinyl = new Tone.Noise('brown');
      vinyl.connect(vinylFilter);
      vinyl.volume.value = -28;

      // Kick
      kick = new Tone.MembraneSynth({
        pitchDecay: 0.05,
        octaves: 6,
        oscillator: { type: 'sine' },
        envelope: { attack: 0.001, decay: 0.3, sustain: 0, release: 0.1 }
      }).connect(masterFilter);
      kick.volume.value = -Infinity;

      // Snare
      snare = new Tone.NoiseSynth({
        noise: { type: 'white' },
        envelope: { attack: 0.001, decay: 0.15, sustain: 0, release: 0.05 }
      }).connect(masterFilter);
      snare.volume.value = -Infinity;

      // Hi-hat
      hihat = new Tone.MetalSynth({
        frequency: 200,
        envelope: { attack: 0.001, decay: 0.05, release: 0.01 },
        harmonicity: 5.1,
        modulationIndex: 32,
        resonance: 4000,
        octaves: 1.5
      }).connect(masterFilter);
      hihat.volume.value = -Infinity;

      // Chords
      chords = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: 'sine' },
        envelope: { attack: 0.05, decay: 0.4, sustain: 0.5, release: 1 }
      }).connect(masterFilter).connect(reverb);
      chords.volume.value = -15;

      // Bass
      bass = new Tone.Synth({
        oscillator: { type: 'triangle' },
        envelope: { attack: 0.02, decay: 0.3, sustain: 0.4, release: 0.3 }
      }).connect(masterFilter);
      bass.volume.value = -Infinity;

      // Melody
      melody = new Tone.Synth({
        oscillator: { type: 'sine' },
        envelope: { attack: 0.1, decay: 0.3, sustain: 0.3, release: 0.8 }
      }).connect(masterFilter).connect(reverb).connect(delay);
      melody.volume.value = -Infinity;

      // Create patterns
      createPatterns();

      isInitialized = true;
      updateStatus('Audio ready! Press "Play Full Song" to experience your complete track.');

      document.getElementById('startBtn').disabled = true;
      document.getElementById('playBtn').disabled = false;
      document.getElementById('stopBtn').disabled = false;

      buildTimeline();
    }

    function createPatterns() {
      // Drum pattern
      drumLoop = new Tone.Part((time, note) => {
        const humanTime = time + (Math.random() - 0.5) * 0.015;
        const humanVel = note.vel * (0.9 + Math.random() * 0.2);

        if (note.type === 'kick') {
          kick.triggerAttackRelease('C1', '8n', humanTime, humanVel);
        } else if (note.type === 'snare') {
          snare.triggerAttackRelease('8n', humanTime, humanVel);
        } else if (note.type === 'hihat') {
          hihat.triggerAttackRelease('32n', humanTime, humanVel);
        }
      }, [
        { time: '0:0:0', type: 'kick', vel: 0.95 },
        { time: '0:0:0', type: 'hihat', vel: 0.5 },
        { time: '0:0:2', type: 'hihat', vel: 0.2 },
        { time: '0:1:0', type: 'snare', vel: 0.8 },
        { time: '0:1:0', type: 'hihat', vel: 0.4 },
        { time: '0:1:2', type: 'kick', vel: 0.7 },
        { time: '0:1:2', type: 'hihat', vel: 0.2 },
        { time: '0:2:0', type: 'hihat', vel: 0.5 },
        { time: '0:2:2', type: 'kick', vel: 0.8 },
        { time: '0:2:2', type: 'hihat', vel: 0.2 },
        { time: '0:3:0', type: 'snare', vel: 0.85 },
        { time: '0:3:0', type: 'hihat', vel: 0.4 },
        { time: '0:3:2', type: 'hihat', vel: 0.2 }
      ]);
      drumLoop.loop = true;
      drumLoop.loopEnd = '1m';

      // Chord progression
      chordLoop = new Tone.Part((time, chord) => {
        const humanTime = time + (Math.random() - 0.5) * 0.012;
        chords.triggerAttackRelease(chord.notes, chord.dur, humanTime, chord.vel);
      }, [
        { time: '0:0:0', notes: ['D3', 'F3', 'A3', 'C4'], dur: '2n', vel: 0.5 },
        { time: '1:0:0', notes: ['G3', 'B3', 'D4', 'F4'], dur: '2n', vel: 0.5 },
        { time: '2:0:0', notes: ['C3', 'E3', 'G3', 'B3'], dur: '2n', vel: 0.5 },
        { time: '3:0:0', notes: ['A2', 'C3', 'E3', 'G3'], dur: '2n', vel: 0.5 }
      ]);
      chordLoop.loop = true;
      chordLoop.loopEnd = '4m';

      // Bass line
      bassLoop = new Tone.Part((time, note) => {
        bass.triggerAttackRelease(note.note, note.dur, time, note.vel);
      }, [
        { time: '0:0:0', note: 'D2', dur: '4n', vel: 0.8 },
        { time: '0:2:0', note: 'D2', dur: '8n', vel: 0.6 },
        { time: '1:0:0', note: 'G2', dur: '4n', vel: 0.8 },
        { time: '1:2:0', note: 'G2', dur: '8n', vel: 0.6 },
        { time: '2:0:0', note: 'C2', dur: '4n', vel: 0.8 },
        { time: '2:2:0', note: 'E2', dur: '8n', vel: 0.6 },
        { time: '3:0:0', note: 'A1', dur: '4n', vel: 0.8 },
        { time: '3:2:0', note: 'A1', dur: '8n', vel: 0.6 }
      ]);
      bassLoop.loop = true;
      bassLoop.loopEnd = '4m';

      // Melody
      melodyLoop = new Tone.Part((time, note) => {
        const humanTime = time + (Math.random() - 0.5) * 0.02;
        const humanVel = note.vel * (0.85 + Math.random() * 0.3);
        melody.triggerAttackRelease(note.note, note.dur, humanTime, humanVel);
      }, [
        { time: '0:0:0', note: 'A4', dur: '4n', vel: 0.6 },
        { time: '0:2:0', note: 'G4', dur: '8n', vel: 0.4 },
        { time: '1:0:0', note: 'F4', dur: '4n.', vel: 0.6 },
        { time: '2:0:0', note: 'E4', dur: '4n', vel: 0.5 },
        { time: '2:2:0', note: 'D4', dur: '4n', vel: 0.5 },
        { time: '3:0:0', note: 'C4', dur: '2n', vel: 0.6 }
      ]);
      melodyLoop.loop = true;
      melodyLoop.loopEnd = '4m';
    }

    // =====================
    // TIMELINE
    // =====================
    function buildTimeline() {
      const timeline = document.getElementById('timeline');
      timeline.innerHTML = '<div class="playhead" id="playhead"></div>';

      songStructure.forEach((section, index) => {
        const div = document.createElement('div');
        div.className = `timeline-section ${section.name}`;
        div.style.width = `${(section.bars / totalBars) * 100}%`;
        div.dataset.index = index;

        div.innerHTML = `
          <div class="section-name">${section.label}</div>
          <div class="section-bars">${section.bars} bars</div>
        `;

        div.addEventListener('click', () => jumpToSection(index));
        timeline.appendChild(div);
      });

      document.getElementById('totalBars').textContent = totalBars;
      scheduleStructure();
    }

    function scheduleStructure() {
      Tone.Transport.cancel();

      songStructure.forEach((section, index) => {
        Tone.Transport.schedule((time) => {
          currentSectionIndex = index;
          applySection(section.name, time);

          Tone.Draw.schedule(() => {
            updateSectionDisplay(section.name, index);
          }, time);
        }, `${section.startBar}:0:0`);
      });

      // Transition effects
      // Before breakdown: filter sweep down
      Tone.Transport.schedule((time) => {
        masterFilter.frequency.cancelScheduledValues(time);
        masterFilter.frequency.setValueAtTime(1800, time);
        masterFilter.frequency.exponentialRampTo(400, 2, time);
      }, '38:0:0');

      // Before climax: build up
      Tone.Transport.schedule((time) => {
        masterFilter.frequency.exponentialRampTo(2800, 2.5, time);
        reverb.wet.rampTo(0.55, 2, time);
      }, '45:0:0');

      // Climax hit: drum fill
      Tone.Transport.schedule((time) => {
        for (let i = 0; i < 6; i++) {
          snare.triggerAttackRelease('16n', time + i * 0.1, 0.3 + i * 0.1);
        }
        kick.triggerAttackRelease('C1', '4n', time + 0.6, 1);
      }, '47:3:0');

      // End of song
      Tone.Transport.schedule((time) => {
        Tone.Draw.schedule(() => {
          stopPlayback();
          showCelebration();
        }, time);
      }, `${totalBars}:0:0`);
    }

    function applySection(name, time) {
      const config = sectionConfigs[name];
      const rampTime = 0.5;

      // Filter & reverb
      masterFilter.frequency.rampTo(config.filterFreq, rampTime, time);
      reverb.wet.rampTo(config.reverbWet, rampTime, time);

      // Drums
      if (config.drums) {
        kick.volume.rampTo(-8, 0.3, time);
        snare.volume.rampTo(-12, 0.3, time);
        hihat.volume.rampTo(-20, 0.3, time);
      } else {
        kick.volume.rampTo(-Infinity, 0.3, time);
        snare.volume.rampTo(-Infinity, 0.3, time);
        hihat.volume.rampTo(-Infinity, 0.3, time);
      }

      // Bass
      bass.volume.rampTo(config.bass ? -8 : -Infinity, 0.3, time);

      // Chords
      chords.volume.rampTo(config.chordsVol, 0.3, time);

      // Melody
      melody.volume.rampTo(config.melody ? -10 : -Infinity, 0.3, time);
    }

    function updateSectionDisplay(name, index) {
      const section = songStructure[index];

      // Update section name display
      const nameEl = document.getElementById('currentSectionName');
      nameEl.textContent = section.label.toUpperCase();

      // Color based on section
      const colors = {
        intro: '#3a506b',
        verseA: '#5c7a99',
        verseB: '#667eea',
        breakdown: '#888',
        climax: '#e94560',
        outro: '#3a506b'
      };
      nameEl.style.color = colors[name] || '#e94560';

      // Update section buttons
      document.querySelectorAll('.section-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.section === name);
      });

      // Update timeline
      document.querySelectorAll('.timeline-section').forEach((s, i) => {
        s.classList.toggle('active', i === index);
      });

      // Update element cards
      const config = sectionConfigs[name];
      updateElementCard('drumsCard', config.drums);
      updateElementCard('bassCard', config.bass);
      updateElementCard('chordsCard', config.chords);
      updateElementCard('melodyCard', config.melody);
    }

    function updateElementCard(id, active) {
      const card = document.getElementById(id);
      if (active) {
        card.classList.add('active');
        card.querySelector('.element-status').textContent = 'PLAYING';
      } else {
        card.classList.remove('active');
        card.querySelector('.element-status').textContent = 'OFF';
      }
    }

    function jumpToSection(index) {
      if (!isInitialized) return;

      const section = songStructure[index];
      currentSectionIndex = index;

      Tone.Transport.position = `${section.startBar}:0:0`;

      applySection(section.name, Tone.now());
      updateSectionDisplay(section.name, index);

      if (!isPlaying) {
        startPlayback();
      }

      updateStatus(`Jumped to ${section.label}`);
    }

    // =====================
    // PLAYBACK CONTROL
    // =====================
    function startPlayback() {
      if (isPlaying) return;

      drumLoop.start(0);
      chordLoop.start(0);
      bassLoop.start(0);
      melodyLoop.start(0);
      vinyl.start();

      Tone.Transport.start();
      isPlaying = true;

      document.getElementById('playBtn').textContent = 'Playing...';
      document.getElementById('playBtn').disabled = true;

      requestAnimationFrame(updatePlayhead);
    }

    function stopPlayback() {
      drumLoop.stop();
      chordLoop.stop();
      bassLoop.stop();
      melodyLoop.stop();
      vinyl.stop();

      Tone.Transport.stop();
      Tone.Transport.position = 0;
      isPlaying = false;
      currentSectionIndex = 0;

      document.getElementById('playBtn').textContent = 'Play Full Song';
      document.getElementById('playBtn').disabled = false;

      // Reset display
      document.getElementById('currentSectionName').textContent = 'READY';
      document.getElementById('currentSectionName').style.color = '#e94560';
      document.getElementById('playhead').style.left = '0%';
      document.getElementById('progressFill').style.width = '0%';
      document.getElementById('currentBar').textContent = '0';
      document.getElementById('positionDisplay').textContent = '0:0:0';
      document.getElementById('currentTime').textContent = '0:00';

      // Reset element cards
      document.querySelectorAll('.element-card').forEach(card => {
        if (card.id !== 'vinylCard') {
          card.classList.remove('active');
          card.querySelector('.element-status').textContent = 'OFF';
        }
      });

      // Reset section buttons and timeline
      document.querySelectorAll('.section-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.timeline-section').forEach(s => s.classList.remove('active'));
    }

    function updatePlayhead() {
      if (!isPlaying) return;

      const position = Tone.Transport.position;
      document.getElementById('positionDisplay').textContent = position.split('.')[0];

      // Parse position
      const parts = position.split(':');
      const bar = parseInt(parts[0]) + 1;
      const beat = parseInt(parts[1]);
      const sixteenth = parseFloat(parts[2]);

      document.getElementById('currentBar').textContent = bar;

      // Calculate progress
      const progressBars = parseInt(parts[0]) + beat / 4 + sixteenth / 16;
      const percent = (progressBars / totalBars) * 100;

      document.getElementById('playhead').style.left = `${Math.min(percent, 100)}%`;
      document.getElementById('progressFill').style.width = `${Math.min(percent, 100)}%`;

      // Calculate time
      const bpm = Tone.Transport.bpm.value;
      const secondsPerBar = (60 / bpm) * 4;
      const totalSeconds = progressBars * secondsPerBar;
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = Math.floor(totalSeconds % 60);
      document.getElementById('currentTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

      requestAnimationFrame(updatePlayhead);
    }

    function showCelebration() {
      document.getElementById('celebration').classList.add('active');
    }

    function updateStatus(msg) {
      document.getElementById('status').textContent = msg;
    }

    // =====================
    // EVENT LISTENERS
    // =====================
    document.getElementById('startBtn').addEventListener('click', initAudio);

    document.getElementById('playBtn').addEventListener('click', async () => {
      if (!isInitialized) await initAudio();
      Tone.Transport.position = 0;
      currentSectionIndex = 0;
      applySection('intro', Tone.now());
      updateSectionDisplay('intro', 0);
      startPlayback();
      updateStatus('Playing your complete lofi track...');
    });

    document.getElementById('stopBtn').addEventListener('click', () => {
      stopPlayback();
      updateStatus('Stopped. Press Play to start again.');
    });

    document.getElementById('closeBtn').addEventListener('click', () => {
      document.getElementById('celebration').classList.remove('active');
    });

    // Volume control
    document.getElementById('volumeSlider').addEventListener('input', (e) => {
      const vol = parseFloat(e.target.value);
      Tone.Destination.volume.value = vol;
      document.getElementById('volumeValue').textContent = `${vol} dB`;
    });

    // Section buttons
    document.querySelectorAll('.section-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!isInitialized) await initAudio();
        const sectionName = btn.dataset.section;
        const index = songStructure.findIndex(s => s.name === sectionName);
        if (index >= 0) {
          jumpToSection(index);
        }
      });
    });

    // Copy code button
    document.getElementById('copyBtn').addEventListener('click', () => {
      const code = document.getElementById('codeDisplay').textContent;
      navigator.clipboard.writeText(code).then(() => {
        document.getElementById('copyBtn').textContent = 'Copied!';
        setTimeout(() => {
          document.getElementById('copyBtn').textContent = 'Copy Code';
        }, 2000);
      });
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', async (e) => {
      if (!isInitialized) await initAudio();

      switch (e.key.toLowerCase()) {
        case ' ':
          e.preventDefault();
          if (isPlaying) stopPlayback(); else {
            Tone.Transport.position = 0;
            applySection('intro', Tone.now());
            updateSectionDisplay('intro', 0);
            startPlayback();
          }
          break;
        case '1': jumpToSection(0); break;
        case '2': jumpToSection(1); break;
        case '3': jumpToSection(2); break;
        case '4': jumpToSection(3); break;
        case '5': jumpToSection(4); break;
        case '6': jumpToSection(5); break;
      }
    });

    // Initial click to init
    document.addEventListener('click', async () => {
      if (!isInitialized) await initAudio();
    }, { once: true });

    // Build initial timeline (visual only)
    function buildInitialTimeline() {
      const timeline = document.getElementById('timeline');
      timeline.innerHTML = '<div class="playhead" id="playhead"></div>';

      songStructure.forEach((section, index) => {
        const div = document.createElement('div');
        div.className = `timeline-section ${section.name}`;
        div.style.width = `${(section.bars / totalBars) * 100}%`;
        div.dataset.index = index;

        div.innerHTML = `
          <div class="section-name">${section.label}</div>
          <div class="section-bars">${section.bars} bars</div>
        `;

        timeline.appendChild(div);
      });

      document.getElementById('totalBars').textContent = totalBars;

      // Calculate total time
      const bpm = 80;
      const secondsPerBar = (60 / bpm) * 4;
      const totalSeconds = totalBars * secondsPerBar;
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = Math.floor(totalSeconds % 60);
      document.getElementById('totalTime').textContent = `~${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    buildInitialTimeline();
  </script>
</body>
</html>
