<!DOCTYPE html>
<html>
<head>
  <title>Tempo and Time - Demo</title>
  <script src="https://unpkg.com/tone@14"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #eee;
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .container { max-width: 900px; margin: 0 auto; }
    h1 { color: #e94560; margin-bottom: 10px; }
    h2 { color: #4ecdc4; margin-top: 30px; }
    .subtitle { color: #888; margin-bottom: 30px; }

    .section {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }

    .control {
      background: rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 8px;
    }
    .control label {
      display: block;
      color: #888;
      font-size: 12px;
      margin-bottom: 5px;
    }
    .control .value {
      color: #e94560;
      font-weight: bold;
      float: right;
    }
    .control input[type="range"] {
      width: 100%;
      margin-top: 5px;
    }

    button {
      background: #e94560;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 8px;
      margin: 5px;
      transition: transform 0.1s, background 0.2s;
    }
    button:hover { background: #ff6b6b; transform: scale(1.02); }
    button:active { transform: scale(0.98); }
    button:disabled { background: #444; cursor: not-allowed; transform: none; }
    button.secondary {
      background: #4ecdc4;
    }
    button.secondary:hover { background: #6ee7df; }
    button.active {
      box-shadow: 0 0 15px rgba(233, 69, 96, 0.5);
    }

    .preset-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 15px 0;
    }
    .preset-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid #444;
      color: #888;
      padding: 10px 18px;
      font-size: 13px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .preset-btn:hover {
      background: rgba(255,255,255,0.15);
      color: #eee;
      border-color: #666;
    }
    .preset-btn.active {
      background: rgba(78, 205, 196, 0.2);
      border-color: #4ecdc4;
      color: #4ecdc4;
    }

    #status {
      text-align: center;
      padding: 10px;
      color: #888;
      font-size: 14px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      margin: 10px 0;
    }

    .info-box {
      background: rgba(78, 205, 196, 0.1);
      border-left: 4px solid #4ecdc4;
      padding: 15px;
      margin: 15px 0;
      border-radius: 0 8px 8px 0;
    }
    .info-box.tip {
      background: rgba(255, 215, 0, 0.1);
      border-left-color: #ffd700;
    }

    /* Metronome visual */
    .metronome-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
    }

    .beat-indicator {
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    .beat-dot {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      border: 2px solid #444;
      transition: all 0.1s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #666;
    }

    .beat-dot.active {
      background: #e94560;
      border-color: #e94560;
      box-shadow: 0 0 20px rgba(233, 69, 96, 0.6);
      color: white;
    }

    .beat-dot.downbeat {
      width: 50px;
      height: 50px;
      font-size: 16px;
    }

    .beat-dot.downbeat.active {
      background: #4ecdc4;
      border-color: #4ecdc4;
      box-shadow: 0 0 25px rgba(78, 205, 196, 0.6);
    }

    /* BPM display */
    .bpm-display {
      text-align: center;
      margin: 20px 0;
    }

    .bpm-number {
      font-size: 72px;
      font-weight: bold;
      color: #e94560;
      line-height: 1;
    }

    .bpm-label {
      font-size: 18px;
      color: #888;
      margin-top: 5px;
    }

    .mood-indicator {
      font-size: 14px;
      color: #4ecdc4;
      margin-top: 10px;
      font-style: italic;
    }

    /* Note duration table */
    .duration-table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }

    .duration-table th,
    .duration-table td {
      padding: 10px 15px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .duration-table th {
      color: #4ecdc4;
      font-weight: normal;
      font-size: 12px;
      text-transform: uppercase;
    }

    .duration-table td {
      color: #eee;
    }

    .duration-table .notation {
      font-family: monospace;
      color: #e94560;
    }

    .duration-table .ms {
      color: #888;
      font-size: 13px;
    }

    /* Tempo comparison */
    .tempo-comparison {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }

    .tempo-card {
      background: rgba(0,0,0,0.2);
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .tempo-card:hover {
      background: rgba(0,0,0,0.3);
      border-color: #444;
    }

    .tempo-card.active {
      border-color: #4ecdc4;
      background: rgba(78, 205, 196, 0.1);
    }

    .tempo-card .tempo {
      font-size: 32px;
      font-weight: bold;
      color: #e94560;
    }

    .tempo-card .label {
      color: #4ecdc4;
      margin-top: 5px;
      font-size: 14px;
    }

    .tempo-card .description {
      color: #888;
      font-size: 12px;
      margin-top: 8px;
    }

    /* Tempo ramp visualization */
    .ramp-visual {
      height: 60px;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      margin: 15px 0;
      position: relative;
      overflow: hidden;
    }

    .ramp-line {
      position: absolute;
      top: 0;
      left: 0;
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #4ecdc4, #e94560);
      transition: width 0.1s linear;
      opacity: 0.3;
    }

    .ramp-marker {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 80%;
      background: #e94560;
      border-radius: 2px;
      left: 0%;
      transition: left 0.1s linear;
    }

    .ramp-labels {
      display: flex;
      justify-content: space-between;
      padding: 0 10px;
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Tempo and Time</h1>
    <p class="subtitle">Understanding BPM and musical timing for lofi beats</p>

    <div id="status">Click any button to start audio</div>

    <div class="section">
      <h2>1. BPM Control</h2>
      <p>Adjust the tempo and hear how it affects the feel of the beat.</p>

      <div class="bpm-display">
        <div class="bpm-number" id="bpmDisplay">75</div>
        <div class="bpm-label">BPM</div>
        <div class="mood-indicator" id="moodIndicator">Classic lofi vibe</div>
      </div>

      <div class="controls">
        <div class="control" style="grid-column: 1 / -1;">
          <label>Tempo (BPM) <span class="value" id="bpmVal">75</span></label>
          <input type="range" id="bpmSlider" min="60" max="120" step="1" value="75">
        </div>
      </div>

      <div class="preset-buttons">
        <button class="preset-btn" data-bpm="65">Super Chill (65)</button>
        <button class="preset-btn active" data-bpm="75">Classic Lofi (75)</button>
        <button class="preset-btn" data-bpm="85">Upbeat (85)</button>
        <button class="preset-btn" data-bpm="95">Energetic (95)</button>
      </div>

      <div class="info-box tip">
        <strong>Tip:</strong> Most lofi hip hop lives between 70-85 BPM. The iconic "lofi beats to study to" style typically sits around 75 BPM.
      </div>
    </div>

    <div class="section">
      <h2>2. Visual Metronome</h2>
      <p>Watch and feel the beat. The larger dot is the downbeat (beat 1).</p>

      <div class="metronome-container">
        <div class="beat-indicator">
          <div class="beat-dot downbeat" data-beat="1">1</div>
          <div class="beat-dot" data-beat="2">2</div>
          <div class="beat-dot" data-beat="3">3</div>
          <div class="beat-dot" data-beat="4">4</div>
        </div>
      </div>

      <div style="text-align: center;">
        <button id="startMetronome">Start Metronome</button>
        <button id="stopMetronome" disabled>Stop</button>
        <button id="playBeat" class="secondary">Play Simple Beat</button>
      </div>
    </div>

    <div class="section">
      <h2>3. Note Durations</h2>
      <p>See how long each note value is at the current tempo.</p>

      <table class="duration-table">
        <thead>
          <tr>
            <th>Notation</th>
            <th>Name</th>
            <th>Beats</th>
            <th>Duration</th>
          </tr>
        </thead>
        <tbody id="durationTableBody">
          <!-- Filled by JavaScript -->
        </tbody>
      </table>

      <div class="info-box">
        <strong>Formula:</strong> milliseconds = (60 / BPM) * 1000 * beats
      </div>
    </div>

    <div class="section">
      <h2>4. Feel the Difference</h2>
      <p>Click each card to hear how tempo affects the vibe of the same pattern.</p>

      <div class="tempo-comparison">
        <div class="tempo-card" data-tempo="65">
          <div class="tempo">65</div>
          <div class="label">Super Chill</div>
          <div class="description">Dreamy, floating, ambient</div>
        </div>
        <div class="tempo-card" data-tempo="75">
          <div class="tempo">75</div>
          <div class="label">Classic Lofi</div>
          <div class="description">Relaxed, comfortable groove</div>
        </div>
        <div class="tempo-card" data-tempo="85">
          <div class="tempo">85</div>
          <div class="label">Upbeat</div>
          <div class="description">Productive, flowing energy</div>
        </div>
        <div class="tempo-card" data-tempo="100">
          <div class="tempo">100</div>
          <div class="label">Not Lofi</div>
          <div class="description">Too fast for chill vibes</div>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>5. Tempo Ramps</h2>
      <p>Smoothly transition between tempos for natural-feeling changes.</p>

      <div class="ramp-visual">
        <div class="ramp-line" id="rampLine"></div>
        <div class="ramp-marker" id="rampMarker"></div>
      </div>
      <div class="ramp-labels">
        <span id="rampStart">75 BPM</span>
        <span id="rampEnd">75 BPM</span>
      </div>

      <div class="controls">
        <div class="control">
          <label>Target BPM <span class="value" id="targetBpmVal">85</span></label>
          <input type="range" id="targetBpm" min="60" max="120" step="1" value="85">
        </div>
        <div class="control">
          <label>Ramp Duration <span class="value" id="rampDurationVal">2s</span></label>
          <input type="range" id="rampDuration" min="0.5" max="5" step="0.5" value="2">
        </div>
      </div>

      <button id="startRamp">Start Tempo Ramp</button>
      <button id="resetTempo" class="secondary">Reset to 75 BPM</button>
    </div>
  </div>

  <script>
    // State
    let isMetronomeRunning = false;
    let isBeatPlaying = false;
    let currentBeat = 0;
    let metronomeLoop = null;
    let beatLoop = null;
    let kickLoop = null;
    let hihatLoop = null;
    let rampInterval = null;

    // Instruments
    let metronomeHigh = null;
    let metronomeLow = null;
    let kick = null;
    let hihat = null;
    let chord = null;

    // Note duration data
    const noteDurations = [
      { notation: "'1n'", name: "Whole note", beats: 4 },
      { notation: "'2n'", name: "Half note", beats: 2 },
      { notation: "'4n'", name: "Quarter note", beats: 1 },
      { notation: "'8n'", name: "Eighth note", beats: 0.5 },
      { notation: "'16n'", name: "Sixteenth note", beats: 0.25 },
      { notation: "'4t'", name: "Quarter triplet", beats: 2/3 },
      { notation: "'8t'", name: "Eighth triplet", beats: 1/3 }
    ];

    // Initialize audio
    async function initAudio() {
      // Metronome sounds
      metronomeHigh = new Tone.Synth({
        oscillator: { type: 'triangle' },
        envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 }
      }).toDestination();
      metronomeHigh.volume.value = -12;

      metronomeLow = new Tone.Synth({
        oscillator: { type: 'triangle' },
        envelope: { attack: 0.001, decay: 0.08, sustain: 0, release: 0.1 }
      }).toDestination();
      metronomeLow.volume.value = -15;

      // Beat instruments
      kick = new Tone.MembraneSynth({
        pitchDecay: 0.05,
        octaves: 4,
        envelope: { attack: 0.001, decay: 0.3, sustain: 0, release: 0.4 }
      }).toDestination();
      kick.volume.value = -8;

      hihat = new Tone.NoiseSynth({
        noise: { type: 'white' },
        envelope: { attack: 0.001, decay: 0.08, sustain: 0, release: 0.05 }
      }).toDestination();
      hihat.volume.value = -18;

      chord = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: 'triangle' },
        envelope: { attack: 0.1, decay: 0.3, sustain: 0.4, release: 1 }
      }).toDestination();
      chord.volume.value = -15;

      updateStatus('Ready! Click buttons to explore tempo.');
    }

    // Update status
    function updateStatus(msg) {
      document.getElementById('status').textContent = msg;
    }

    // Get mood description based on BPM
    function getMoodDescription(bpm) {
      if (bpm < 68) return "Very relaxed, dreamy, ambient";
      if (bpm < 73) return "Relaxed and mellow";
      if (bpm < 78) return "Classic lofi vibe";
      if (bpm < 83) return "Smooth and grooving";
      if (bpm < 88) return "Upbeat, productive energy";
      if (bpm < 95) return "Energetic, pushing lofi limits";
      return "Too fast for typical lofi";
    }

    // Update BPM display and related UI
    function updateBpmDisplay(bpm) {
      document.getElementById('bpmDisplay').textContent = bpm;
      document.getElementById('bpmVal').textContent = bpm;
      document.getElementById('bpmSlider').value = bpm;
      document.getElementById('moodIndicator').textContent = getMoodDescription(bpm);
      document.getElementById('rampStart').textContent = bpm + ' BPM';

      // Update active preset button
      document.querySelectorAll('.preset-btn[data-bpm]').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.dataset.bpm) === bpm);
      });

      // Update duration table
      updateDurationTable(bpm);
    }

    // Update duration table
    function updateDurationTable(bpm) {
      const tbody = document.getElementById('durationTableBody');
      const quarterMs = (60 / bpm) * 1000;

      tbody.innerHTML = noteDurations.map(note => {
        const ms = quarterMs * note.beats;
        return `
          <tr>
            <td class="notation">${note.notation}</td>
            <td>${note.name}</td>
            <td>${note.beats}</td>
            <td class="ms">${ms.toFixed(1)} ms</td>
          </tr>
        `;
      }).join('');
    }

    // Update beat indicator visuals
    function updateBeatIndicator(beat) {
      document.querySelectorAll('.beat-dot').forEach((dot, index) => {
        dot.classList.toggle('active', index === beat);
      });
    }

    // Start metronome
    async function startMetronome() {
      await Tone.start();

      if (metronomeLoop) metronomeLoop.dispose();

      currentBeat = 0;
      metronomeLoop = new Tone.Loop((time) => {
        // Play sound
        if (currentBeat === 0) {
          metronomeHigh.triggerAttackRelease('G5', '32n', time);
        } else {
          metronomeLow.triggerAttackRelease('G4', '32n', time);
        }

        // Update visual (schedule slightly after to sync with sound)
        Tone.Draw.schedule(() => {
          updateBeatIndicator(currentBeat);
        }, time);

        currentBeat = (currentBeat + 1) % 4;
      }, '4n').start(0);

      Tone.Transport.start();
      isMetronomeRunning = true;

      document.getElementById('startMetronome').disabled = true;
      document.getElementById('stopMetronome').disabled = false;
      updateStatus('Metronome running at ' + Math.round(Tone.Transport.bpm.value) + ' BPM');
    }

    // Stop metronome
    function stopMetronome() {
      if (metronomeLoop) {
        metronomeLoop.dispose();
        metronomeLoop = null;
      }

      if (!isBeatPlaying) {
        Tone.Transport.stop();
      }

      isMetronomeRunning = false;
      currentBeat = 0;
      updateBeatIndicator(-1); // Clear all

      document.getElementById('startMetronome').disabled = false;
      document.getElementById('stopMetronome').disabled = true;
      updateStatus('Metronome stopped');
    }

    // Play simple beat
    async function playBeat() {
      await Tone.start();

      if (isBeatPlaying) {
        stopBeat();
        return;
      }

      // Create loops
      if (kickLoop) kickLoop.dispose();
      if (hihatLoop) hihatLoop.dispose();

      let beatCount = 0;

      // Kick on 1 and 3
      kickLoop = new Tone.Loop((time) => {
        kick.triggerAttackRelease('C1', '8n', time);
      }, '2n').start(0);

      // Hi-hats on every eighth note
      hihatLoop = new Tone.Loop((time) => {
        hihat.triggerAttackRelease('16n', time);

        // Update beat indicator
        if (beatCount % 2 === 0) {
          Tone.Draw.schedule(() => {
            updateBeatIndicator(Math.floor(beatCount / 2) % 4);
          }, time);
        }
        beatCount++;
      }, '8n').start(0);

      // Play a chord every 2 bars
      Tone.Transport.scheduleRepeat((time) => {
        chord.triggerAttackRelease(['C4', 'Eb4', 'G4', 'Bb4'], '2n', time);
      }, '2m', 0);

      if (!isMetronomeRunning) {
        Tone.Transport.start();
      }

      isBeatPlaying = true;
      document.getElementById('playBeat').textContent = 'Stop Beat';
      document.getElementById('playBeat').classList.add('active');
      updateStatus('Beat playing at ' + Math.round(Tone.Transport.bpm.value) + ' BPM');
    }

    // Stop beat
    function stopBeat() {
      if (kickLoop) { kickLoop.dispose(); kickLoop = null; }
      if (hihatLoop) { hihatLoop.dispose(); hihatLoop = null; }

      Tone.Transport.cancel(); // Clear scheduled events

      if (!isMetronomeRunning) {
        Tone.Transport.stop();
      }

      isBeatPlaying = false;
      document.getElementById('playBeat').textContent = 'Play Simple Beat';
      document.getElementById('playBeat').classList.remove('active');
      updateBeatIndicator(-1);
      updateStatus('Beat stopped');
    }

    // Handle tempo card click
    async function handleTempoCard(tempo) {
      await Tone.start();

      // Update all displays
      Tone.Transport.bpm.value = tempo;
      updateBpmDisplay(tempo);

      // Highlight active card
      document.querySelectorAll('.tempo-card').forEach(card => {
        card.classList.toggle('active', parseInt(card.dataset.tempo) === tempo);
      });

      // Play a quick sample at this tempo
      if (!isBeatPlaying) {
        kick.triggerAttackRelease('C1', '8n');
        setTimeout(() => hihat.triggerAttackRelease('16n'), (60 / tempo) * 1000 / 2);
        setTimeout(() => hihat.triggerAttackRelease('16n'), (60 / tempo) * 1000);
        setTimeout(() => kick.triggerAttackRelease('C1', '8n'), (60 / tempo) * 1000 * 1.5);
      }

      updateStatus(`Tempo set to ${tempo} BPM - ${getMoodDescription(tempo)}`);
    }

    // Start tempo ramp
    async function startTempoRamp() {
      await Tone.start();

      const startBpm = Tone.Transport.bpm.value;
      const targetBpm = parseInt(document.getElementById('targetBpm').value);
      const duration = parseFloat(document.getElementById('rampDuration').value);

      // Update labels
      document.getElementById('rampStart').textContent = Math.round(startBpm) + ' BPM';
      document.getElementById('rampEnd').textContent = targetBpm + ' BPM';

      // Animate the visual
      const rampLine = document.getElementById('rampLine');
      const rampMarker = document.getElementById('rampMarker');

      // Clear any existing interval
      if (rampInterval) clearInterval(rampInterval);

      // Start the ramp
      Tone.Transport.bpm.rampTo(targetBpm, duration);

      const startTime = Date.now();
      const durationMs = duration * 1000;

      rampInterval = setInterval(() => {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / durationMs, 1);

        rampLine.style.width = (progress * 100) + '%';
        rampMarker.style.left = (progress * 100) + '%';

        // Update BPM display
        const currentBpm = Math.round(Tone.Transport.bpm.value);
        updateBpmDisplay(currentBpm);

        if (progress >= 1) {
          clearInterval(rampInterval);
          updateStatus(`Tempo ramped to ${targetBpm} BPM`);
        }
      }, 50);

      updateStatus(`Ramping from ${Math.round(startBpm)} to ${targetBpm} BPM over ${duration}s...`);
    }

    // Reset tempo
    function resetTempo() {
      if (rampInterval) clearInterval(rampInterval);

      Tone.Transport.bpm.value = 75;
      updateBpmDisplay(75);

      document.getElementById('rampLine').style.width = '0%';
      document.getElementById('rampMarker').style.left = '0%';

      updateStatus('Tempo reset to 75 BPM');
    }

    // Event listeners
    function setupEventListeners() {
      // BPM slider
      document.getElementById('bpmSlider').addEventListener('input', (e) => {
        const bpm = parseInt(e.target.value);
        Tone.Transport.bpm.value = bpm;
        updateBpmDisplay(bpm);
      });

      // BPM presets
      document.querySelectorAll('.preset-btn[data-bpm]').forEach(btn => {
        btn.addEventListener('click', () => {
          const bpm = parseInt(btn.dataset.bpm);
          Tone.Transport.bpm.value = bpm;
          updateBpmDisplay(bpm);
        });
      });

      // Metronome controls
      document.getElementById('startMetronome').addEventListener('click', startMetronome);
      document.getElementById('stopMetronome').addEventListener('click', stopMetronome);
      document.getElementById('playBeat').addEventListener('click', playBeat);

      // Tempo comparison cards
      document.querySelectorAll('.tempo-card').forEach(card => {
        card.addEventListener('click', () => {
          handleTempoCard(parseInt(card.dataset.tempo));
        });
      });

      // Tempo ramp controls
      document.getElementById('targetBpm').addEventListener('input', (e) => {
        document.getElementById('targetBpmVal').textContent = e.target.value;
        document.getElementById('rampEnd').textContent = e.target.value + ' BPM';
      });

      document.getElementById('rampDuration').addEventListener('input', (e) => {
        document.getElementById('rampDurationVal').textContent = e.target.value + 's';
      });

      document.getElementById('startRamp').addEventListener('click', startTempoRamp);
      document.getElementById('resetTempo').addEventListener('click', resetTempo);
    }

    // Initialize
    async function init() {
      await initAudio();
      setupEventListeners();
      updateDurationTable(75);

      // Set initial Transport BPM
      Tone.Transport.bpm.value = 75;
    }

    init();
  </script>
</body>
</html>
