<!DOCTYPE html>
<html>
<head>
  <title>Project 4: Living Sound - Demo</title>
  <script src="https://unpkg.com/tone@14"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #eee;
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .container { max-width: 1000px; margin: 0 auto; }
    h1 { color: #e94560; margin-bottom: 10px; }
    h2 { color: #4ecdc4; margin-top: 30px; margin-bottom: 15px; }
    h3 { color: #888; margin-bottom: 10px; }
    .subtitle { color: #888; margin-bottom: 30px; }

    .section {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }

    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }

    .control {
      background: rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 8px;
    }
    .control label {
      display: block;
      color: #888;
      font-size: 12px;
      margin-bottom: 5px;
    }
    .control .value {
      color: #e94560;
      font-weight: bold;
      float: right;
    }
    .control input[type="range"] {
      width: 100%;
      margin-top: 5px;
      accent-color: #4ecdc4;
    }

    button {
      background: #e94560;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 8px;
      margin: 5px;
      transition: all 0.2s;
    }
    button:hover { background: #ff6b6b; transform: scale(1.02); }
    button:active { transform: scale(0.98); }
    button:disabled { background: #444; cursor: not-allowed; transform: none; }
    button.secondary { background: #4ecdc4; }
    button.secondary:hover { background: #6ee7df; }
    button.active {
      background: #4ecdc4;
      box-shadow: 0 0 15px rgba(78, 205, 196, 0.5);
    }

    .toggle-btn {
      background: rgba(255,255,255,0.1);
      border: 2px solid #444;
      padding: 10px 20px;
      color: #888;
      font-size: 14px;
    }
    .toggle-btn.active {
      background: rgba(78, 205, 196, 0.2);
      border-color: #4ecdc4;
      color: #4ecdc4;
    }
    .toggle-btn:hover {
      border-color: #666;
      background: rgba(255,255,255,0.05);
    }

    /* LFO Visualization */
    .lfo-visual-container {
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }
    #lfoCanvas {
      width: 100%;
      height: 100px;
      background: rgba(0,0,0,0.5);
      border-radius: 8px;
    }
    .lfo-value-display {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      padding: 0 10px;
    }
    .lfo-value-item {
      text-align: center;
    }
    .lfo-value-item .label {
      font-size: 11px;
      color: #666;
    }
    .lfo-value-item .value {
      font-size: 16px;
      font-weight: bold;
      color: #4ecdc4;
    }

    /* Chord Display */
    .chord-display {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
      margin: 20px 0;
    }
    .chord-card {
      background: rgba(0,0,0,0.3);
      border: 3px solid rgba(78, 205, 196, 0.3);
      border-radius: 12px;
      padding: 20px 30px;
      min-width: 120px;
      text-align: center;
      transition: all 0.2s;
    }
    .chord-card.active {
      border-color: #e94560;
      background: rgba(233, 69, 96, 0.2);
      transform: scale(1.1);
      box-shadow: 0 0 20px rgba(233, 69, 96, 0.4);
    }
    .chord-name {
      font-size: 24px;
      font-weight: bold;
      color: #4ecdc4;
    }
    .chord-card.active .chord-name {
      color: #e94560;
    }
    .chord-numeral {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    /* A/B Comparison */
    .comparison-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }
    .comparison-box {
      background: rgba(0,0,0,0.2);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      border: 2px solid transparent;
      transition: all 0.2s;
    }
    .comparison-box.active {
      border-color: #e94560;
    }
    .comparison-box h3 {
      color: #e94560;
      margin-top: 0;
      margin-bottom: 10px;
    }
    .comparison-box.living h3 { color: #4ecdc4; }
    .comparison-box p {
      color: #888;
      font-size: 13px;
      margin-bottom: 15px;
    }
    .comparison-box ul {
      text-align: left;
      color: #aaa;
      font-size: 12px;
      padding-left: 20px;
      margin: 10px 0;
    }

    @media (max-width: 600px) {
      .comparison-grid { grid-template-columns: 1fr; }
    }

    .info-box {
      background: rgba(78, 205, 196, 0.1);
      border-left: 4px solid #4ecdc4;
      padding: 15px;
      margin: 15px 0;
      border-radius: 0 8px 8px 0;
    }
    .info-box strong { color: #4ecdc4; }

    .tip-box {
      background: rgba(233, 69, 96, 0.1);
      border-left: 4px solid #e94560;
      padding: 15px;
      margin: 15px 0;
      border-radius: 0 8px 8px 0;
    }
    .tip-box strong { color: #e94560; }

    #status {
      padding: 12px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      font-size: 14px;
      color: #888;
      text-align: center;
      margin: 15px 0;
    }

    .main-controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      margin: 20px 0;
    }

    .play-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      font-size: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }
    .play-btn.playing { background: #4ecdc4; }

    /* Filter indicator */
    .filter-indicator {
      height: 12px;
      background: rgba(0,0,0,0.3);
      border-radius: 6px;
      margin: 10px 0;
      overflow: hidden;
      position: relative;
    }
    .filter-indicator-fill {
      height: 100%;
      background: linear-gradient(90deg, #e94560, #4ecdc4);
      border-radius: 6px;
      transition: width 0.1s;
    }
    .filter-indicator-labels {
      display: flex;
      justify-content: space-between;
      font-size: 10px;
      color: #666;
      margin-top: 4px;
    }

    /* Pan indicator */
    .pan-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }
    .pan-track {
      flex: 1;
      height: 8px;
      background: rgba(0,0,0,0.3);
      border-radius: 4px;
      position: relative;
    }
    .pan-dot {
      width: 16px;
      height: 16px;
      background: #4ecdc4;
      border-radius: 50%;
      position: absolute;
      top: -4px;
      left: 50%;
      transform: translateX(-50%);
      transition: left 0.1s;
      box-shadow: 0 0 10px rgba(78, 205, 196, 0.5);
    }
    .pan-label {
      font-size: 12px;
      color: #666;
      min-width: 20px;
    }

    .sweep-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 15px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Project 4: Living Sound</h1>
    <p class="subtitle">Add movement and life with LFOs and automation</p>

    <div id="status">Click Play to hear the difference between static and living sound</div>

    <div class="section">
      <h2>1. A/B Comparison: Static vs Living</h2>
      <p>Compare how movement transforms a track. Click each to hear the difference.</p>

      <div class="comparison-grid">
        <div class="comparison-box" id="staticBox">
          <h3>Static Sound</h3>
          <p>Fixed parameters, one chord, no movement</p>
          <ul>
            <li>Filter locked at 1200 Hz</li>
            <li>No stereo movement</li>
            <li>Single chord repeating</li>
          </ul>
          <button id="playStatic">Play Static</button>
        </div>

        <div class="comparison-box living" id="livingBox">
          <h3>Living Sound</h3>
          <p>LFO modulation, auto-pan, chord progression</p>
          <ul>
            <li>Filter breathes 800-2000 Hz</li>
            <li>Gentle stereo drift</li>
            <li>4-chord progression</li>
          </ul>
          <button id="playLiving" class="secondary">Play Living</button>
        </div>
      </div>

      <div style="text-align: center;">
        <button id="stopComparison">Stop</button>
      </div>
    </div>

    <div class="section">
      <h2>2. Chord Progression</h2>
      <p>The classic lofi progression: ii - V - I - vi in C major</p>

      <div class="chord-display" id="chordDisplay">
        <div class="chord-card" data-index="0">
          <div class="chord-name">Dm7</div>
          <div class="chord-numeral">ii</div>
        </div>
        <div class="chord-card" data-index="1">
          <div class="chord-name">G7</div>
          <div class="chord-numeral">V</div>
        </div>
        <div class="chord-card" data-index="2">
          <div class="chord-name">Cmaj7</div>
          <div class="chord-numeral">I</div>
        </div>
        <div class="chord-card" data-index="3">
          <div class="chord-name">Am7</div>
          <div class="chord-numeral">vi</div>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>3. LFO Controls</h2>
      <p>The LFO slowly modulates the filter, creating a breathing effect.</p>

      <div class="controls-grid">
        <div class="control">
          <label>LFO Rate <span class="value" id="lfoRateVal">0.15 Hz</span></label>
          <input type="range" id="lfoRate" min="0.05" max="2" step="0.05" value="0.15">
        </div>
        <div class="control">
          <label>LFO Depth <span class="value" id="lfoDepthVal">50%</span></label>
          <input type="range" id="lfoDepth" min="0" max="100" step="5" value="50">
        </div>
        <div class="control">
          <label>LFO Min Freq <span class="value" id="lfoMinVal">800 Hz</span></label>
          <input type="range" id="lfoMin" min="200" max="1500" step="50" value="800">
        </div>
        <div class="control">
          <label>LFO Max Freq <span class="value" id="lfoMaxVal">2000 Hz</span></label>
          <input type="range" id="lfoMax" min="1000" max="4000" step="100" value="2000">
        </div>
      </div>

      <div style="display: flex; gap: 10px; justify-content: center; margin: 15px 0;">
        <button class="toggle-btn active" id="lfoToggle">LFO ON</button>
      </div>

      <div class="lfo-visual-container">
        <canvas id="lfoCanvas"></canvas>
        <div class="lfo-value-display">
          <div class="lfo-value-item">
            <div class="label">Current Filter</div>
            <div class="value" id="filterValue">1200 Hz</div>
          </div>
          <div class="lfo-value-item">
            <div class="label">LFO Phase</div>
            <div class="value" id="lfoPhase">0%</div>
          </div>
        </div>
      </div>

      <h3>Filter Position</h3>
      <div class="filter-indicator">
        <div class="filter-indicator-fill" id="filterIndicator" style="width: 50%"></div>
      </div>
      <div class="filter-indicator-labels">
        <span>200 Hz (Muffled)</span>
        <span>4000 Hz (Bright)</span>
      </div>
    </div>

    <div class="section">
      <h2>4. Auto-Pan</h2>
      <p>Gentle stereo movement adds width and interest.</p>

      <div class="controls-grid">
        <div class="control">
          <label>Pan Rate <span class="value" id="panRateVal">0.08 Hz</span></label>
          <input type="range" id="panRate" min="0.02" max="0.5" step="0.02" value="0.08">
        </div>
        <div class="control">
          <label>Pan Depth <span class="value" id="panDepthVal">60%</span></label>
          <input type="range" id="panDepth" min="0" max="100" step="5" value="60">
        </div>
      </div>

      <div style="display: flex; gap: 10px; justify-content: center; margin: 15px 0;">
        <button class="toggle-btn active" id="panToggle">Auto-Pan ON</button>
      </div>

      <div class="pan-indicator">
        <span class="pan-label">L</span>
        <div class="pan-track">
          <div class="pan-dot" id="panDot"></div>
        </div>
        <span class="pan-label">R</span>
      </div>
    </div>

    <div class="section">
      <h2>5. Filter Sweep Automation</h2>
      <p>Trigger intentional filter sweeps for transitions and builds.</p>

      <div class="sweep-buttons">
        <button id="sweepUp">Sweep UP</button>
        <button id="sweepDown" class="secondary">Sweep DOWN</button>
      </div>

      <div class="tip-box">
        <strong>Tip:</strong> Use sweep up before a drop, sweep down after. Automation creates intentional moments, while LFO creates constant subtle movement.
      </div>
    </div>

    <div class="section">
      <h2>6. Full Living Sound</h2>
      <p>Play the complete lofi track with all living sound features enabled.</p>

      <div class="main-controls">
        <button class="play-btn" id="playBtn">&#9658;</button>
        <button class="secondary" id="stopBtn">Stop</button>
      </div>

      <div class="controls-grid">
        <div class="control">
          <label>BPM <span class="value" id="bpmVal">75</span></label>
          <input type="range" id="bpm" min="60" max="100" step="1" value="75">
        </div>
      </div>

      <div class="info-box">
        <strong>What's Happening:</strong>
        <ul style="margin: 10px 0; padding-left: 20px;">
          <li>4-chord progression cycling every 2 bars</li>
          <li>LFO slowly modulating filter cutoff</li>
          <li>Auto-panner drifting stereo position</li>
          <li>Warm reverb adding space</li>
          <li>Simple drums providing groove</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    // State
    let audioStarted = false;
    let isPlaying = false;
    let currentMode = null; // 'static', 'living', or 'full'
    let currentChordIndex = 0;

    // Audio nodes
    let synth, filter, filterLFO, autoPan, reverb;
    let kick, snare, hihat;
    let chordPart, drumLoops;

    // Settings
    let lfoEnabled = true;
    let panEnabled = true;
    let lfoRate = 0.15;
    let lfoDepth = 0.5;
    let lfoMin = 800;
    let lfoMax = 2000;
    let panRate = 0.08;
    let panDepth = 0.6;

    // Chords
    const chords = [
      { name: 'Dm7', numeral: 'ii', notes: ['D3', 'F3', 'A3', 'C4'] },
      { name: 'G7', numeral: 'V', notes: ['G2', 'B3', 'D4', 'F4'] },
      { name: 'Cmaj7', numeral: 'I', notes: ['C3', 'E3', 'G3', 'B3'] },
      { name: 'Am7', numeral: 'vi', notes: ['A2', 'C3', 'E3', 'G3'] }
    ];

    // Canvas
    const canvas = document.getElementById('lfoCanvas');
    const ctx = canvas.getContext('2d');
    let lfoHistory = [];
    const historyLength = 200;
    let animationId = null;

    function resizeCanvas() {
      canvas.width = canvas.offsetWidth * window.devicePixelRatio;
      canvas.height = canvas.offsetHeight * window.devicePixelRatio;
      ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    // Initialize audio
    async function initAudio() {
      if (audioStarted) return;

      await Tone.start();

      // Pad synth
      synth = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: 'triangle' },
        envelope: { attack: 0.2, decay: 0.3, sustain: 0.6, release: 1.5 }
      });
      synth.volume.value = -12;

      // Filter
      filter = new Tone.Filter({
        frequency: 1200,
        type: 'lowpass',
        rolloff: -12,
        Q: 1
      });

      // LFO for filter
      filterLFO = new Tone.LFO({
        frequency: lfoRate,
        min: lfoMin,
        max: lfoMax,
        type: 'sine'
      });
      filterLFO.connect(filter.frequency);

      // Auto-panner
      autoPan = new Tone.AutoPanner({
        frequency: panRate,
        depth: panDepth
      });

      // Reverb
      reverb = new Tone.Reverb({ decay: 2.5, wet: 0.35 });
      await reverb.generate();

      // Chain
      synth.chain(filter, autoPan, reverb, Tone.Destination);

      // Drums
      kick = new Tone.MembraneSynth({
        pitchDecay: 0.05,
        octaves: 4,
        envelope: { attack: 0.001, decay: 0.4, sustain: 0, release: 0.4 }
      }).toDestination();
      kick.volume.value = -10;

      snare = new Tone.NoiseSynth({
        noise: { type: 'white' },
        envelope: { attack: 0.001, decay: 0.15, sustain: 0, release: 0.1 }
      }).toDestination();
      snare.volume.value = -14;

      const hihatFilter = new Tone.Filter(8000, 'lowpass').toDestination();
      hihat = new Tone.NoiseSynth({
        noise: { type: 'white' },
        envelope: { attack: 0.001, decay: 0.08, sustain: 0, release: 0.05 }
      }).connect(hihatFilter);
      hihat.volume.value = -20;

      Tone.Transport.bpm.value = 75;
      audioStarted = true;
    }

    // Create chord part
    function createChordPart(useProgression = true) {
      if (chordPart) {
        chordPart.dispose();
      }

      if (useProgression) {
        const chordEvents = chords.map((chord, i) => ({
          time: `${Math.floor(i/2)}:${(i%2)*2}:0`,
          chord: chord
        }));

        chordPart = new Tone.Part((time, event) => {
          synth.triggerAttackRelease(event.chord.notes, '2n', time, 0.6);

          Tone.Draw.schedule(() => {
            highlightChord(chords.indexOf(event.chord));
            updateStatus(`Playing: ${event.chord.name} (${event.chord.numeral})`);
          }, time);
        }, chordEvents);

        chordPart.loop = true;
        chordPart.loopEnd = "2:0:0";
      } else {
        // Static: just one chord repeating
        chordPart = new Tone.Loop((time) => {
          synth.triggerAttackRelease(chords[0].notes, '2n', time, 0.6);
          Tone.Draw.schedule(() => {
            highlightChord(0);
            updateStatus('Playing: Dm7 (static - no progression)');
          }, time);
        }, '2n');
      }
    }

    // Create drum loops
    function createDrumLoops() {
      if (drumLoops) {
        drumLoops.forEach(l => l.dispose());
      }

      const kickSeq = new Tone.Sequence((time, hit) => {
        if (hit) kick.triggerAttackRelease('C1', '8n', time);
      }, [1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0], '16n');

      const snareSeq = new Tone.Sequence((time, hit) => {
        if (hit) snare.triggerAttackRelease('8n', time);
      }, [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], '16n');

      const hihatSeq = new Tone.Sequence((time, hit) => {
        if (hit) hihat.triggerAttackRelease('16n', time);
      }, [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0], '16n');

      drumLoops = [kickSeq, snareSeq, hihatSeq];
    }

    // Highlight chord
    function highlightChord(index) {
      document.querySelectorAll('.chord-card').forEach((card, i) => {
        card.classList.toggle('active', i === index);
      });
    }

    // Update status
    function updateStatus(msg) {
      document.getElementById('status').textContent = msg;
    }

    // Play static version
    async function playStatic() {
      await initAudio();
      stopAll();

      currentMode = 'static';
      document.getElementById('staticBox').classList.add('active');
      document.getElementById('livingBox').classList.remove('active');

      // Disable LFO and pan for static
      filterLFO.stop();
      autoPan.stop();
      filter.frequency.value = 1200;

      createChordPart(false);
      createDrumLoops();

      chordPart.start(0);
      drumLoops.forEach(l => l.start(0));
      Tone.Transport.start();
      isPlaying = true;

      startVisualization();
      updateStatus('Static mode: Fixed filter, no pan, single chord');
    }

    // Play living version
    async function playLiving() {
      await initAudio();
      stopAll();

      currentMode = 'living';
      document.getElementById('livingBox').classList.add('active');
      document.getElementById('staticBox').classList.remove('active');

      // Enable LFO and pan
      if (lfoEnabled) {
        filterLFO.start();
      }
      if (panEnabled) {
        autoPan.start();
      }

      createChordPart(true);
      createDrumLoops();

      chordPart.start(0);
      drumLoops.forEach(l => l.start(0));
      Tone.Transport.start();
      isPlaying = true;

      startVisualization();
      updateStatus('Living mode: LFO filter, auto-pan, chord progression');
    }

    // Play full version
    async function playFull() {
      await initAudio();
      stopAll();

      currentMode = 'full';

      if (lfoEnabled) {
        filterLFO.start();
      }
      if (panEnabled) {
        autoPan.start();
      }

      createChordPart(true);
      createDrumLoops();

      chordPart.start(0);
      drumLoops.forEach(l => l.start(0));
      Tone.Transport.start();
      isPlaying = true;

      document.getElementById('playBtn').innerHTML = '&#10074;&#10074;';
      document.getElementById('playBtn').classList.add('playing');

      startVisualization();
      updateStatus('Full living sound playing...');
    }

    // Stop all
    function stopAll() {
      Tone.Transport.stop();
      Tone.Transport.position = 0;

      if (chordPart) chordPart.stop(0);
      if (drumLoops) drumLoops.forEach(l => l.stop(0));
      if (filterLFO) filterLFO.stop();
      if (autoPan) autoPan.stop();

      isPlaying = false;
      currentMode = null;

      highlightChord(-1);
      document.getElementById('staticBox').classList.remove('active');
      document.getElementById('livingBox').classList.remove('active');
      document.getElementById('playBtn').innerHTML = '&#9658;';
      document.getElementById('playBtn').classList.remove('playing');

      stopVisualization();
      updateStatus('Stopped');
    }

    // Toggle full playback
    async function toggleFull() {
      if (isPlaying && currentMode === 'full') {
        stopAll();
      } else {
        await playFull();
      }
    }

    // Filter sweep automation
    function triggerFilterSweep(direction) {
      if (!filter) return;

      filter.frequency.cancelScheduledValues(Tone.now());

      if (direction === 'up') {
        filter.frequency.setValueAtTime(400, Tone.now());
        filter.frequency.exponentialRampTo(3000, 4);
        updateStatus('Filter sweep UP: 400 Hz -> 3000 Hz over 4 seconds');
      } else {
        filter.frequency.setValueAtTime(3000, Tone.now());
        filter.frequency.exponentialRampTo(400, 4);
        updateStatus('Filter sweep DOWN: 3000 Hz -> 400 Hz over 4 seconds');
      }

      // Temporarily disable LFO during sweep
      if (filterLFO) filterLFO.stop();

      // Re-enable after sweep
      setTimeout(() => {
        if (lfoEnabled && isPlaying && filterLFO) {
          filterLFO.start();
        }
      }, 4000);
    }

    // Visualization
    function startVisualization() {
      function draw() {
        const width = canvas.offsetWidth;
        const height = canvas.offsetHeight;

        ctx.clearRect(0, 0, width, height);

        // Calculate LFO value
        const now = Tone.now();
        const phase = (now * lfoRate) % 1;
        let lfoValue = (Math.sin(phase * Math.PI * 2) + 1) / 2;

        if (!lfoEnabled) lfoValue = 0.5;

        // Calculate current filter value
        let currentFilter;
        if (lfoEnabled && filterLFO && filter) {
          currentFilter = lfoMin + (lfoMax - lfoMin) * lfoValue;
        } else if (filter) {
          currentFilter = filter.frequency.value;
        } else {
          currentFilter = 1200;
        }

        // Update displays
        document.getElementById('filterValue').textContent = Math.round(currentFilter) + ' Hz';
        document.getElementById('lfoPhase').textContent = Math.round(phase * 100) + '%';

        // Filter indicator
        const filterPercent = ((currentFilter - 200) / (4000 - 200)) * 100;
        document.getElementById('filterIndicator').style.width = filterPercent + '%';

        // Pan indicator
        const panPhase = (now * panRate) % 1;
        let panValue = Math.sin(panPhase * Math.PI * 2);
        if (!panEnabled) panValue = 0;
        const panPercent = 50 + (panValue * panDepth * 50);
        document.getElementById('panDot').style.left = panPercent + '%';

        // Add to history
        lfoHistory.push(lfoValue);
        if (lfoHistory.length > historyLength) lfoHistory.shift();

        // Draw grid
        ctx.strokeStyle = 'rgba(255,255,255,0.1)';
        ctx.lineWidth = 1;
        for (let i = 0; i <= 4; i++) {
          const y = (i / 4) * height;
          ctx.beginPath();
          ctx.moveTo(0, y);
          ctx.lineTo(width, y);
          ctx.stroke();
        }

        // Draw LFO wave
        if (lfoHistory.length > 1) {
          ctx.strokeStyle = lfoEnabled ? '#e94560' : '#444';
          ctx.lineWidth = 2;
          ctx.beginPath();

          for (let i = 0; i < lfoHistory.length; i++) {
            const x = (i / historyLength) * width;
            const y = height - lfoHistory[i] * height;

            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          }
          ctx.stroke();

          // Current position dot
          if (lfoEnabled) {
            const lastX = ((lfoHistory.length - 1) / historyLength) * width;
            const lastY = height - lfoHistory[lfoHistory.length - 1] * height;

            ctx.fillStyle = '#4ecdc4';
            ctx.beginPath();
            ctx.arc(lastX, lastY, 5, 0, Math.PI * 2);
            ctx.fill();
          }
        }

        animationId = requestAnimationFrame(draw);
      }

      draw();
    }

    function stopVisualization() {
      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }
    }

    // Update LFO settings
    function updateLFOSettings() {
      if (filterLFO) {
        filterLFO.frequency.value = lfoRate;
        filterLFO.min = lfoMin;
        filterLFO.max = lfoMax;
      }
    }

    // Update pan settings
    function updatePanSettings() {
      if (autoPan) {
        autoPan.frequency.value = panRate;
        autoPan.depth.value = panDepth;
      }
    }

    // Event listeners
    document.getElementById('playStatic').addEventListener('click', playStatic);
    document.getElementById('playLiving').addEventListener('click', playLiving);
    document.getElementById('stopComparison').addEventListener('click', stopAll);
    document.getElementById('playBtn').addEventListener('click', toggleFull);
    document.getElementById('stopBtn').addEventListener('click', stopAll);

    document.getElementById('sweepUp').addEventListener('click', () => triggerFilterSweep('up'));
    document.getElementById('sweepDown').addEventListener('click', () => triggerFilterSweep('down'));

    // LFO toggle
    document.getElementById('lfoToggle').addEventListener('click', () => {
      lfoEnabled = !lfoEnabled;
      const btn = document.getElementById('lfoToggle');
      btn.classList.toggle('active', lfoEnabled);
      btn.textContent = lfoEnabled ? 'LFO ON' : 'LFO OFF';

      if (filterLFO) {
        if (lfoEnabled && isPlaying) {
          filterLFO.start();
        } else {
          filterLFO.stop();
          if (filter) filter.frequency.value = 1200;
        }
      }
    });

    // Pan toggle
    document.getElementById('panToggle').addEventListener('click', () => {
      panEnabled = !panEnabled;
      const btn = document.getElementById('panToggle');
      btn.classList.toggle('active', panEnabled);
      btn.textContent = panEnabled ? 'Auto-Pan ON' : 'Auto-Pan OFF';

      if (autoPan) {
        if (panEnabled && isPlaying) {
          autoPan.start();
        } else {
          autoPan.stop();
        }
      }
    });

    // LFO rate slider
    document.getElementById('lfoRate').addEventListener('input', (e) => {
      lfoRate = parseFloat(e.target.value);
      document.getElementById('lfoRateVal').textContent = lfoRate.toFixed(2) + ' Hz';
      updateLFOSettings();
    });

    // LFO depth slider
    document.getElementById('lfoDepth').addEventListener('input', (e) => {
      lfoDepth = parseInt(e.target.value) / 100;
      document.getElementById('lfoDepthVal').textContent = e.target.value + '%';
      // Depth affects min/max range
      const center = (lfoMax + lfoMin) / 2;
      const range = (lfoMax - lfoMin) / 2;
      if (filterLFO) {
        filterLFO.min = center - range * lfoDepth;
        filterLFO.max = center + range * lfoDepth;
      }
    });

    // LFO min slider
    document.getElementById('lfoMin').addEventListener('input', (e) => {
      lfoMin = parseInt(e.target.value);
      document.getElementById('lfoMinVal').textContent = lfoMin + ' Hz';
      updateLFOSettings();
    });

    // LFO max slider
    document.getElementById('lfoMax').addEventListener('input', (e) => {
      lfoMax = parseInt(e.target.value);
      document.getElementById('lfoMaxVal').textContent = lfoMax + ' Hz';
      updateLFOSettings();
    });

    // Pan rate slider
    document.getElementById('panRate').addEventListener('input', (e) => {
      panRate = parseFloat(e.target.value);
      document.getElementById('panRateVal').textContent = panRate.toFixed(2) + ' Hz';
      updatePanSettings();
    });

    // Pan depth slider
    document.getElementById('panDepth').addEventListener('input', (e) => {
      panDepth = parseInt(e.target.value) / 100;
      document.getElementById('panDepthVal').textContent = e.target.value + '%';
      updatePanSettings();
    });

    // BPM slider
    document.getElementById('bpm').addEventListener('input', (e) => {
      const val = parseInt(e.target.value);
      document.getElementById('bpmVal').textContent = val;
      Tone.Transport.bpm.value = val;
    });

    // Cleanup
    window.addEventListener('beforeunload', () => {
      stopVisualization();
      stopAll();
      if (synth) synth.dispose();
      if (filter) filter.dispose();
      if (filterLFO) filterLFO.dispose();
      if (autoPan) autoPan.dispose();
      if (reverb) reverb.dispose();
      if (kick) kick.dispose();
      if (snare) snare.dispose();
      if (hihat) hihat.dispose();
    });

    // Initialize visualization even when not playing
    startVisualization();
  </script>
</body>
</html>
