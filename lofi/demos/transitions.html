<!DOCTYPE html>
<html>
<head>
  <title>Transitions - Demo</title>
  <script src="https://unpkg.com/tone@14"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #eee;
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .container { max-width: 900px; margin: 0 auto; }
    h1 { color: #e94560; margin-bottom: 10px; }
    h2 { color: #4ecdc4; margin-top: 30px; }
    h3 { color: #888; margin-bottom: 10px; }
    .subtitle { color: #888; margin-bottom: 30px; }

    .section {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }

    .control {
      background: rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 8px;
    }
    .control label {
      display: block;
      color: #888;
      font-size: 12px;
      margin-bottom: 5px;
    }
    .control .value {
      color: #e94560;
      font-weight: bold;
      float: right;
    }
    .control select {
      width: 100%;
      padding: 8px;
      background: #2a2a4e;
      color: #eee;
      border: 1px solid #444;
      border-radius: 4px;
      font-size: 14px;
    }

    button {
      background: #e94560;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 8px;
      margin: 5px;
      transition: transform 0.1s, background 0.2s;
    }
    button:hover { background: #ff6b6b; transform: scale(1.02); }
    button:active { transform: scale(0.98); }
    button:disabled { background: #444; cursor: not-allowed; transform: none; }
    button.secondary {
      background: #4ecdc4;
    }
    button.secondary:hover { background: #6ee7df; }

    .transition-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid #444;
      padding: 10px 16px;
      font-size: 14px;
    }
    .transition-btn:hover {
      background: rgba(255,255,255,0.15);
      border-color: #e94560;
    }
    .transition-btn.active {
      background: rgba(233, 69, 96, 0.2);
      border-color: #e94560;
    }

    .info-box {
      background: rgba(78, 205, 196, 0.1);
      border-left: 4px solid #4ecdc4;
      padding: 15px;
      margin: 15px 0;
      border-radius: 0 8px 8px 0;
    }
    .info-box.tip {
      background: rgba(233, 69, 96, 0.1);
      border-left-color: #e94560;
    }

    #status {
      text-align: center;
      padding: 10px;
      color: #888;
      font-size: 14px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      margin: 10px 0;
    }

    .section-display {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
    }

    .section-box {
      width: 200px;
      height: 150px;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      font-weight: bold;
      transition: all 0.3s ease;
      border: 3px solid transparent;
    }

    .section-box.section-a {
      background: rgba(233, 69, 96, 0.2);
      color: #e94560;
    }
    .section-box.section-a.active {
      background: rgba(233, 69, 96, 0.4);
      border-color: #e94560;
      box-shadow: 0 0 30px rgba(233, 69, 96, 0.4);
    }

    .section-box.section-b {
      background: rgba(78, 205, 196, 0.2);
      color: #4ecdc4;
    }
    .section-box.section-b.active {
      background: rgba(78, 205, 196, 0.4);
      border-color: #4ecdc4;
      box-shadow: 0 0 30px rgba(78, 205, 196, 0.4);
    }

    .section-box.transitioning {
      animation: pulse 0.5s ease infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .section-label {
      font-size: 14px;
      margin-top: 10px;
      opacity: 0.7;
    }

    .arrow {
      display: flex;
      align-items: center;
      font-size: 32px;
      color: #888;
    }

    .transition-indicator {
      text-align: center;
      padding: 15px;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      margin: 15px 0;
      min-height: 60px;
    }

    .transition-name {
      font-size: 24px;
      color: #e94560;
      margin-bottom: 5px;
    }

    .transition-desc {
      color: #888;
      font-size: 14px;
    }

    .transition-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin: 15px 0;
    }

    .progress-bar {
      height: 8px;
      background: rgba(0,0,0,0.3);
      border-radius: 4px;
      margin: 15px 0;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #e94560, #4ecdc4);
      border-radius: 4px;
      transition: width 0.1s linear;
    }

    .visualizer {
      height: 100px;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      margin: 15px 0;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding: 10px;
      gap: 3px;
    }

    .viz-bar {
      width: 8px;
      background: #e94560;
      border-radius: 4px 4px 0 0;
      transition: height 0.1s ease;
    }

    .parameter-display {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin: 15px 0;
    }

    .param-box {
      background: rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .param-label {
      color: #888;
      font-size: 12px;
      margin-bottom: 5px;
    }

    .param-value {
      font-size: 24px;
      font-weight: bold;
      color: #e94560;
    }

    @media (max-width: 600px) {
      .section-display {
        flex-direction: column;
        align-items: center;
      }
      .arrow {
        transform: rotate(90deg);
      }
      .parameter-display {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Transitions</h1>
    <p class="subtitle">Smooth techniques for moving between sections in lofi</p>

    <div id="status">Click "Start Audio" to begin</div>

    <div class="section">
      <h2>1. Section Transition Demo</h2>
      <p>Watch and hear how different transition types connect Section A to Section B.</p>

      <div style="text-align: center; margin: 15px 0;">
        <button id="startAudio">Start Audio</button>
        <button id="stopAudio" disabled>Stop Audio</button>
      </div>

      <div class="section-display">
        <div class="section-box section-a" id="sectionABox">
          A
          <span class="section-label">Dm7 - G7</span>
        </div>
        <div class="arrow">&#8594;</div>
        <div class="section-box section-b" id="sectionBBox">
          B
          <span class="section-label">Fmaj7 - Em7</span>
        </div>
      </div>

      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>

      <div class="transition-indicator">
        <div class="transition-name" id="transitionName">Select a transition type</div>
        <div class="transition-desc" id="transitionDesc">Choose from the options below</div>
      </div>

      <h3>Transition Type</h3>
      <div class="control">
        <select id="transitionType">
          <option value="hardCut">Hard Cut (no transition)</option>
          <option value="filterSweep">Filter Sweep</option>
          <option value="drumFill">Drum Fill</option>
          <option value="dropout">Element Dropout</option>
          <option value="reverbTail">Reverb Tail</option>
        </select>
      </div>

      <div style="text-align: center; margin: 15px 0;">
        <button id="playSequence">Play A &#8594; Transition &#8594; B</button>
        <button id="resetDemo" class="secondary">Reset</button>
      </div>

      <div class="parameter-display">
        <div class="param-box">
          <div class="param-label">Filter Cutoff</div>
          <div class="param-value" id="filterValue">1500 Hz</div>
        </div>
        <div class="param-box">
          <div class="param-label">Reverb Wet</div>
          <div class="param-value" id="reverbValue">30%</div>
        </div>
        <div class="param-box">
          <div class="param-label">Drums</div>
          <div class="param-value" id="drumsValue">ON</div>
        </div>
      </div>

      <div class="info-box">
        <strong>What you're hearing:</strong> Section A uses a Dm7-G7 progression with a mellow filter.
        Section B brightens up with Fmaj7-Em7. The transition technique you select determines how
        smoothly we move between them.
      </div>
    </div>

    <div class="section">
      <h2>2. Trigger Individual Transitions</h2>
      <p>Click any button to hear that transition technique applied in real-time.</p>

      <div style="text-align: center; margin: 15px 0;">
        <button id="startContinuous" class="secondary">Start Continuous Playback</button>
        <button id="stopContinuous" class="secondary" disabled>Stop</button>
      </div>

      <div class="transition-grid">
        <button class="transition-btn" data-transition="filterSweepDown">Filter Sweep Down</button>
        <button class="transition-btn" data-transition="filterSweepUp">Filter Sweep Up</button>
        <button class="transition-btn" data-transition="drumFill">Drum Fill</button>
        <button class="transition-btn" data-transition="dropout">Drop Drums</button>
        <button class="transition-btn" data-transition="bringBack">Bring Drums Back</button>
        <button class="transition-btn" data-transition="reverbSwell">Reverb Swell</button>
        <button class="transition-btn" data-transition="reverbDry">Reverb Dry</button>
        <button class="transition-btn" data-transition="silence">Brief Silence</button>
      </div>

      <div class="visualizer" id="visualizer">
        <!-- Bars added by JS -->
      </div>

      <div class="info-box tip">
        <strong>Tip:</strong> In lofi, transitions should be subtle. Try the "Filter Sweep Down"
        followed by "Filter Sweep Up" - this classic move signals a section change without being dramatic.
      </div>
    </div>

    <div class="section">
      <h2>3. Transition Comparison</h2>
      <p>Hear the same section change with different transition styles.</p>

      <div class="controls">
        <div class="control">
          <label>Play the same transition with:</label>
          <div style="margin-top: 10px;">
            <button class="transition-btn" data-compare="hard">Hard Cut</button>
            <button class="transition-btn" data-compare="smooth">Smooth</button>
            <button class="transition-btn" data-compare="dramatic">Dramatic</button>
          </div>
        </div>
      </div>

      <div class="info-box">
        <strong>Hard Cut:</strong> Instant change - can feel jarring but works for intentional contrast.<br>
        <strong>Smooth:</strong> Filter sweep + slight reverb swell - the lofi standard.<br>
        <strong>Dramatic:</strong> Full dropout + filter + reverb - use sparingly.
      </div>
    </div>
  </div>

  <script>
    // Global state
    let audioStarted = false;
    let isPlaying = false;
    let continuousPlaying = false;
    let drumsEnabled = true;
    let currentSection = 'A';
    let sequencePlaying = false;

    // Audio nodes
    let synth = null;
    let drums = null;
    let filter = null;
    let reverb = null;
    let drumLoop = null;
    let chordLoop = null;
    let animationId = null;

    // Chords for sections
    const sectionAChords = [
      { time: '0:0:0', notes: ['D3', 'F3', 'A3', 'C4'] },  // Dm7
      { time: '0:2:0', notes: ['G3', 'B3', 'D4', 'F4'] }   // G7
    ];

    const sectionBChords = [
      { time: '0:0:0', notes: ['F3', 'A3', 'C4', 'E4'] },  // Fmaj7
      { time: '0:2:0', notes: ['E3', 'G3', 'B3', 'D4'] }   // Em7
    ];

    // Simple drum pattern
    const drumPattern = [
      { time: '0:0:0', note: 'kick' },
      { time: '0:1:0', note: 'hat' },
      { time: '0:1:2', note: 'snare' },
      { time: '0:2:0', note: 'kick' },
      { time: '0:2:2', note: 'hat' },
      { time: '0:3:0', note: 'hat' },
      { time: '0:3:2', note: 'snare' }
    ];

    // Transition descriptions
    const transitionDescriptions = {
      hardCut: { name: 'Hard Cut', desc: 'Instant change - no transition applied' },
      filterSweep: { name: 'Filter Sweep', desc: 'Low-pass filter sweeps down then back up' },
      drumFill: { name: 'Drum Fill', desc: 'Simple fill leads into the new section' },
      dropout: { name: 'Element Dropout', desc: 'Drums drop out, then return with impact' },
      reverbTail: { name: 'Reverb Tail', desc: 'Reverb swells, creating a wash effect' }
    };

    // Create visualizer bars
    const visualizer = document.getElementById('visualizer');
    for (let i = 0; i < 32; i++) {
      const bar = document.createElement('div');
      bar.className = 'viz-bar';
      bar.style.height = '10px';
      visualizer.appendChild(bar);
    }

    // Initialize audio
    async function initAudio() {
      await Tone.start();

      // Filter
      filter = new Tone.Filter({
        frequency: 1500,
        type: 'lowpass',
        rolloff: -12,
        Q: 1
      }).toDestination();

      // Reverb
      reverb = new Tone.Reverb(2.5);
      await reverb.generate();
      reverb.wet.value = 0.3;
      reverb.connect(Tone.Destination);

      // Rhodes-like synth
      synth = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: 'sine' },
        envelope: {
          attack: 0.05,
          decay: 0.3,
          sustain: 0.4,
          release: 1.5
        }
      });
      synth.volume.value = -10;
      synth.connect(filter);
      synth.connect(reverb);

      // Drum sampler (using synth as placeholder)
      drums = {
        kick: new Tone.MembraneSynth({
          pitchDecay: 0.05,
          octaves: 4,
          oscillator: { type: 'sine' },
          envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 0.5 }
        }),
        snare: new Tone.NoiseSynth({
          noise: { type: 'white' },
          envelope: { attack: 0.001, decay: 0.2, sustain: 0, release: 0.2 }
        }),
        hat: new Tone.MetalSynth({
          frequency: 200,
          envelope: { attack: 0.001, decay: 0.1, release: 0.01 },
          harmonicity: 5.1,
          modulationIndex: 32,
          resonance: 4000,
          octaves: 1.5
        })
      };

      drums.kick.volume.value = -8;
      drums.snare.volume.value = -15;
      drums.hat.volume.value = -20;

      drums.kick.connect(filter);
      drums.snare.connect(filter);
      drums.hat.connect(filter);

      audioStarted = true;
      updateStatus('Audio ready! Select a transition type and click "Play A -> Transition -> B"');
    }

    function updateStatus(msg) {
      document.getElementById('status').textContent = msg;
    }

    function updateSectionDisplay(section, transitioning = false) {
      const boxA = document.getElementById('sectionABox');
      const boxB = document.getElementById('sectionBBox');

      boxA.classList.remove('active', 'transitioning');
      boxB.classList.remove('active', 'transitioning');

      if (transitioning) {
        boxA.classList.add('transitioning');
        boxB.classList.add('transitioning');
      } else if (section === 'A') {
        boxA.classList.add('active');
      } else {
        boxB.classList.add('active');
      }
    }

    function updateParameterDisplay() {
      if (!filter) return;

      document.getElementById('filterValue').textContent =
        Math.round(filter.frequency.value) + ' Hz';
      document.getElementById('reverbValue').textContent =
        Math.round(reverb.wet.value * 100) + '%';
      document.getElementById('drumsValue').textContent =
        drumsEnabled ? 'ON' : 'OFF';
      document.getElementById('drumsValue').style.color =
        drumsEnabled ? '#4ecdc4' : '#e94560';
    }

    function updateVisualizerBars() {
      const bars = visualizer.querySelectorAll('.viz-bar');
      bars.forEach((bar, i) => {
        const height = isPlaying ? 10 + Math.random() * 70 : 10;
        const filterEffect = filter ? filter.frequency.value / 4000 : 0.5;
        bar.style.height = (height * filterEffect) + 'px';
        bar.style.background = currentSection === 'A' ? '#e94560' : '#4ecdc4';
      });
    }

    // Start/stop handlers
    document.getElementById('startAudio').addEventListener('click', async () => {
      if (!audioStarted) {
        await initAudio();
      }
      document.getElementById('startAudio').disabled = true;
      document.getElementById('stopAudio').disabled = false;
      updateStatus('Audio initialized. Ready to play!');
    });

    document.getElementById('stopAudio').addEventListener('click', () => {
      stopAllAudio();
      document.getElementById('startAudio').disabled = false;
      document.getElementById('stopAudio').disabled = true;
      updateStatus('Audio stopped.');
    });

    function stopAllAudio() {
      isPlaying = false;
      continuousPlaying = false;
      sequencePlaying = false;

      if (synth) synth.releaseAll();
      Tone.Transport.stop();
      Tone.Transport.cancel();

      if (animationId) {
        cancelAnimationFrame(animationId);
      }

      document.getElementById('startContinuous').disabled = false;
      document.getElementById('stopContinuous').disabled = true;

      updateSectionDisplay('A');
      document.getElementById('progressFill').style.width = '0%';
    }

    // Update transition description
    document.getElementById('transitionType').addEventListener('change', (e) => {
      const type = e.target.value;
      const info = transitionDescriptions[type];
      document.getElementById('transitionName').textContent = info.name;
      document.getElementById('transitionDesc').textContent = info.desc;
    });

    // Play sequence: A -> Transition -> B
    document.getElementById('playSequence').addEventListener('click', async () => {
      if (!audioStarted) {
        await initAudio();
        document.getElementById('startAudio').disabled = true;
        document.getElementById('stopAudio').disabled = false;
      }

      if (sequencePlaying) return;
      sequencePlaying = true;
      isPlaying = true;

      const transitionType = document.getElementById('transitionType').value;
      const info = transitionDescriptions[transitionType];

      updateStatus(`Playing Section A -> ${info.name} -> Section B`);

      // Reset state
      currentSection = 'A';
      drumsEnabled = true;
      filter.frequency.value = 1500;
      reverb.wet.value = 0.3;

      updateSectionDisplay('A');
      document.getElementById('progressFill').style.width = '0%';

      Tone.Transport.bpm.value = 80;
      Tone.Transport.cancel();

      // Section A: bars 0-3
      const chordPartA = new Tone.Part((time, chord) => {
        if (sequencePlaying) {
          synth.triggerAttackRelease(chord.notes, '2n', time);
        }
      }, sectionAChords);
      chordPartA.loop = true;
      chordPartA.loopEnd = '1m';

      // Drum part
      const drumPart = new Tone.Part((time, event) => {
        if (sequencePlaying && drumsEnabled) {
          if (event.note === 'kick') {
            drums.kick.triggerAttackRelease('C1', '8n', time);
          } else if (event.note === 'snare') {
            drums.snare.triggerAttackRelease('8n', time);
          } else if (event.note === 'hat') {
            drums.hat.triggerAttackRelease('C6', '32n', time);
          }
        }
      }, drumPattern);
      drumPart.loop = true;
      drumPart.loopEnd = '1m';

      // Start parts
      chordPartA.start(0);
      drumPart.start(0);

      // Schedule transition at bar 4
      Tone.Transport.schedule((time) => {
        updateSectionDisplay('A', true);
        applyTransition(transitionType, time);
      }, '4:0:0');

      // Section B starts at bar 5
      Tone.Transport.schedule((time) => {
        currentSection = 'B';
        updateSectionDisplay('B');
        chordPartA.stop();

        // Start Section B chords
        const chordPartB = new Tone.Part((t, chord) => {
          if (sequencePlaying) {
            synth.triggerAttackRelease(chord.notes, '2n', t);
          }
        }, sectionBChords);
        chordPartB.loop = true;
        chordPartB.loopEnd = '1m';
        chordPartB.start(time);

        // Reset filter after transition
        if (transitionType === 'filterSweep') {
          filter.frequency.cancelScheduledValues(time);
          filter.frequency.setValueAtTime(400, time);
          filter.frequency.exponentialRampTo(2000, 0.3, time);
        }

        // Bring drums back after dropout
        if (transitionType === 'dropout') {
          drumsEnabled = true;
          // Impact hit
          drums.kick.triggerAttackRelease('C1', '4n', time);
          drums.snare.triggerAttackRelease('8n', time + 0.01);
        }

        // Reset reverb after tail
        if (transitionType === 'reverbTail') {
          reverb.wet.cancelScheduledValues(time);
          reverb.wet.setValueAtTime(0.7, time);
          reverb.wet.rampTo(0.35, 0.5, time);
        }
      }, '5:0:0');

      // End sequence at bar 9
      Tone.Transport.schedule((time) => {
        sequencePlaying = false;
        isPlaying = false;
        synth.releaseAll();
        Tone.Transport.stop();
        updateStatus('Sequence complete. Try another transition!');
        document.getElementById('progressFill').style.width = '100%';
      }, '9:0:0');

      // Progress animation
      const totalBars = 9;
      const startTime = Tone.now();
      const barDuration = (60 / 80) * 4; // seconds per bar
      const totalDuration = totalBars * barDuration;

      function updateProgress() {
        if (!sequencePlaying) return;

        const elapsed = Tone.now() - startTime;
        const progress = Math.min(elapsed / totalDuration * 100, 100);
        document.getElementById('progressFill').style.width = progress + '%';

        updateParameterDisplay();
        updateVisualizerBars();

        if (sequencePlaying) {
          animationId = requestAnimationFrame(updateProgress);
        }
      }

      Tone.Transport.start();
      updateProgress();
    });

    function applyTransition(type, time) {
      switch (type) {
        case 'hardCut':
          // No transition - instant change
          break;

        case 'filterSweep':
          filter.frequency.cancelScheduledValues(time);
          filter.frequency.setValueAtTime(1500, time);
          filter.frequency.exponentialRampTo(400, 2, time);
          break;

        case 'drumFill':
          // Simple fill
          drums.snare.triggerAttackRelease('16n', time);
          drums.snare.triggerAttackRelease('16n', time + 0.15);
          drums.snare.triggerAttackRelease('16n', time + 0.3);
          drums.kick.triggerAttackRelease('C1', '8n', time + 0.45);
          break;

        case 'dropout':
          drumsEnabled = false;
          filter.frequency.cancelScheduledValues(time);
          filter.frequency.setValueAtTime(1500, time);
          filter.frequency.exponentialRampTo(800, 1, time);
          break;

        case 'reverbTail':
          reverb.wet.cancelScheduledValues(time);
          reverb.wet.setValueAtTime(0.3, time);
          reverb.wet.rampTo(0.8, 1.5, time);
          synth.volume.rampTo(-15, 1, time);
          setTimeout(() => {
            if (sequencePlaying) synth.volume.rampTo(-10, 0.5);
          }, 2000);
          break;
      }
    }

    // Reset demo
    document.getElementById('resetDemo').addEventListener('click', () => {
      stopAllAudio();
      if (filter) {
        filter.frequency.cancelScheduledValues(Tone.now());
        filter.frequency.value = 1500;
      }
      if (reverb) {
        reverb.wet.cancelScheduledValues(Tone.now());
        reverb.wet.value = 0.3;
      }
      drumsEnabled = true;
      currentSection = 'A';
      updateParameterDisplay();
      updateSectionDisplay('A');
      document.getElementById('progressFill').style.width = '0%';
      updateStatus('Demo reset. Ready to play!');
    });

    // Continuous playback for individual transitions
    document.getElementById('startContinuous').addEventListener('click', async () => {
      if (!audioStarted) {
        await initAudio();
        document.getElementById('startAudio').disabled = true;
        document.getElementById('stopAudio').disabled = false;
      }

      if (continuousPlaying) return;
      continuousPlaying = true;
      isPlaying = true;

      drumsEnabled = true;
      currentSection = 'A';
      filter.frequency.value = 1500;
      reverb.wet.value = 0.3;

      updateSectionDisplay('A');
      updateStatus('Playing continuously. Click transition buttons to hear effects.');

      document.getElementById('startContinuous').disabled = true;
      document.getElementById('stopContinuous').disabled = false;

      Tone.Transport.bpm.value = 80;
      Tone.Transport.cancel();

      // Chord part
      const chordPart = new Tone.Part((time, chord) => {
        if (continuousPlaying) {
          synth.triggerAttackRelease(chord.notes, '2n', time);
        }
      }, currentSection === 'A' ? sectionAChords : sectionBChords);
      chordPart.loop = true;
      chordPart.loopEnd = '1m';

      // Drum part
      const drumPart = new Tone.Part((time, event) => {
        if (continuousPlaying && drumsEnabled) {
          if (event.note === 'kick') {
            drums.kick.triggerAttackRelease('C1', '8n', time);
          } else if (event.note === 'snare') {
            drums.snare.triggerAttackRelease('8n', time);
          } else if (event.note === 'hat') {
            drums.hat.triggerAttackRelease('C6', '32n', time);
          }
        }
      }, drumPattern);
      drumPart.loop = true;
      drumPart.loopEnd = '1m';

      chordPart.start(0);
      drumPart.start(0);

      function updateContinuous() {
        if (!continuousPlaying) return;
        updateParameterDisplay();
        updateVisualizerBars();
        animationId = requestAnimationFrame(updateContinuous);
      }

      Tone.Transport.start();
      updateContinuous();
    });

    document.getElementById('stopContinuous').addEventListener('click', () => {
      continuousPlaying = false;
      isPlaying = false;
      synth.releaseAll();
      Tone.Transport.stop();
      Tone.Transport.cancel();

      document.getElementById('startContinuous').disabled = false;
      document.getElementById('stopContinuous').disabled = true;
      updateStatus('Stopped.');
    });

    // Individual transition buttons
    document.querySelectorAll('.transition-btn[data-transition]').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!audioStarted) {
          await initAudio();
          document.getElementById('startAudio').disabled = true;
          document.getElementById('stopAudio').disabled = false;
        }

        const transition = btn.dataset.transition;
        const now = Tone.now();

        switch (transition) {
          case 'filterSweepDown':
            filter.frequency.cancelScheduledValues(now);
            filter.frequency.exponentialRampTo(400, 1.5);
            updateStatus('Filter sweeping down...');
            break;

          case 'filterSweepUp':
            filter.frequency.cancelScheduledValues(now);
            filter.frequency.exponentialRampTo(3000, 1);
            updateStatus('Filter sweeping up...');
            break;

          case 'drumFill':
            drums.snare.triggerAttackRelease('16n', now);
            drums.snare.triggerAttackRelease('16n', now + 0.12);
            drums.snare.triggerAttackRelease('16n', now + 0.24);
            drums.kick.triggerAttackRelease('C1', '8n', now + 0.36);
            updateStatus('Drum fill!');
            break;

          case 'dropout':
            drumsEnabled = false;
            updateStatus('Drums dropped out');
            break;

          case 'bringBack':
            drumsEnabled = true;
            drums.kick.triggerAttackRelease('C1', '4n', now);
            drums.snare.triggerAttackRelease('8n', now + 0.02);
            updateStatus('Drums back with impact!');
            break;

          case 'reverbSwell':
            reverb.wet.cancelScheduledValues(now);
            reverb.wet.rampTo(0.8, 1.5);
            updateStatus('Reverb swelling...');
            break;

          case 'reverbDry':
            reverb.wet.cancelScheduledValues(now);
            reverb.wet.rampTo(0.15, 0.5);
            updateStatus('Pulling reverb back...');
            break;

          case 'silence':
            if (continuousPlaying) {
              const wasEnabled = drumsEnabled;
              drumsEnabled = false;
              synth.releaseAll();
              updateStatus('Brief silence...');
              setTimeout(() => {
                if (continuousPlaying) {
                  drumsEnabled = wasEnabled;
                  synth.triggerAttack(['D3', 'F3', 'A3', 'C4']);
                  updateStatus('Back!');
                }
              }, 800);
            }
            break;
        }

        updateParameterDisplay();
      });
    });

    // Comparison buttons
    document.querySelectorAll('.transition-btn[data-compare]').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!audioStarted) {
          await initAudio();
          document.getElementById('startAudio').disabled = true;
          document.getElementById('stopAudio').disabled = false;
        }

        const style = btn.dataset.compare;

        // Stop any existing playback
        Tone.Transport.stop();
        Tone.Transport.cancel();
        synth.releaseAll();

        isPlaying = true;
        currentSection = 'A';
        drumsEnabled = true;
        filter.frequency.value = 1500;
        reverb.wet.value = 0.3;

        updateSectionDisplay('A');
        updateStatus(`Playing ${style} transition comparison...`);

        Tone.Transport.bpm.value = 80;

        // Section A chord
        Tone.Transport.schedule((time) => {
          synth.triggerAttackRelease(['D3', 'F3', 'A3', 'C4'], '1m', time);
        }, '0:0:0');

        // Apply transition at bar 2 based on style
        Tone.Transport.schedule((time) => {
          updateSectionDisplay('A', true);

          if (style === 'hard') {
            // No transition
          } else if (style === 'smooth') {
            filter.frequency.cancelScheduledValues(time);
            filter.frequency.setValueAtTime(1500, time);
            filter.frequency.exponentialRampTo(600, 1, time);
            reverb.wet.rampTo(0.5, 0.5, time);
          } else if (style === 'dramatic') {
            drumsEnabled = false;
            filter.frequency.cancelScheduledValues(time);
            filter.frequency.setValueAtTime(1500, time);
            filter.frequency.exponentialRampTo(300, 1.5, time);
            reverb.wet.rampTo(0.8, 1, time);
            synth.volume.rampTo(-18, 1, time);
          }
        }, '2:0:0');

        // Section B at bar 3
        Tone.Transport.schedule((time) => {
          currentSection = 'B';
          updateSectionDisplay('B');

          if (style === 'smooth') {
            filter.frequency.cancelScheduledValues(time);
            filter.frequency.setValueAtTime(600, time);
            filter.frequency.exponentialRampTo(1800, 0.3, time);
            reverb.wet.rampTo(0.35, 0.3, time);
          } else if (style === 'dramatic') {
            drumsEnabled = true;
            drums.kick.triggerAttackRelease('C1', '4n', time);
            drums.snare.triggerAttackRelease('8n', time + 0.02);
            filter.frequency.cancelScheduledValues(time);
            filter.frequency.setValueAtTime(400, time);
            filter.frequency.exponentialRampTo(2000, 0.2, time);
            reverb.wet.setValueAtTime(0.3, time);
            synth.volume.setValueAtTime(-10, time);
          }

          synth.triggerAttackRelease(['F3', 'A3', 'C4', 'E4'], '1m', time);
        }, '3:0:0');

        // End
        Tone.Transport.schedule((time) => {
          isPlaying = false;
          synth.releaseAll();
          Tone.Transport.stop();
          updateStatus(`${style.charAt(0).toUpperCase() + style.slice(1)} transition complete!`);
        }, '5:0:0');

        function updateCompare() {
          if (!isPlaying) return;
          updateParameterDisplay();
          updateVisualizerBars();
          animationId = requestAnimationFrame(updateCompare);
        }

        Tone.Transport.start();
        updateCompare();
      });
    });

    // Initialize display
    updateSectionDisplay('A');
    const initInfo = transitionDescriptions['hardCut'];
    document.getElementById('transitionName').textContent = initInfo.name;
    document.getElementById('transitionDesc').textContent = initInfo.desc;

    // Cleanup
    window.addEventListener('beforeunload', () => {
      stopAllAudio();
    });
  </script>
</body>
</html>
