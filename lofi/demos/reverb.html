<!DOCTYPE html>
<html>
<head>
  <title>Reverb - Demo</title>
  <script src="https://unpkg.com/tone@14"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #eee;
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .container { max-width: 900px; margin: 0 auto; }
    h1 { color: #e94560; margin-bottom: 10px; }
    h2 { color: #4ecdc4; margin-top: 30px; }
    .subtitle { color: #888; margin-bottom: 30px; }

    .section {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }

    .control {
      background: rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 8px;
    }
    .control label {
      display: block;
      color: #888;
      font-size: 12px;
      margin-bottom: 5px;
    }
    .control .value {
      color: #e94560;
      font-weight: bold;
      float: right;
    }
    .control input[type="range"] {
      width: 100%;
      margin-top: 5px;
      accent-color: #e94560;
    }

    button {
      background: #e94560;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 8px;
      margin: 5px;
      transition: transform 0.1s, background 0.2s;
    }
    button:hover { background: #ff6b6b; transform: scale(1.02); }
    button:active { transform: scale(0.98); }
    button:disabled { background: #444; cursor: not-allowed; transform: none; }
    button.secondary {
      background: #4ecdc4;
    }
    button.secondary:hover { background: #6ee7df; }
    button.active {
      background: #6ee7df;
      color: #1a1a2e;
    }

    #status {
      text-align: center;
      padding: 10px;
      color: #888;
      font-size: 14px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      margin: 10px 0;
    }

    .loading {
      color: #ffd700;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .comparison {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .comparison-box {
      background: rgba(0,0,0,0.2);
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .comparison-box h3 {
      color: #888;
      margin-top: 0;
      margin-bottom: 15px;
    }
    .comparison-box.active h3 { color: #e94560; }
    .comparison-box.wet.active h3 { color: #4ecdc4; }

    .info-box {
      background: rgba(78, 205, 196, 0.1);
      border-left: 4px solid #4ecdc4;
      padding: 15px;
      margin: 15px 0;
      border-radius: 0 8px 8px 0;
    }
    .info-box.warning {
      background: rgba(233, 69, 96, 0.1);
      border-left-color: #e94560;
    }
    .info-box.tip {
      background: rgba(255, 215, 0, 0.1);
      border-left-color: #ffd700;
    }

    .reverb-visual {
      height: 120px;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      margin: 15px 0;
      position: relative;
      overflow: hidden;
    }
    .reverb-wave {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 100%;
      display: flex;
      align-items: flex-end;
      justify-content: flex-start;
      padding: 10px;
    }
    .reverb-bar {
      width: 4px;
      margin: 0 1px;
      background: linear-gradient(to top, #e94560, #4ecdc4);
      border-radius: 2px;
      opacity: 0.8;
      transition: height 0.05s ease-out;
    }
    .reverb-label {
      position: absolute;
      bottom: 10px;
      right: 10px;
      color: #888;
      font-size: 12px;
    }
    .reverb-timeline {
      position: absolute;
      bottom: 5px;
      left: 10px;
      right: 70px;
      display: flex;
      justify-content: space-between;
      color: #555;
      font-size: 10px;
    }

    .toggle-group {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 15px 0;
    }
    .toggle-btn {
      padding: 10px 30px;
      border: 2px solid #4ecdc4;
      background: transparent;
      color: #4ecdc4;
    }
    .toggle-btn:hover {
      background: rgba(78, 205, 196, 0.1);
    }
    .toggle-btn.active {
      background: #4ecdc4;
      color: #1a1a2e;
    }

    .keyboard {
      display: flex;
      gap: 5px;
      margin: 15px 0;
      flex-wrap: wrap;
      justify-content: center;
    }
    .key {
      background: #4ecdc4;
      color: #1a1a2e;
      border: none;
      padding: 20px 15px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.1s;
      min-width: 45px;
    }
    .key:hover { background: #6ee7df; transform: translateY(-2px); }
    .key:active { transform: translateY(0); }
    .key:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .chord-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin: 15px 0;
    }
    .chord-btn {
      background: rgba(78, 205, 196, 0.2);
      border: 1px solid #4ecdc4;
      color: #4ecdc4;
      padding: 15px 25px;
      font-size: 14px;
    }
    .chord-btn:hover {
      background: rgba(78, 205, 196, 0.3);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Reverb</h1>
    <p class="subtitle">Simulating acoustic spaces and creating atmosphere</p>

    <div id="status" class="loading">Initializing reverb... Please wait.</div>

    <div class="section">
      <h2>1. A/B Comparison: Dry vs Wet</h2>
      <p>Toggle between the dry (original) signal and the wet (reverbed) signal to hear the difference.</p>

      <div class="toggle-group">
        <button class="toggle-btn active" id="dryBtn">Dry (No Reverb)</button>
        <button class="toggle-btn" id="wetBtn">Wet (With Reverb)</button>
      </div>

      <div class="comparison">
        <div class="comparison-box active" id="dryBox">
          <h3>Dry Signal</h3>
          <p style="color: #666; font-size: 13px;">Original, unprocessed sound. Direct and present.</p>
        </div>
        <div class="comparison-box wet" id="wetBox">
          <h3>Wet Signal</h3>
          <p style="color: #666; font-size: 13px;">Reverb adds space and depth. Sounds like a room.</p>
        </div>
      </div>

      <div class="chord-buttons">
        <button class="chord-btn" id="playChord1" disabled>Cmaj7</button>
        <button class="chord-btn" id="playChord2" disabled>Am7</button>
        <button class="chord-btn" id="playChord3" disabled>Fmaj7</button>
        <button class="chord-btn" id="playMelody" disabled>Play Melody</button>
      </div>

      <div class="info-box">
        <strong>Listen for:</strong> When reverb is on, notice how the sound lingers and decays gradually.
        The dry signal stops abruptly, while the wet signal blooms into a tail that fades naturally.
      </div>
    </div>

    <div class="section">
      <h2>2. Reverb Parameters</h2>
      <p>Adjust decay time and wet/dry mix to shape the reverb character.</p>

      <div class="reverb-visual">
        <div class="reverb-wave" id="reverbWave"></div>
        <div class="reverb-label" id="decayLabel">Decay: 2.5s</div>
        <div class="reverb-timeline">
          <span>0s</span>
          <span>1s</span>
          <span>2s</span>
          <span>3s</span>
          <span>4s</span>
        </div>
      </div>

      <div class="controls">
        <div class="control">
          <label>Decay Time <span class="value" id="decayVal">2.5s</span></label>
          <input type="range" id="decay" min="0.5" max="6" step="0.1" value="2.5">
        </div>
        <div class="control">
          <label>Wet Mix <span class="value" id="wetVal">40%</span></label>
          <input type="range" id="wet" min="0" max="1" step="0.05" value="0.4">
        </div>
        <div class="control">
          <label>Pre-delay <span class="value" id="predelayVal">20ms</span></label>
          <input type="range" id="predelay" min="0" max="0.1" step="0.005" value="0.02">
        </div>
      </div>

      <div style="text-align: center; margin: 15px 0;">
        <button id="playTestTone" disabled>Play Test Chord</button>
        <button id="applyChanges" class="secondary" disabled>Apply Decay Change</button>
      </div>

      <div class="info-box warning">
        <strong>Important:</strong> Changing the decay time requires regenerating the reverb impulse response.
        Click "Apply Decay Change" after adjusting decay. The wet mix updates instantly.
      </div>
    </div>

    <div class="section">
      <h2>3. Lofi Presets</h2>
      <p>Common reverb settings used in lofi production.</p>

      <div class="chord-buttons">
        <button class="chord-btn" id="presetSmall">Small Room</button>
        <button class="chord-btn" id="presetMedium">Medium Hall</button>
        <button class="chord-btn" id="presetLarge">Large Hall</button>
        <button class="chord-btn" id="presetLofi">Classic Lofi</button>
        <button class="chord-btn" id="presetAmbient">Ambient Wash</button>
      </div>

      <div id="presetInfo" class="info-box tip" style="display: none;"></div>
    </div>

    <div class="section">
      <h2>4. Play with Reverb</h2>
      <p>Use your keyboard or click the keys to play notes through the reverb.</p>

      <div class="keyboard" id="keyboard">
        <button class="key" data-note="C4" disabled>C<br><small>A</small></button>
        <button class="key" data-note="D4" disabled>D<br><small>S</small></button>
        <button class="key" data-note="E4" disabled>E<br><small>D</small></button>
        <button class="key" data-note="F4" disabled>F<br><small>F</small></button>
        <button class="key" data-note="G4" disabled>G<br><small>G</small></button>
        <button class="key" data-note="A4" disabled>A<br><small>H</small></button>
        <button class="key" data-note="B4" disabled>B<br><small>J</small></button>
        <button class="key" data-note="C5" disabled>C<br><small>K</small></button>
      </div>

      <div style="text-align: center; color: #666; font-size: 12px; margin-top: 10px;">
        Use keyboard keys A-K to play notes
      </div>
    </div>
  </div>

  <script>
    // Global state
    let synth = null;
    let reverb = null;
    let isWetMode = false;
    let isReady = false;
    let visualBars = [];

    // Status updates
    function updateStatus(msg, isLoading = false) {
      const status = document.getElementById('status');
      status.textContent = msg;
      status.className = isLoading ? 'loading' : '';
    }

    // Initialize reverb visual
    function initReverbVisual() {
      const wave = document.getElementById('reverbWave');
      wave.innerHTML = '';
      visualBars = [];

      // Create 80 bars for visualization
      for (let i = 0; i < 80; i++) {
        const bar = document.createElement('div');
        bar.className = 'reverb-bar';
        bar.style.height = '5px';
        wave.appendChild(bar);
        visualBars.push(bar);
      }
    }

    // Animate reverb decay visualization
    function animateReverbDecay() {
      const decay = parseFloat(document.getElementById('decay').value);
      const totalDuration = decay * 1000; // Convert to ms
      const barCount = visualBars.length;

      // Initial burst
      visualBars.forEach((bar, i) => {
        const initialHeight = Math.random() * 80 + 20;
        bar.style.height = initialHeight + 'px';
      });

      // Decay animation
      const startTime = Date.now();

      function animate() {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / totalDuration, 1);

        visualBars.forEach((bar, i) => {
          // Exponential decay with some randomness
          const decayFactor = Math.exp(-3 * progress);
          const noise = 0.7 + Math.random() * 0.3;
          const height = Math.max(5, 100 * decayFactor * noise * (1 - i / barCount * 0.3));
          bar.style.height = height + 'px';
        });

        if (progress < 1) {
          requestAnimationFrame(animate);
        } else {
          // Reset to baseline
          visualBars.forEach(bar => bar.style.height = '5px');
        }
      }

      animate();
    }

    // Initialize audio
    async function initAudio() {
      updateStatus('Creating reverb (this may take a moment)...', true);

      try {
        // Create synth
        synth = new Tone.PolySynth(Tone.Synth, {
          oscillator: { type: 'triangle' },
          envelope: {
            attack: 0.02,
            decay: 0.3,
            sustain: 0.4,
            release: 1.5
          }
        });
        synth.volume.value = -6;

        // Create reverb with lofi-appropriate settings
        reverb = new Tone.Reverb({
          decay: 2.5,
          preDelay: 0.02,
          wet: 0.4
        });

        // IMPORTANT: Must await generate() before using reverb
        await reverb.generate();

        // Connect synth -> reverb -> destination
        synth.connect(reverb);
        reverb.toDestination();

        // Initially set to dry mode
        reverb.wet.value = 0;

        isReady = true;
        enableAllButtons();
        updateStatus('Ready! Toggle between Dry and Wet to hear the difference.');

      } catch (err) {
        updateStatus('Error initializing audio: ' + err.message);
        console.error(err);
      }
    }

    // Enable all buttons once ready
    function enableAllButtons() {
      document.querySelectorAll('button:disabled').forEach(btn => {
        btn.disabled = false;
      });
    }

    // Play a chord
    async function playChord(notes) {
      await Tone.start();
      if (isReady) {
        synth.triggerAttackRelease(notes, '2n');
        animateReverbDecay();
      }
    }

    // Play a melody
    async function playMelody() {
      await Tone.start();
      if (!isReady) return;

      const notes = ['E4', 'G4', 'A4', 'B4', 'A4', 'G4', 'E4'];
      const now = Tone.now();

      notes.forEach((note, i) => {
        synth.triggerAttackRelease(note, '8n', now + i * 0.25);
      });
      animateReverbDecay();
    }

    // Toggle dry/wet mode
    function setWetMode(wet) {
      isWetMode = wet;

      if (reverb) {
        reverb.wet.value = wet ? parseFloat(document.getElementById('wet').value) : 0;
      }

      // Update UI
      document.getElementById('dryBtn').classList.toggle('active', !wet);
      document.getElementById('wetBtn').classList.toggle('active', wet);
      document.getElementById('dryBox').classList.toggle('active', !wet);
      document.getElementById('wetBox').classList.toggle('active', wet);
    }

    // Apply preset
    async function applyPreset(name, settings, description) {
      document.getElementById('decay').value = settings.decay;
      document.getElementById('decayVal').textContent = settings.decay + 's';
      document.getElementById('wet').value = settings.wet;
      document.getElementById('wetVal').textContent = Math.round(settings.wet * 100) + '%';
      document.getElementById('predelay').value = settings.predelay;
      document.getElementById('predelayVal').textContent = Math.round(settings.predelay * 1000) + 'ms';
      document.getElementById('decayLabel').textContent = 'Decay: ' + settings.decay + 's';

      // Show preset info
      const info = document.getElementById('presetInfo');
      info.innerHTML = `<strong>${name}:</strong> ${description}`;
      info.style.display = 'block';

      // Apply changes
      if (reverb) {
        updateStatus('Regenerating reverb for new decay...', true);
        reverb.decay = settings.decay;
        reverb.preDelay = settings.predelay;
        await reverb.generate();

        if (isWetMode) {
          reverb.wet.value = settings.wet;
        }
        updateStatus('Preset applied! Play something to hear it.');
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      // A/B toggle
      document.getElementById('dryBtn').addEventListener('click', () => setWetMode(false));
      document.getElementById('wetBtn').addEventListener('click', () => setWetMode(true));

      // Chord buttons
      document.getElementById('playChord1').addEventListener('click', () =>
        playChord(['C4', 'E4', 'G4', 'B4']));
      document.getElementById('playChord2').addEventListener('click', () =>
        playChord(['A3', 'C4', 'E4', 'G4']));
      document.getElementById('playChord3').addEventListener('click', () =>
        playChord(['F3', 'A3', 'C4', 'E4']));
      document.getElementById('playMelody').addEventListener('click', playMelody);

      // Parameter controls
      document.getElementById('decay').addEventListener('input', (e) => {
        const val = parseFloat(e.target.value);
        document.getElementById('decayVal').textContent = val.toFixed(1) + 's';
        document.getElementById('decayLabel').textContent = 'Decay: ' + val.toFixed(1) + 's';
      });

      document.getElementById('wet').addEventListener('input', (e) => {
        const val = parseFloat(e.target.value);
        document.getElementById('wetVal').textContent = Math.round(val * 100) + '%';
        if (reverb && isWetMode) {
          reverb.wet.value = val;
        }
      });

      document.getElementById('predelay').addEventListener('input', (e) => {
        const val = parseFloat(e.target.value);
        document.getElementById('predelayVal').textContent = Math.round(val * 1000) + 'ms';
        if (reverb) {
          reverb.preDelay = val;
        }
      });

      // Apply decay change button
      document.getElementById('applyChanges').addEventListener('click', async () => {
        if (!reverb) return;

        updateStatus('Regenerating reverb impulse response...', true);
        const decay = parseFloat(document.getElementById('decay').value);
        reverb.decay = decay;
        await reverb.generate();
        updateStatus('Decay updated! Play something to hear the change.');
      });

      // Test tone button
      document.getElementById('playTestTone').addEventListener('click', () =>
        playChord(['C4', 'E4', 'G4', 'B4']));

      // Presets
      document.getElementById('presetSmall').addEventListener('click', () =>
        applyPreset('Small Room', { decay: 0.8, wet: 0.2, predelay: 0.01 },
          'Intimate, close sound. Good for keeping things punchy.'));

      document.getElementById('presetMedium').addEventListener('click', () =>
        applyPreset('Medium Hall', { decay: 2, wet: 0.35, predelay: 0.02 },
          'Natural room sound. Versatile for most uses.'));

      document.getElementById('presetLarge').addEventListener('click', () =>
        applyPreset('Large Hall', { decay: 4, wet: 0.45, predelay: 0.03 },
          'Spacious, cathedral-like. Dramatic and immersive.'));

      document.getElementById('presetLofi').addEventListener('click', () =>
        applyPreset('Classic Lofi', { decay: 2.5, wet: 0.4, predelay: 0.02 },
          'The sweet spot for lofi. Warm, dreamy, not too washed out.'));

      document.getElementById('presetAmbient').addEventListener('click', () =>
        applyPreset('Ambient Wash', { decay: 5.5, wet: 0.7, predelay: 0.04 },
          'Long, lush tails. Sound becomes texture.'));

      // Keyboard keys
      document.querySelectorAll('#keyboard .key').forEach(key => {
        key.addEventListener('click', async () => {
          await Tone.start();
          if (isReady) {
            synth.triggerAttackRelease(key.dataset.note, '4n');
            animateReverbDecay();
          }
        });
      });

      // Computer keyboard mapping
      const keyMap = {
        'a': 'C4', 's': 'D4', 'd': 'E4', 'f': 'F4',
        'g': 'G4', 'h': 'A4', 'j': 'B4', 'k': 'C5'
      };

      document.addEventListener('keydown', async (e) => {
        const note = keyMap[e.key.toLowerCase()];
        if (note && isReady) {
          await Tone.start();
          synth.triggerAttackRelease(note, '4n');
          animateReverbDecay();

          // Highlight key
          const keyEl = document.querySelector(`[data-note="${note}"]`);
          if (keyEl) {
            keyEl.style.transform = 'translateY(0)';
            keyEl.style.background = '#6ee7df';
            setTimeout(() => {
              keyEl.style.transform = '';
              keyEl.style.background = '';
            }, 150);
          }
        }
      });
    }

    // Initialize
    async function init() {
      initReverbVisual();
      setupEventListeners();
      await initAudio();
    }

    init();
  </script>
</body>
</html>
