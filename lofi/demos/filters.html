<!DOCTYPE html>
<html>
<head>
  <title>Filters - Demo</title>
  <script src="https://unpkg.com/tone@14"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #eee;
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .container { max-width: 900px; margin: 0 auto; }
    h1 { color: #e94560; margin-bottom: 10px; }
    h2 { color: #4ecdc4; margin-top: 30px; }
    .subtitle { color: #888; margin-bottom: 30px; }

    .section {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }

    .control {
      background: rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 8px;
    }
    .control label {
      display: block;
      color: #888;
      font-size: 12px;
      margin-bottom: 5px;
    }
    .control .value {
      color: #e94560;
      font-weight: bold;
      float: right;
    }
    .control input[type="range"] {
      width: 100%;
      margin-top: 5px;
    }
    .control select {
      width: 100%;
      padding: 8px;
      background: #2a2a4e;
      color: #eee;
      border: 1px solid #444;
      border-radius: 4px;
    }

    button {
      background: #e94560;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 8px;
      margin: 5px;
      transition: transform 0.1s, background 0.2s;
    }
    button:hover { background: #ff6b6b; transform: scale(1.02); }
    button:active { transform: scale(0.98); }
    button:disabled { background: #444; cursor: not-allowed; transform: none; }
    button.secondary {
      background: #4ecdc4;
    }
    button.secondary:hover { background: #6ee7df; }
    button.active {
      background: #4ecdc4;
      box-shadow: 0 0 15px rgba(78, 205, 196, 0.5);
    }

    .spectrum-container {
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }
    #spectrum {
      width: 100%;
      height: 200px;
      background: rgba(0,0,0,0.5);
      border-radius: 8px;
    }
    .spectrum-labels {
      display: flex;
      justify-content: space-between;
      color: #666;
      font-size: 11px;
      margin-top: 5px;
    }

    .info-box {
      background: rgba(78, 205, 196, 0.1);
      border-left: 4px solid #4ecdc4;
      padding: 15px;
      margin: 15px 0;
      border-radius: 0 8px 8px 0;
    }
    .info-box.tip {
      background: rgba(233, 69, 96, 0.1);
      border-left-color: #e94560;
    }

    .filter-type-selector {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 15px 0;
    }
    .filter-type-btn {
      background: rgba(255,255,255,0.1);
      border: 2px solid #444;
      padding: 10px 20px;
      color: #888;
    }
    .filter-type-btn.active {
      background: rgba(233, 69, 96, 0.2);
      border-color: #e94560;
      color: #e94560;
    }
    .filter-type-btn:hover {
      border-color: #666;
      transform: none;
    }

    .sound-selector {
      display: flex;
      gap: 10px;
      margin: 15px 0;
    }

    .cutoff-indicator {
      position: relative;
      height: 30px;
      background: linear-gradient(to right, #e94560, #4ecdc4);
      border-radius: 4px;
      margin: 10px 0;
    }
    .cutoff-line {
      position: absolute;
      top: 0;
      width: 3px;
      height: 100%;
      background: white;
      box-shadow: 0 0 10px white;
      transition: left 0.1s;
    }
    .cutoff-label {
      position: absolute;
      top: -20px;
      transform: translateX(-50%);
      color: white;
      font-size: 12px;
      font-weight: bold;
    }

    .comparison {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .comparison-box {
      background: rgba(0,0,0,0.2);
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .comparison-box h3 {
      color: #e94560;
      margin-top: 0;
      margin-bottom: 15px;
    }
    .comparison-box.filtered h3 { color: #4ecdc4; }

    #status {
      text-align: center;
      padding: 10px;
      color: #888;
      font-size: 14px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      margin: 10px 0;
    }

    .preset-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid #444;
      padding: 8px 16px;
      font-size: 14px;
    }
    .preset-btn:hover {
      background: rgba(255,255,255,0.15);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Filters</h1>
    <p class="subtitle">Shape your sound by removing or boosting frequencies</p>

    <div id="status">Click "Start Audio" to begin</div>

    <div class="section">
      <h2>1. Interactive Filter</h2>
      <p>Hear how different filter types and parameters affect the sound in real-time.</p>

      <div style="text-align: center; margin: 15px 0;">
        <button id="startAudio">Start Audio</button>
        <button id="stopAudio" disabled>Stop Audio</button>
      </div>

      <h3 style="color: #888; margin-bottom: 10px;">Filter Type</h3>
      <div class="filter-type-selector">
        <button class="filter-type-btn active" data-type="lowpass">Lowpass</button>
        <button class="filter-type-btn" data-type="highpass">Highpass</button>
        <button class="filter-type-btn" data-type="bandpass">Bandpass</button>
      </div>

      <h3 style="color: #888; margin-bottom: 10px;">Sound Source</h3>
      <div class="sound-selector">
        <button class="secondary active" id="soundNoise" data-sound="noise">Pink Noise</button>
        <button class="secondary" id="soundSaw" data-sound="saw">Sawtooth Wave</button>
        <button class="secondary" id="soundChord" data-sound="chord">Chord</button>
      </div>

      <div class="controls">
        <div class="control">
          <label>Cutoff Frequency <span class="value" id="freqVal">1500 Hz</span></label>
          <input type="range" id="frequency" min="100" max="8000" step="10" value="1500">
        </div>
        <div class="control">
          <label>Q (Resonance) <span class="value" id="qVal">1.0</span></label>
          <input type="range" id="qFactor" min="0.1" max="15" step="0.1" value="1">
        </div>
      </div>

      <div class="cutoff-indicator">
        <div class="cutoff-line" id="cutoffLine" style="left: 18%;">
          <span class="cutoff-label" id="cutoffLabel">1500 Hz</span>
        </div>
      </div>
      <div style="display: flex; justify-content: space-between; color: #666; font-size: 11px;">
        <span>100 Hz</span>
        <span>1000 Hz</span>
        <span>4000 Hz</span>
        <span>8000 Hz</span>
      </div>

      <div class="spectrum-container">
        <h3 style="color: #888; margin-top: 0;">Frequency Spectrum</h3>
        <canvas id="spectrum"></canvas>
        <div class="spectrum-labels">
          <span>Low (Bass)</span>
          <span>Mid</span>
          <span>High (Treble)</span>
        </div>
      </div>

      <div class="info-box">
        <strong>What you're seeing:</strong> The spectrum shows the frequency content of the sound.
        Watch how the filter shapes the spectrum - lowpass removes highs (right side),
        highpass removes lows (left side), bandpass keeps only a narrow band.
      </div>
    </div>

    <div class="section">
      <h2>2. Lofi Presets</h2>
      <p>Quick settings for common lofi filter sounds.</p>

      <div style="display: flex; gap: 10px; flex-wrap: wrap; margin: 15px 0;">
        <button class="preset-btn" data-freq="3000" data-q="0.7" data-type="lowpass">Subtle Warmth</button>
        <button class="preset-btn" data-freq="1500" data-q="1" data-type="lowpass">Classic Lofi</button>
        <button class="preset-btn" data-freq="800" data-q="0.8" data-type="lowpass">Muffled/Distant</button>
        <button class="preset-btn" data-freq="1000" data-q="3" data-type="bandpass">Telephone</button>
        <button class="preset-btn" data-freq="2000" data-q="8" data-type="lowpass">Resonant Sweep</button>
      </div>

      <div class="info-box tip">
        <strong>Tip:</strong> For authentic lofi, keep Q low (0.5-2). High resonance sounds modern and "synthy".
        Classic lofi warmth comes from gentle filtering without a resonant peak.
      </div>
    </div>

    <div class="section">
      <h2>3. Before & After Comparison</h2>
      <p>Hear the dramatic difference filtering makes to a chord progression.</p>

      <div class="comparison">
        <div class="comparison-box">
          <h3>Unfiltered (Bright)</h3>
          <p style="color: #888; font-size: 12px;">Raw synth, all frequencies present</p>
          <button id="playUnfiltered">Play Chord</button>
        </div>

        <div class="comparison-box filtered">
          <h3>Filtered (Warm)</h3>
          <p style="color: #888; font-size: 12px;">Lowpass at 1200 Hz</p>
          <button id="playFiltered">Play Chord</button>
        </div>
      </div>

      <div class="info-box">
        <strong>Notice the difference?</strong> The filtered version sounds warmer, more vintage,
        and less harsh. This is the core technique behind the lofi sound - mimicking how old
        tape machines and vinyl naturally rolled off high frequencies.
      </div>
    </div>

    <div class="section">
      <h2>4. Filter Sweep</h2>
      <p>Automate the filter cutoff for movement and interest.</p>

      <div class="controls">
        <div class="control">
          <label>Sweep Speed <span class="value" id="sweepSpeedVal">2 sec</span></label>
          <input type="range" id="sweepSpeed" min="0.5" max="8" step="0.5" value="2">
        </div>
        <div class="control">
          <label>Sweep Range <span class="value" id="sweepRangeVal">Low to High</span></label>
          <select id="sweepRange">
            <option value="up">Low to High (200-4000 Hz)</option>
            <option value="down">High to Low (4000-200 Hz)</option>
            <option value="narrow">Narrow (800-2000 Hz)</option>
          </select>
        </div>
      </div>

      <button id="startSweep">Start Sweep</button>
      <button id="stopSweep" disabled>Stop Sweep</button>

      <div class="info-box tip">
        <strong>Pro tip:</strong> Filter sweeps add life to static loops. Try a slow upward sweep
        during a buildup, then drop back to a muffled sound for impact.
      </div>
    </div>
  </div>

  <script>
    // Global state
    let audioStarted = false;
    let currentSource = null;
    let filter = null;
    let analyser = null;
    let noiseSource = null;
    let synthSource = null;
    let currentSoundType = 'noise';
    let animationId = null;
    let sweepLoop = null;

    // Comparison synths
    let unfilteredSynth = null;
    let filteredSynth = null;
    let comparisonFilter = null;

    // Canvas setup
    const canvas = document.getElementById('spectrum');
    const ctx = canvas.getContext('2d');

    function resizeCanvas() {
      canvas.width = canvas.offsetWidth * window.devicePixelRatio;
      canvas.height = canvas.offsetHeight * window.devicePixelRatio;
      ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    // Initialize audio
    async function initAudio() {
      await Tone.start();

      // Create filter
      filter = new Tone.Filter({
        frequency: 1500,
        type: 'lowpass',
        rolloff: -24,
        Q: 1
      }).toDestination();

      // Create analyser for visualization
      analyser = new Tone.Analyser('fft', 256);
      filter.connect(analyser);

      // Create noise source
      noiseSource = new Tone.Noise('pink');
      noiseSource.volume.value = -10;

      // Create synth source (sawtooth is harmonically rich)
      synthSource = new Tone.Synth({
        oscillator: { type: 'sawtooth' },
        envelope: {
          attack: 0.01,
          decay: 0.1,
          sustain: 1,
          release: 0.5
        }
      });
      synthSource.volume.value = -15;

      // Setup comparison synths
      comparisonFilter = new Tone.Filter(1200, 'lowpass').toDestination();

      unfilteredSynth = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: 'sawtooth' },
        envelope: { attack: 0.05, decay: 0.2, sustain: 0.5, release: 1 }
      }).toDestination();
      unfilteredSynth.volume.value = -10;

      filteredSynth = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: 'sawtooth' },
        envelope: { attack: 0.05, decay: 0.2, sustain: 0.5, release: 1 }
      }).connect(comparisonFilter);
      filteredSynth.volume.value = -10;

      audioStarted = true;
      updateStatus('Audio ready! Choose a sound source and adjust the filter.');
    }

    function updateStatus(msg) {
      document.getElementById('status').textContent = msg;
    }

    // Start/stop audio
    document.getElementById('startAudio').addEventListener('click', async () => {
      if (!audioStarted) {
        await initAudio();
      }
      startCurrentSource();
      document.getElementById('startAudio').disabled = true;
      document.getElementById('stopAudio').disabled = false;
      startVisualization();
    });

    document.getElementById('stopAudio').addEventListener('click', () => {
      stopCurrentSource();
      document.getElementById('startAudio').disabled = false;
      document.getElementById('stopAudio').disabled = true;
      stopVisualization();
    });

    function startCurrentSource() {
      stopCurrentSource();

      if (currentSoundType === 'noise') {
        noiseSource.connect(filter);
        noiseSource.start();
        currentSource = noiseSource;
      } else if (currentSoundType === 'saw') {
        synthSource.connect(filter);
        // Play continuous note
        synthSource.triggerAttack('C3');
        currentSource = synthSource;
      } else if (currentSoundType === 'chord') {
        // Create a drone chord
        const chordSynth = new Tone.PolySynth(Tone.Synth, {
          oscillator: { type: 'sawtooth' },
          envelope: { attack: 0.1, decay: 0.3, sustain: 0.8, release: 1 }
        });
        chordSynth.volume.value = -15;
        chordSynth.connect(filter);
        chordSynth.triggerAttack(['C3', 'E3', 'G3', 'B3']);
        currentSource = chordSynth;
      }
    }

    function stopCurrentSource() {
      if (currentSource) {
        if (currentSource === noiseSource) {
          noiseSource.stop();
          noiseSource.disconnect();
        } else if (currentSource === synthSource) {
          synthSource.triggerRelease();
          synthSource.disconnect();
        } else {
          currentSource.releaseAll();
          currentSource.disconnect();
          currentSource.dispose();
        }
        currentSource = null;
      }
    }

    // Sound source selection
    document.querySelectorAll('.sound-selector button').forEach(btn => {
      btn.addEventListener('click', async () => {
        document.querySelectorAll('.sound-selector button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentSoundType = btn.dataset.sound;

        if (audioStarted && !document.getElementById('stopAudio').disabled) {
          startCurrentSource();
        }
      });
    });

    // Filter type selection
    document.querySelectorAll('.filter-type-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-type-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        if (filter) {
          filter.type = btn.dataset.type;
        }
      });
    });

    // Frequency control
    document.getElementById('frequency').addEventListener('input', (e) => {
      const freq = parseInt(e.target.value);
      document.getElementById('freqVal').textContent = freq + ' Hz';

      if (filter) {
        filter.frequency.value = freq;
      }

      updateCutoffIndicator(freq);
    });

    function updateCutoffIndicator(freq) {
      // Logarithmic scale for visual representation
      const minFreq = 100;
      const maxFreq = 8000;
      const percent = (Math.log(freq) - Math.log(minFreq)) / (Math.log(maxFreq) - Math.log(minFreq)) * 100;

      const line = document.getElementById('cutoffLine');
      const label = document.getElementById('cutoffLabel');
      line.style.left = percent + '%';
      label.textContent = freq + ' Hz';
    }

    // Q control
    document.getElementById('qFactor').addEventListener('input', (e) => {
      const q = parseFloat(e.target.value);
      document.getElementById('qVal').textContent = q.toFixed(1);

      if (filter) {
        filter.Q.value = q;
      }
    });

    // Preset buttons
    document.querySelectorAll('.preset-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const freq = parseInt(btn.dataset.freq);
        const q = parseFloat(btn.dataset.q);
        const type = btn.dataset.type;

        // Update UI
        document.getElementById('frequency').value = freq;
        document.getElementById('freqVal').textContent = freq + ' Hz';
        document.getElementById('qFactor').value = q;
        document.getElementById('qVal').textContent = q.toFixed(1);

        // Update filter type buttons
        document.querySelectorAll('.filter-type-btn').forEach(b => {
          b.classList.toggle('active', b.dataset.type === type);
        });

        // Update filter
        if (filter) {
          filter.type = type;
          filter.frequency.value = freq;
          filter.Q.value = q;
        }

        updateCutoffIndicator(freq);
      });
    });

    // Comparison buttons
    document.getElementById('playUnfiltered').addEventListener('click', async () => {
      await Tone.start();
      if (!unfilteredSynth) await initAudio();
      unfilteredSynth.triggerAttackRelease(['C4', 'E4', 'G4', 'B4'], '2n');
    });

    document.getElementById('playFiltered').addEventListener('click', async () => {
      await Tone.start();
      if (!filteredSynth) await initAudio();
      filteredSynth.triggerAttackRelease(['C4', 'E4', 'G4', 'B4'], '2n');
    });

    // Sweep controls
    document.getElementById('sweepSpeed').addEventListener('input', (e) => {
      document.getElementById('sweepSpeedVal').textContent = e.target.value + ' sec';
    });

    document.getElementById('startSweep').addEventListener('click', async () => {
      if (!audioStarted) {
        await initAudio();
      }

      const speed = parseFloat(document.getElementById('sweepSpeed').value);
      const range = document.getElementById('sweepRange').value;

      let startFreq, endFreq;
      if (range === 'up') {
        startFreq = 200;
        endFreq = 4000;
      } else if (range === 'down') {
        startFreq = 4000;
        endFreq = 200;
      } else {
        startFreq = 800;
        endFreq = 2000;
      }

      // Start audio if not playing
      if (!currentSource) {
        startCurrentSource();
        document.getElementById('startAudio').disabled = true;
        document.getElementById('stopAudio').disabled = false;
        startVisualization();
      }

      // Create sweep loop
      filter.frequency.value = startFreq;
      document.getElementById('frequency').value = startFreq;
      document.getElementById('freqVal').textContent = startFreq + ' Hz';
      updateCutoffIndicator(startFreq);

      sweepLoop = setInterval(() => {
        const currentFreq = filter.frequency.value;

        // Ramp to target
        filter.frequency.rampTo(endFreq, speed);

        // Update UI during sweep
        let sweepUpdateId = setInterval(() => {
          const freq = Math.round(filter.frequency.value);
          document.getElementById('frequency').value = freq;
          document.getElementById('freqVal').textContent = freq + ' Hz';
          updateCutoffIndicator(freq);

          // Stop updating when we reach target
          if (Math.abs(freq - endFreq) < 50) {
            clearInterval(sweepUpdateId);
            // Swap direction
            const temp = startFreq;
            startFreq = endFreq;
            endFreq = temp;
          }
        }, 50);
      }, speed * 1000 + 100);

      // Initial ramp
      filter.frequency.rampTo(endFreq, speed);

      document.getElementById('startSweep').disabled = true;
      document.getElementById('stopSweep').disabled = false;
    });

    document.getElementById('stopSweep').addEventListener('click', () => {
      if (sweepLoop) {
        clearInterval(sweepLoop);
        sweepLoop = null;
      }
      filter.frequency.cancelScheduledValues(Tone.now());

      document.getElementById('startSweep').disabled = false;
      document.getElementById('stopSweep').disabled = true;
    });

    // Visualization
    function startVisualization() {
      function draw() {
        if (!analyser) return;

        const values = analyser.getValue();
        const width = canvas.offsetWidth;
        const height = canvas.offsetHeight;

        ctx.clearRect(0, 0, width, height);

        // Draw spectrum bars
        const barWidth = width / values.length;

        for (let i = 0; i < values.length; i++) {
          // Convert dB to linear scale (0-1)
          const db = values[i];
          const normalized = Math.max(0, (db + 100) / 100);
          const barHeight = normalized * height;

          // Color gradient from accent to secondary
          const hue = 340 + (i / values.length) * 130; // Red to teal
          ctx.fillStyle = `hsl(${hue}, 70%, 55%)`;

          ctx.fillRect(
            i * barWidth,
            height - barHeight,
            barWidth - 1,
            barHeight
          );
        }

        // Draw filter cutoff line
        if (filter) {
          const freq = filter.frequency.value;
          const minFreq = 20;
          const maxFreq = 20000;

          // Map frequency to x position (logarithmic)
          const x = (Math.log(freq) - Math.log(minFreq)) / (Math.log(maxFreq) - Math.log(minFreq)) * width;

          ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
          ctx.lineWidth = 2;
          ctx.setLineDash([5, 5]);
          ctx.beginPath();
          ctx.moveTo(x, 0);
          ctx.lineTo(x, height);
          ctx.stroke();
          ctx.setLineDash([]);

          // Label
          ctx.fillStyle = 'white';
          ctx.font = '11px sans-serif';
          ctx.fillText(Math.round(freq) + ' Hz', x + 5, 15);
        }

        animationId = requestAnimationFrame(draw);
      }

      draw();
    }

    function stopVisualization() {
      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }

      // Clear canvas
      const width = canvas.offsetWidth;
      const height = canvas.offsetHeight;
      ctx.clearRect(0, 0, width, height);
    }

    // Initialize cutoff indicator
    updateCutoffIndicator(1500);

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      stopCurrentSource();
      if (Tone.Transport.state === 'started') {
        Tone.Transport.stop();
      }
    });
  </script>
</body>
</html>
