<!DOCTYPE html>
<html>
<head>
  <title>Song Structure - Demo</title>
  <script src="https://unpkg.com/tone@14"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #eee;
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .container { max-width: 1000px; margin: 0 auto; }
    h1 { color: #e94560; margin-bottom: 10px; }
    h2 { color: #4ecdc4; margin-top: 30px; }
    h3 { color: #888; margin-bottom: 10px; }
    .subtitle { color: #888; margin-bottom: 30px; }

    .section {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }

    button {
      background: #e94560;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 8px;
      margin: 5px;
      transition: transform 0.1s, background 0.2s;
    }
    button:hover { background: #ff6b6b; transform: scale(1.02); }
    button:active { transform: scale(0.98); }
    button:disabled { background: #444; cursor: not-allowed; transform: none; }
    button.secondary {
      background: #4ecdc4;
      color: #1a1a2e;
    }
    button.secondary:hover { background: #6ee7df; }
    button.active {
      box-shadow: 0 0 15px rgba(233, 69, 96, 0.5);
    }

    #status {
      text-align: center;
      padding: 10px;
      color: #888;
      font-size: 14px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      margin: 10px 0;
    }

    .info-box {
      background: rgba(78, 205, 196, 0.1);
      border-left: 4px solid #4ecdc4;
      padding: 15px;
      margin: 15px 0;
      border-radius: 0 8px 8px 0;
    }
    .info-box.tip {
      background: rgba(233, 69, 96, 0.1);
      border-left-color: #e94560;
    }

    /* Transport Controls */
    .transport {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 20px 0;
      align-items: center;
      flex-wrap: wrap;
    }
    .transport-display {
      background: rgba(0,0,0,0.3);
      padding: 8px 16px;
      border-radius: 6px;
      text-align: center;
      min-width: 80px;
    }
    .transport-value {
      font-size: 20px;
      font-weight: bold;
      color: #e94560;
    }
    .transport-label {
      font-size: 10px;
      color: #666;
      text-transform: uppercase;
    }

    /* BPM Control */
    .bpm-control {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(0,0,0,0.2);
      padding: 10px 20px;
      border-radius: 8px;
    }
    .bpm-control input[type="range"] {
      width: 120px;
      accent-color: #e94560;
    }
    .bpm-control label {
      color: #888;
      font-size: 12px;
    }
    .bpm-control .value {
      color: #e94560;
      font-weight: bold;
      min-width: 50px;
    }

    /* Timeline */
    .timeline-container {
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }
    .timeline {
      display: flex;
      height: 60px;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }
    .timeline-section {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      border-right: 1px solid rgba(0,0,0,0.3);
    }
    .timeline-section:last-child {
      border-right: none;
    }
    .timeline-section:hover {
      filter: brightness(1.2);
    }
    .timeline-section.active {
      filter: brightness(1.3);
      box-shadow: inset 0 0 20px rgba(255,255,255,0.2);
    }
    .timeline-section.intro { background: #3a506b; }
    .timeline-section.verse { background: #5c7a99; }
    .timeline-section.chorus { background: #e94560; }
    .timeline-section.breakdown { background: #2c3e50; }
    .timeline-section.outro { background: #3a506b; }

    .section-label {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }
    .section-bars {
      font-size: 10px;
      opacity: 0.7;
    }

    /* Playhead */
    .playhead {
      position: absolute;
      width: 3px;
      height: 100%;
      background: #fff;
      box-shadow: 0 0 10px #fff;
      top: 0;
      left: 0;
      pointer-events: none;
      transition: left 0.1s linear;
      z-index: 10;
    }

    /* Current Section Display */
    .current-section {
      text-align: center;
      margin: 20px 0;
    }
    .current-section-name {
      font-size: 48px;
      font-weight: bold;
      color: #e94560;
      text-transform: uppercase;
      letter-spacing: 4px;
    }
    .current-bar {
      font-size: 18px;
      color: #888;
      margin-top: 5px;
    }

    /* Element Status Grid */
    .elements-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin: 20px 0;
    }
    .element-card {
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      border: 2px solid transparent;
      transition: all 0.3s;
    }
    .element-card.active {
      border-color: #4ecdc4;
      background: rgba(78, 205, 196, 0.1);
    }
    .element-card.active .element-icon {
      color: #4ecdc4;
    }
    .element-icon {
      font-size: 32px;
      margin-bottom: 10px;
      transition: color 0.3s;
      color: #444;
    }
    .element-name {
      font-size: 14px;
      font-weight: bold;
      color: #888;
      text-transform: uppercase;
    }
    .element-card.active .element-name {
      color: #4ecdc4;
    }
    .element-status {
      font-size: 11px;
      margin-top: 5px;
      color: #555;
    }
    .element-card.active .element-status {
      color: #4ecdc4;
    }

    /* Section Selector */
    .section-selector {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin: 20px 0;
    }
    .section-btn {
      background: rgba(255,255,255,0.1);
      border: 2px solid #444;
      padding: 12px 24px;
      color: #888;
      font-size: 14px;
      text-transform: uppercase;
    }
    .section-btn:hover {
      border-color: #666;
      transform: none;
    }
    .section-btn.intro { border-color: #3a506b; color: #3a506b; }
    .section-btn.intro:hover, .section-btn.intro.active { background: #3a506b; color: #fff; }
    .section-btn.verse { border-color: #5c7a99; color: #5c7a99; }
    .section-btn.verse:hover, .section-btn.verse.active { background: #5c7a99; color: #fff; }
    .section-btn.chorus { border-color: #e94560; color: #e94560; }
    .section-btn.chorus:hover, .section-btn.chorus.active { background: #e94560; color: #fff; }
    .section-btn.breakdown { border-color: #2c3e50; color: #7f8c8d; }
    .section-btn.breakdown:hover, .section-btn.breakdown.active { background: #2c3e50; color: #fff; }
    .section-btn.outro { border-color: #3a506b; color: #3a506b; }
    .section-btn.outro:hover, .section-btn.outro.active { background: #3a506b; color: #fff; }

    /* Structure Presets */
    .structure-presets {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin: 15px 0;
    }
    .preset-btn {
      background: rgba(78, 205, 196, 0.15);
      border: 2px solid #4ecdc4;
      color: #4ecdc4;
      padding: 10px 20px;
      font-size: 13px;
    }
    .preset-btn:hover {
      background: rgba(78, 205, 196, 0.25);
    }
    .preset-btn.active {
      background: #4ecdc4;
      color: #1a1a2e;
    }

    /* Legend */
    .timeline-legend {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 15px 0;
      flex-wrap: wrap;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #888;
    }
    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
    }
    .legend-color.intro { background: #3a506b; }
    .legend-color.verse { background: #5c7a99; }
    .legend-color.chorus { background: #e94560; }
    .legend-color.breakdown { background: #2c3e50; }
    .legend-color.outro { background: #3a506b; }

    @media (max-width: 700px) {
      .elements-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .current-section-name {
        font-size: 32px;
      }
      .timeline-section {
        font-size: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Song Structure</h1>
    <p class="subtitle">Arrange sections to create a journey, not just a loop</p>

    <div id="status">Click "Start Audio" to begin</div>

    <div class="section">
      <h2>1. Visual Timeline</h2>
      <p>Click on any section to jump there. The playhead shows current position.</p>

      <div class="timeline-legend">
        <div class="legend-item"><div class="legend-color intro"></div> Intro</div>
        <div class="legend-item"><div class="legend-color verse"></div> Verse</div>
        <div class="legend-item"><div class="legend-color chorus"></div> Chorus</div>
        <div class="legend-item"><div class="legend-color breakdown"></div> Breakdown</div>
        <div class="legend-item"><div class="legend-color outro"></div> Outro</div>
      </div>

      <div class="timeline-container">
        <div class="timeline" id="timeline">
          <div class="playhead" id="playhead"></div>
          <!-- Sections will be generated by JS -->
        </div>
      </div>

      <div class="current-section">
        <div class="current-section-name" id="currentSectionName">INTRO</div>
        <div class="current-bar">Bar <span id="currentBar">1</span> / <span id="totalBars">44</span></div>
      </div>
    </div>

    <div class="section">
      <h2>2. Transport Controls</h2>

      <div class="transport">
        <button id="startBtn">Start Audio</button>
        <button id="playBtn" disabled>Play Full Song</button>
        <button id="stopBtn" class="secondary" disabled>Stop</button>
        <div class="transport-display">
          <div class="transport-value" id="positionDisplay">0:0:0</div>
          <div class="transport-label">Position</div>
        </div>
      </div>

      <div class="bpm-control" style="justify-content: center; margin: 15px 0;">
        <label>BPM</label>
        <input type="range" id="bpmSlider" min="60" max="100" value="80">
        <span class="value" id="bpmValue">80</span>
      </div>
    </div>

    <div class="section">
      <h2>3. Jump to Section</h2>
      <p>Click any section button to jump directly there and hear how it sounds.</p>

      <div class="section-selector">
        <button class="section-btn intro active" data-section="intro">Intro</button>
        <button class="section-btn verse" data-section="verse">Verse</button>
        <button class="section-btn chorus" data-section="chorus">Chorus</button>
        <button class="section-btn breakdown" data-section="breakdown">Breakdown</button>
        <button class="section-btn outro" data-section="outro">Outro</button>
      </div>

      <div class="info-box tip">
        <strong>Tip:</strong> Listen to how elements appear and disappear between sections. The intro is sparse, verse adds drums, chorus is fullest, breakdown strips it back.
      </div>
    </div>

    <div class="section">
      <h2>4. Active Elements</h2>
      <p>See which elements are playing in the current section.</p>

      <div class="elements-grid">
        <div class="element-card" id="drumCard">
          <div class="element-icon">&#x1F941;</div>
          <div class="element-name">Drums</div>
          <div class="element-status">OFF</div>
        </div>
        <div class="element-card" id="bassCard">
          <div class="element-icon">&#x1F3B8;</div>
          <div class="element-name">Bass</div>
          <div class="element-status">OFF</div>
        </div>
        <div class="element-card" id="chordCard">
          <div class="element-icon">&#x1F3B9;</div>
          <div class="element-name">Chords</div>
          <div class="element-status">OFF</div>
        </div>
        <div class="element-card" id="melodyCard">
          <div class="element-icon">&#x1F3B5;</div>
          <div class="element-name">Melody</div>
          <div class="element-status">OFF</div>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>5. Structure Presets</h2>
      <p>Try different song structures commonly used in lofi.</p>

      <div class="structure-presets">
        <button class="preset-btn active" data-structure="simple">Simple (A-A-B-A)</button>
        <button class="preset-btn" data-structure="extended">Extended</button>
        <button class="preset-btn" data-structure="minimal">Minimal Loop</button>
      </div>

      <div id="structureInfo" class="info-box">
        <strong>Simple Structure:</strong> Intro (4) - Verse (8) - Verse (8) - Chorus (8) - Verse (8) - Outro (4) = 40 bars
      </div>
    </div>
  </div>

  <script>
    // =====================
    // GLOBAL STATE
    // =====================
    let isInitialized = false;
    let isPlaying = false;
    let currentSectionIndex = 0;

    // Audio nodes
    let kick, snare, hihat;
    let bass, chords, melody;
    let filter, reverb;
    let drumLoop, bassLoop, chordLoop, melodyLoop;

    // Structure definitions
    const structures = {
      simple: {
        name: 'Simple Structure',
        description: 'Intro (4) - Verse (8) - Verse (8) - Chorus (8) - Verse (8) - Outro (4) = 40 bars',
        sections: [
          { name: 'intro', bars: 4 },
          { name: 'verse', bars: 8 },
          { name: 'verse', bars: 8 },
          { name: 'chorus', bars: 8 },
          { name: 'verse', bars: 8 },
          { name: 'outro', bars: 4 }
        ]
      },
      extended: {
        name: 'Extended Structure',
        description: 'Intro (8) - Verse (16) - Chorus (8) - Verse (8) - Breakdown (4) - Chorus (8) - Outro (8) = 60 bars',
        sections: [
          { name: 'intro', bars: 8 },
          { name: 'verse', bars: 16 },
          { name: 'chorus', bars: 8 },
          { name: 'verse', bars: 8 },
          { name: 'breakdown', bars: 4 },
          { name: 'chorus', bars: 8 },
          { name: 'outro', bars: 8 }
        ]
      },
      minimal: {
        name: 'Minimal Loop',
        description: 'Intro (4) - Verse (16) - Breakdown (4) - Verse (16) - Outro (4) = 44 bars',
        sections: [
          { name: 'intro', bars: 4 },
          { name: 'verse', bars: 16 },
          { name: 'breakdown', bars: 4 },
          { name: 'verse', bars: 16 },
          { name: 'outro', bars: 4 }
        ]
      }
    };

    let currentStructure = structures.simple;

    // Section configurations
    const sectionConfigs = {
      intro: {
        drums: false, bass: false, chords: true, melody: false,
        filterFreq: 600, reverbWet: 0.6, volume: -15
      },
      verse: {
        drums: true, bass: true, chords: true, melody: false,
        filterFreq: 1400, reverbWet: 0.35, volume: -10
      },
      chorus: {
        drums: true, bass: true, chords: true, melody: true,
        filterFreq: 2800, reverbWet: 0.45, volume: -6
      },
      breakdown: {
        drums: false, bass: false, chords: true, melody: false,
        filterFreq: 400, reverbWet: 0.7, volume: -18
      },
      outro: {
        drums: false, bass: false, chords: true, melody: false,
        filterFreq: 500, reverbWet: 0.6, volume: -20
      }
    };

    // =====================
    // AUDIO INITIALIZATION
    // =====================
    async function initAudio() {
      if (isInitialized) return;

      await Tone.start();

      // Create filter and reverb
      filter = new Tone.Filter(1400, 'lowpass').toDestination();
      filter.Q.value = 1;

      reverb = new Tone.Reverb(2.5);
      await reverb.generate();
      reverb.wet.value = 0.35;
      reverb.connect(Tone.Destination);

      // Kick drum
      kick = new Tone.MembraneSynth({
        pitchDecay: 0.05,
        octaves: 6,
        oscillator: { type: 'sine' },
        envelope: { attack: 0.001, decay: 0.3, sustain: 0, release: 0.1 }
      }).connect(filter);
      kick.volume.value = -8;

      // Snare
      snare = new Tone.NoiseSynth({
        noise: { type: 'white' },
        envelope: { attack: 0.001, decay: 0.15, sustain: 0, release: 0.05 }
      }).connect(filter);
      snare.volume.value = -12;

      // Hi-hat
      hihat = new Tone.MetalSynth({
        frequency: 200,
        envelope: { attack: 0.001, decay: 0.05, release: 0.01 },
        harmonicity: 5.1,
        modulationIndex: 32,
        resonance: 4000,
        octaves: 1.5
      }).connect(filter);
      hihat.volume.value = -20;

      // Bass
      bass = new Tone.Synth({
        oscillator: { type: 'triangle' },
        envelope: { attack: 0.02, decay: 0.3, sustain: 0.4, release: 0.3 }
      }).connect(filter);
      bass.volume.value = -Infinity;

      // Chords (Rhodes-like)
      chords = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: 'sine' },
        envelope: { attack: 0.05, decay: 0.4, sustain: 0.5, release: 1 }
      }).connect(filter).connect(reverb);
      chords.volume.value = -12;

      // Melody
      melody = new Tone.Synth({
        oscillator: { type: 'sine' },
        envelope: { attack: 0.1, decay: 0.3, sustain: 0.3, release: 0.8 }
      }).connect(filter).connect(reverb);
      melody.volume.value = -Infinity;

      // Create loops
      createPatterns();

      // Setup transport
      Tone.Transport.bpm.value = 80;
      Tone.Transport.swing = 0.15;
      Tone.Transport.swingSubdivision = '16n';

      isInitialized = true;
      updateStatus('Audio ready! Press Play to hear the full song structure.');

      document.getElementById('startBtn').disabled = true;
      document.getElementById('playBtn').disabled = false;
      document.getElementById('stopBtn').disabled = false;

      buildTimeline();
    }

    function createPatterns() {
      // Drum pattern
      drumLoop = new Tone.Part((time, note) => {
        if (note.type === 'kick') {
          kick.triggerAttackRelease('C1', '8n', time, note.vel);
        } else if (note.type === 'snare') {
          snare.triggerAttackRelease('8n', time, note.vel);
        } else if (note.type === 'hihat') {
          hihat.triggerAttackRelease('32n', time, note.vel);
        }
      }, [
        { time: '0:0:0', type: 'kick', vel: 0.95 },
        { time: '0:0:0', type: 'hihat', vel: 0.5 },
        { time: '0:0:2', type: 'hihat', vel: 0.2 },
        { time: '0:1:0', type: 'snare', vel: 0.8 },
        { time: '0:1:0', type: 'hihat', vel: 0.4 },
        { time: '0:1:2', type: 'kick', vel: 0.7 },
        { time: '0:1:2', type: 'hihat', vel: 0.2 },
        { time: '0:2:0', type: 'hihat', vel: 0.5 },
        { time: '0:2:2', type: 'kick', vel: 0.8 },
        { time: '0:2:2', type: 'hihat', vel: 0.2 },
        { time: '0:3:0', type: 'snare', vel: 0.85 },
        { time: '0:3:0', type: 'hihat', vel: 0.4 },
        { time: '0:3:2', type: 'hihat', vel: 0.2 }
      ]);
      drumLoop.loop = true;
      drumLoop.loopEnd = '1m';

      // Bass pattern (Dm - G - C - Am style)
      bassLoop = new Tone.Part((time, note) => {
        bass.triggerAttackRelease(note.note, note.dur, time, note.vel);
      }, [
        { time: '0:0:0', note: 'D2', dur: '4n', vel: 0.8 },
        { time: '0:2:0', note: 'D2', dur: '8n', vel: 0.6 },
        { time: '1:0:0', note: 'G2', dur: '4n', vel: 0.8 },
        { time: '1:2:0', note: 'G2', dur: '8n', vel: 0.6 },
        { time: '2:0:0', note: 'C2', dur: '4n', vel: 0.8 },
        { time: '2:2:0', note: 'C2', dur: '8n', vel: 0.6 },
        { time: '3:0:0', note: 'A1', dur: '4n', vel: 0.8 },
        { time: '3:2:0', note: 'A1', dur: '8n', vel: 0.6 }
      ]);
      bassLoop.loop = true;
      bassLoop.loopEnd = '4m';

      // Chord pattern
      chordLoop = new Tone.Part((time, note) => {
        chords.triggerAttackRelease(note.notes, note.dur, time, note.vel);
      }, [
        { time: '0:0:0', notes: ['D3', 'F3', 'A3', 'C4'], dur: '2n', vel: 0.5 },
        { time: '1:0:0', notes: ['G3', 'B3', 'D4', 'F4'], dur: '2n', vel: 0.5 },
        { time: '2:0:0', notes: ['C3', 'E3', 'G3', 'B3'], dur: '2n', vel: 0.5 },
        { time: '3:0:0', notes: ['A2', 'C3', 'E3', 'G3'], dur: '2n', vel: 0.5 }
      ]);
      chordLoop.loop = true;
      chordLoop.loopEnd = '4m';

      // Melody pattern
      melodyLoop = new Tone.Part((time, note) => {
        melody.triggerAttackRelease(note.note, note.dur, time, note.vel);
      }, [
        { time: '0:0:0', note: 'A4', dur: '4n', vel: 0.6 },
        { time: '0:2:0', note: 'G4', dur: '8n', vel: 0.4 },
        { time: '1:0:0', note: 'F4', dur: '4n.', vel: 0.6 },
        { time: '2:0:0', note: 'E4', dur: '4n', vel: 0.5 },
        { time: '2:2:0', note: 'D4', dur: '4n', vel: 0.5 },
        { time: '3:0:0', note: 'C4', dur: '2n', vel: 0.6 }
      ]);
      melodyLoop.loop = true;
      melodyLoop.loopEnd = '4m';
    }

    // =====================
    // TIMELINE & UI
    // =====================
    function buildTimeline() {
      const timeline = document.getElementById('timeline');
      timeline.innerHTML = '<div class="playhead" id="playhead"></div>';

      let totalBars = 0;
      currentStructure.sections.forEach(s => totalBars += s.bars);

      let barPosition = 0;
      currentStructure.sections.forEach((section, index) => {
        const div = document.createElement('div');
        div.className = `timeline-section ${section.name}`;
        div.style.width = `${(section.bars / totalBars) * 100}%`;
        div.dataset.startBar = barPosition;
        div.dataset.index = index;

        div.innerHTML = `
          <div class="section-label">
            <span>${section.name.charAt(0).toUpperCase() + section.name.slice(1)}</span>
            <span class="section-bars">${section.bars} bars</span>
          </div>
        `;

        div.addEventListener('click', () => jumpToSection(index));
        timeline.appendChild(div);

        barPosition += section.bars;
      });

      document.getElementById('totalBars').textContent = totalBars;
      scheduleStructure();
    }

    function scheduleStructure() {
      Tone.Transport.cancel();

      let barPosition = 0;
      currentStructure.sections.forEach((section, index) => {
        Tone.Transport.schedule((time) => {
          currentSectionIndex = index;
          applySection(section.name, time);

          Tone.Draw.schedule(() => {
            updateSectionDisplay(section.name, index);
          }, time);
        }, `${barPosition}:0:0`);

        barPosition += section.bars;
      });

      // Schedule end
      Tone.Transport.schedule((time) => {
        Tone.Draw.schedule(() => {
          stopPlayback();
        }, time);
      }, `${barPosition}:0:0`);
    }

    function applySection(name, time) {
      const config = sectionConfigs[name];

      // Filter automation
      filter.frequency.rampTo(config.filterFreq, 0.5, time);
      reverb.wet.rampTo(config.reverbWet, 0.5, time);

      // Drums
      if (config.drums) {
        kick.volume.rampTo(-8, 0.3, time);
        snare.volume.rampTo(-12, 0.3, time);
        hihat.volume.rampTo(-20, 0.3, time);
      } else {
        kick.volume.rampTo(-Infinity, 0.3, time);
        snare.volume.rampTo(-Infinity, 0.3, time);
        hihat.volume.rampTo(-Infinity, 0.3, time);
      }

      // Bass
      bass.volume.rampTo(config.bass ? -8 : -Infinity, 0.3, time);

      // Chords are always on, but volume varies
      chords.volume.rampTo(config.volume, 0.3, time);

      // Melody
      melody.volume.rampTo(config.melody ? -10 : -Infinity, 0.3, time);
    }

    function updateSectionDisplay(name, index) {
      // Update section name
      document.getElementById('currentSectionName').textContent = name.toUpperCase();

      // Update section buttons
      document.querySelectorAll('.section-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      const activeBtn = document.querySelector(`.section-btn[data-section="${name}"]`);
      if (activeBtn) activeBtn.classList.add('active');

      // Update timeline sections
      document.querySelectorAll('.timeline-section').forEach(s => s.classList.remove('active'));
      const activeTimelineSection = document.querySelector(`.timeline-section[data-index="${index}"]`);
      if (activeTimelineSection) activeTimelineSection.classList.add('active');

      // Update element cards
      const config = sectionConfigs[name];
      updateElementCard('drumCard', config.drums);
      updateElementCard('bassCard', config.bass);
      updateElementCard('chordCard', config.chords);
      updateElementCard('melodyCard', config.melody);
    }

    function updateElementCard(id, active) {
      const card = document.getElementById(id);
      if (active) {
        card.classList.add('active');
        card.querySelector('.element-status').textContent = 'PLAYING';
      } else {
        card.classList.remove('active');
        card.querySelector('.element-status').textContent = 'OFF';
      }
    }

    function jumpToSection(index) {
      if (!isInitialized) return;

      let barPosition = 0;
      for (let i = 0; i < index; i++) {
        barPosition += currentStructure.sections[i].bars;
      }

      const section = currentStructure.sections[index];
      currentSectionIndex = index;

      // Jump transport
      Tone.Transport.position = `${barPosition}:0:0`;

      // Apply section immediately
      applySection(section.name, Tone.now());
      updateSectionDisplay(section.name, index);

      // Start if not playing
      if (!isPlaying) {
        startPlayback();
      }

      updateStatus(`Jumped to ${section.name.toUpperCase()} at bar ${barPosition + 1}`);
    }

    // =====================
    // PLAYBACK CONTROL
    // =====================
    function startPlayback() {
      if (isPlaying) return;

      drumLoop.start(0);
      bassLoop.start(0);
      chordLoop.start(0);
      melodyLoop.start(0);

      Tone.Transport.start();
      isPlaying = true;

      document.getElementById('playBtn').textContent = 'Playing...';
      document.getElementById('playBtn').disabled = true;

      requestAnimationFrame(updatePlayhead);
    }

    function stopPlayback() {
      drumLoop.stop();
      bassLoop.stop();
      chordLoop.stop();
      melodyLoop.stop();

      Tone.Transport.stop();
      Tone.Transport.position = 0;
      isPlaying = false;
      currentSectionIndex = 0;

      document.getElementById('playBtn').textContent = 'Play Full Song';
      document.getElementById('playBtn').disabled = false;

      // Reset display
      if (currentStructure.sections.length > 0) {
        updateSectionDisplay(currentStructure.sections[0].name, 0);
      }

      document.getElementById('playhead').style.left = '0%';
      document.getElementById('currentBar').textContent = '1';
      document.getElementById('positionDisplay').textContent = '0:0:0';
    }

    function updatePlayhead() {
      if (!isPlaying) return;

      const position = Tone.Transport.position;
      document.getElementById('positionDisplay').textContent = position.split('.')[0];

      // Calculate bar position
      const parts = position.split(':');
      const bar = parseInt(parts[0]) + 1;
      document.getElementById('currentBar').textContent = bar;

      // Calculate playhead position
      let totalBars = 0;
      currentStructure.sections.forEach(s => totalBars += s.bars);

      const currentBar = parseInt(parts[0]);
      const beat = parseInt(parts[1]);
      const sixteenth = parseFloat(parts[2]);

      const progressBars = currentBar + beat / 4 + sixteenth / 16;
      const percent = (progressBars / totalBars) * 100;

      document.getElementById('playhead').style.left = `${Math.min(percent, 100)}%`;

      requestAnimationFrame(updatePlayhead);
    }

    function updateStatus(msg) {
      document.getElementById('status').textContent = msg;
    }

    // =====================
    // EVENT LISTENERS
    // =====================
    document.getElementById('startBtn').addEventListener('click', initAudio);

    document.getElementById('playBtn').addEventListener('click', async () => {
      if (!isInitialized) await initAudio();
      Tone.Transport.position = 0;
      currentSectionIndex = 0;
      if (currentStructure.sections.length > 0) {
        applySection(currentStructure.sections[0].name, Tone.now());
        updateSectionDisplay(currentStructure.sections[0].name, 0);
      }
      startPlayback();
      updateStatus('Playing full song structure...');
    });

    document.getElementById('stopBtn').addEventListener('click', () => {
      stopPlayback();
      updateStatus('Stopped. Press Play to start again.');
    });

    // BPM control
    document.getElementById('bpmSlider').addEventListener('input', (e) => {
      const bpm = parseInt(e.target.value);
      Tone.Transport.bpm.value = bpm;
      document.getElementById('bpmValue').textContent = bpm;
    });

    // Section buttons
    document.querySelectorAll('.section-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!isInitialized) await initAudio();

        const sectionName = btn.dataset.section;

        // Find first occurrence of this section type
        const index = currentStructure.sections.findIndex(s => s.name === sectionName);
        if (index >= 0) {
          jumpToSection(index);
        }
      });
    });

    // Structure presets
    document.querySelectorAll('.preset-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const structureName = btn.dataset.structure;
        currentStructure = structures[structureName];

        document.getElementById('structureInfo').innerHTML =
          `<strong>${currentStructure.name}:</strong> ${currentStructure.description}`;

        // Rebuild timeline
        if (isInitialized) {
          if (isPlaying) stopPlayback();
          buildTimeline();
          updateStatus(`Loaded ${currentStructure.name}. Press Play to hear it.`);
        }
      });
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', async (e) => {
      if (!isInitialized) await initAudio();

      switch (e.key.toLowerCase()) {
        case ' ':
          e.preventDefault();
          if (isPlaying) stopPlayback(); else startPlayback();
          break;
        case '1':
          jumpToSection(0);
          break;
        case '2':
          if (currentStructure.sections.length > 1) jumpToSection(1);
          break;
        case '3':
          if (currentStructure.sections.length > 2) jumpToSection(2);
          break;
        case '4':
          if (currentStructure.sections.length > 3) jumpToSection(3);
          break;
        case '5':
          if (currentStructure.sections.length > 4) jumpToSection(4);
          break;
        case '6':
          if (currentStructure.sections.length > 5) jumpToSection(5);
          break;
        case '7':
          if (currentStructure.sections.length > 6) jumpToSection(6);
          break;
      }
    });

    // Initial click to init
    document.addEventListener('click', async () => {
      if (!isInitialized) await initAudio();
    }, { once: true });

    // Build initial timeline visualization (without audio)
    function buildInitialTimeline() {
      const timeline = document.getElementById('timeline');
      timeline.innerHTML = '<div class="playhead" id="playhead"></div>';

      let totalBars = 0;
      currentStructure.sections.forEach(s => totalBars += s.bars);

      let barPosition = 0;
      currentStructure.sections.forEach((section, index) => {
        const div = document.createElement('div');
        div.className = `timeline-section ${section.name}`;
        div.style.width = `${(section.bars / totalBars) * 100}%`;
        div.dataset.startBar = barPosition;
        div.dataset.index = index;

        div.innerHTML = `
          <div class="section-label">
            <span>${section.name.charAt(0).toUpperCase() + section.name.slice(1)}</span>
            <span class="section-bars">${section.bars} bars</span>
          </div>
        `;

        timeline.appendChild(div);
        barPosition += section.bars;
      });

      document.getElementById('totalBars').textContent = totalBars;

      // Set initial section display
      if (currentStructure.sections.length > 0) {
        const firstSection = currentStructure.sections[0].name;
        updateSectionDisplay(firstSection, 0);
      }
    }

    // Initialize visual timeline on load
    buildInitialTimeline();
  </script>
</body>
</html>
