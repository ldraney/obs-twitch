<!DOCTYPE html>
<html>
<head>
  <title>Distortion - Demo</title>
  <script src="https://unpkg.com/tone@14"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #eee;
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .container { max-width: 900px; margin: 0 auto; }
    h1 { color: #e94560; margin-bottom: 10px; }
    h2 { color: #4ecdc4; margin-top: 30px; }
    .subtitle { color: #888; margin-bottom: 30px; }

    .section {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }

    .control {
      background: rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 8px;
    }
    .control label {
      display: block;
      color: #888;
      font-size: 12px;
      margin-bottom: 5px;
    }
    .control .value {
      color: #e94560;
      font-weight: bold;
      float: right;
    }
    .control input[type="range"] {
      width: 100%;
      margin-top: 5px;
    }

    button {
      background: #e94560;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 8px;
      margin: 5px;
      transition: transform 0.1s, background 0.2s;
    }
    button:hover { background: #ff6b6b; transform: scale(1.02); }
    button:active { transform: scale(0.98); }
    button:disabled { background: #444; cursor: not-allowed; transform: none; }
    button.secondary {
      background: #4ecdc4;
    }
    button.secondary:hover { background: #6ee7df; }
    button.active {
      box-shadow: 0 0 15px rgba(233, 69, 96, 0.5);
    }

    .type-selector {
      display: flex;
      gap: 10px;
      margin: 15px 0;
      flex-wrap: wrap;
    }
    .type-btn {
      background: rgba(78, 205, 196, 0.2);
      border: 2px solid #4ecdc4;
      color: #4ecdc4;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
    }
    .type-btn:hover {
      background: rgba(78, 205, 196, 0.3);
    }
    .type-btn.active {
      background: #4ecdc4;
      color: #1a1a2e;
      font-weight: bold;
    }

    .waveform-display {
      height: 120px;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      margin: 15px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    .waveform-display canvas {
      width: 100%;
      height: 100%;
    }

    .info-box {
      background: rgba(78, 205, 196, 0.1);
      border-left: 4px solid #4ecdc4;
      padding: 15px;
      margin: 15px 0;
      border-radius: 0 8px 8px 0;
    }
    .info-box.warning {
      background: rgba(233, 69, 96, 0.1);
      border-left-color: #e94560;
    }
    .info-box.tip {
      background: rgba(255, 215, 0, 0.1);
      border-left-color: #ffd700;
    }

    .comparison {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 15px 0;
    }
    .comparison-box {
      background: rgba(0,0,0,0.2);
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .comparison-box h3 {
      color: #4ecdc4;
      margin-top: 0;
      margin-bottom: 15px;
    }
    .comparison-box.distorted h3 { color: #e94560; }

    .preset-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 15px 0;
    }
    .preset-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid #444;
      color: #888;
      padding: 8px 16px;
      font-size: 12px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .preset-btn:hover {
      background: rgba(255,255,255,0.15);
      color: #eee;
      border-color: #666;
    }

    #status {
      text-align: center;
      padding: 10px;
      color: #888;
      font-size: 14px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      margin: 10px 0;
    }

    .meter {
      height: 8px;
      background: rgba(0,0,0,0.3);
      border-radius: 4px;
      margin-top: 8px;
      overflow: hidden;
    }
    .meter-fill {
      height: 100%;
      background: linear-gradient(90deg, #4ecdc4, #e94560);
      border-radius: 4px;
      transition: width 0.1s;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Distortion</h1>
    <p class="subtitle">Adding warmth, grit, and harmonic character to your sound</p>

    <div id="status">Click any button to start audio</div>

    <div class="section">
      <h2>1. Distortion Types</h2>
      <p>Toggle between different distortion effects to hear how they color the sound.</p>

      <div class="type-selector">
        <button class="type-btn active" data-type="distortion">Distortion</button>
        <button class="type-btn" data-type="chebyshev">Chebyshev</button>
        <button class="type-btn" data-type="bitcrusher">BitCrusher</button>
        <button class="type-btn" data-type="none">Bypass (Clean)</button>
      </div>

      <div id="distortionControls" class="controls">
        <div class="control">
          <label>Distortion Amount <span class="value" id="distortionVal">0.2</span></label>
          <input type="range" id="distortionAmount" min="0" max="1" step="0.01" value="0.2">
          <div class="meter"><div class="meter-fill" id="distortionMeter" style="width: 20%"></div></div>
        </div>
        <div class="control">
          <label>Wet/Dry Mix <span class="value" id="wetVal">100%</span></label>
          <input type="range" id="wetAmount" min="0" max="1" step="0.01" value="1">
        </div>
      </div>

      <div id="chebyshevControls" class="controls" style="display: none;">
        <div class="control">
          <label>Order (Harmonics) <span class="value" id="orderVal">3</span></label>
          <input type="range" id="chebyshevOrder" min="1" max="50" step="1" value="3">
          <div class="meter"><div class="meter-fill" id="orderMeter" style="width: 6%"></div></div>
        </div>
        <div class="control">
          <label>Wet/Dry Mix <span class="value" id="chebyWetVal">100%</span></label>
          <input type="range" id="chebyWet" min="0" max="1" step="0.01" value="1">
        </div>
      </div>

      <div id="bitcrusherControls" class="controls" style="display: none;">
        <div class="control">
          <label>Bit Depth <span class="value" id="bitsVal">8</span></label>
          <input type="range" id="bitDepth" min="1" max="16" step="1" value="8">
          <div class="meter"><div class="meter-fill" id="bitsMeter" style="width: 50%"></div></div>
        </div>
      </div>

      <button id="playDemo">Play Sound</button>
      <button id="playChord" class="secondary">Play Chord</button>

      <div class="info-box" id="typeInfo">
        <strong>Distortion:</strong> Standard waveshaping distortion. Clips the waveform to add harmonics.
        Lower values (0.1-0.3) add warmth, higher values get aggressive.
      </div>
    </div>

    <div class="section">
      <h2>2. A/B Comparison</h2>
      <p>Hear the difference between clean and distorted signals.</p>

      <div class="comparison">
        <div class="comparison-box">
          <h3>Clean Signal</h3>
          <button id="playClean">Play Clean</button>
          <p style="color: #888; font-size: 12px; margin-top: 10px;">Original, unprocessed sound</p>
        </div>
        <div class="comparison-box distorted">
          <h3>With Distortion</h3>
          <button id="playDistorted">Play Distorted</button>
          <p style="color: #888; font-size: 12px; margin-top: 10px;">Current effect settings applied</p>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>3. Lofi Presets</h2>
      <p>Quick settings for common lofi distortion uses.</p>

      <div class="preset-buttons">
        <button class="preset-btn" data-preset="warmth">Subtle Warmth</button>
        <button class="preset-btn" data-preset="vintage">Vintage Sampler</button>
        <button class="preset-btn" data-preset="tape">Tape Saturation</button>
        <button class="preset-btn" data-preset="lofi-drums">Lo-Fi Drums</button>
        <button class="preset-btn" data-preset="8bit">8-Bit Crunch</button>
        <button class="preset-btn" data-preset="extreme">Extreme (Demo Only)</button>
      </div>

      <div class="info-box tip" id="presetInfo">
        <strong>Tip:</strong> Click a preset to load recommended settings for that sound.
      </div>
    </div>

    <div class="section">
      <h2>4. Waveform Visualization</h2>
      <p>See how distortion shapes your waveform in real-time.</p>

      <div class="waveform-display">
        <canvas id="waveformCanvas"></canvas>
      </div>

      <button id="startVisualization">Start Continuous Tone</button>
      <button id="stopVisualization" disabled>Stop</button>

      <div class="info-box warning">
        <strong>Notice:</strong> Watch how the waveform changes shape as you adjust distortion settings.
        More distortion = more "squared off" peaks = more harmonics.
      </div>
    </div>

    <div class="section">
      <h2>5. BitCrusher Deep Dive</h2>
      <p>BitCrusher is essential for that classic lo-fi sampler sound. Explore bit depths.</p>

      <div class="controls">
        <div class="control">
          <label>Bit Depth <span class="value" id="deepBitsVal">16</span></label>
          <input type="range" id="deepBitDepth" min="1" max="16" step="1" value="16">
        </div>
      </div>

      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button class="preset-btn" data-bits="16">16-bit (CD Quality)</button>
        <button class="preset-btn" data-bits="12">12-bit (Clean Lo-Fi)</button>
        <button class="preset-btn" data-bits="8">8-bit (SP-404)</button>
        <button class="preset-btn" data-bits="4">4-bit (Extreme)</button>
        <button class="preset-btn" data-bits="2">2-bit (Destroyed)</button>
      </div>

      <button id="playBitDemo" style="margin-top: 15px;">Play BitCrushed Sound</button>

      <div class="info-box">
        <strong>Bit Depth Guide:</strong><br>
        16 bits = 65,536 volume levels (transparent)<br>
        8 bits = 256 levels (classic 8-bit sound)<br>
        4 bits = 16 levels (heavily quantized)<br>
        1 bit = 2 levels (just on/off!)
      </div>
    </div>
  </div>

  <script>
    // Audio context and nodes
    let synth = null;
    let cleanSynth = null;
    let distortion = null;
    let chebyshev = null;
    let bitcrusher = null;
    let continuousOsc = null;
    let analyser = null;
    let currentType = 'distortion';
    let isVisualizationRunning = false;

    // Initialize audio
    async function initAudio() {
      // Main synth with distortion chain
      distortion = new Tone.Distortion({
        distortion: 0.2,
        wet: 1
      });

      chebyshev = new Tone.Chebyshev({
        order: 3,
        wet: 1
      });

      bitcrusher = new Tone.BitCrusher({
        bits: 8
      });

      // Main synth
      synth = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: 'sawtooth' },
        envelope: {
          attack: 0.01,
          decay: 0.2,
          sustain: 0.5,
          release: 0.5
        }
      });
      synth.volume.value = -12;

      // Clean synth for comparison
      cleanSynth = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: 'sawtooth' },
        envelope: {
          attack: 0.01,
          decay: 0.2,
          sustain: 0.5,
          release: 0.5
        }
      }).toDestination();
      cleanSynth.volume.value = -12;

      // Set default connection (distortion)
      synth.connect(distortion);
      distortion.toDestination();

      // Analyser for waveform
      analyser = new Tone.Analyser('waveform', 256);

      updateStatus('Ready! Click buttons to hear distortion effects.');
    }

    // Update status message
    function updateStatus(msg) {
      document.getElementById('status').textContent = msg;
    }

    // Switch distortion type
    function switchType(type) {
      currentType = type;

      // Disconnect synth from all effects
      synth.disconnect();

      // Hide all control panels
      document.getElementById('distortionControls').style.display = 'none';
      document.getElementById('chebyshevControls').style.display = 'none';
      document.getElementById('bitcrusherControls').style.display = 'none';

      // Update type selector buttons
      document.querySelectorAll('.type-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === type);
      });

      // Connect to appropriate effect and show controls
      const infoBox = document.getElementById('typeInfo');
      switch(type) {
        case 'distortion':
          synth.connect(distortion);
          distortion.toDestination();
          document.getElementById('distortionControls').style.display = 'grid';
          infoBox.innerHTML = '<strong>Distortion:</strong> Standard waveshaping distortion. Clips the waveform to add harmonics. Lower values (0.1-0.3) add warmth, higher values get aggressive.';
          break;
        case 'chebyshev':
          synth.connect(chebyshev);
          chebyshev.toDestination();
          document.getElementById('chebyshevControls').style.display = 'grid';
          infoBox.innerHTML = '<strong>Chebyshev:</strong> Polynomial waveshaping that adds specific harmonics based on the order. Lower orders (1-5) add subtle warmth, higher orders add more complex harmonics.';
          break;
        case 'bitcrusher':
          synth.connect(bitcrusher);
          bitcrusher.toDestination();
          document.getElementById('bitcrusherControls').style.display = 'grid';
          infoBox.innerHTML = '<strong>BitCrusher:</strong> Reduces bit depth for digital distortion. Creates that classic lo-fi sampler sound. 8 bits is the sweet spot for lofi.';
          break;
        case 'none':
          synth.toDestination();
          infoBox.innerHTML = '<strong>Bypass:</strong> Clean signal with no distortion. Use this to compare against the distorted versions.';
          break;
      }
    }

    // Apply preset
    function applyPreset(preset) {
      const presetInfo = document.getElementById('presetInfo');
      switch(preset) {
        case 'warmth':
          switchType('distortion');
          document.getElementById('distortionAmount').value = 0.15;
          document.getElementById('wetAmount').value = 0.5;
          updateDistortionParams();
          presetInfo.innerHTML = '<strong>Subtle Warmth:</strong> Light distortion (0.15) with 50% wet mix. Adds gentle saturation without being obvious.';
          break;
        case 'vintage':
          switchType('bitcrusher');
          document.getElementById('bitDepth').value = 8;
          updateBitcrusherParams();
          presetInfo.innerHTML = '<strong>Vintage Sampler:</strong> 8-bit crushing for that SP-404/MPC sound. Classic lo-fi hip hop texture.';
          break;
        case 'tape':
          switchType('chebyshev');
          document.getElementById('chebyshevOrder').value = 2;
          document.getElementById('chebyWet').value = 0.4;
          updateChebyshevParams();
          presetInfo.innerHTML = '<strong>Tape Saturation:</strong> Low-order Chebyshev (2) with 40% wet. Simulates the harmonic richness of tape.';
          break;
        case 'lofi-drums':
          switchType('bitcrusher');
          document.getElementById('bitDepth').value = 10;
          updateBitcrusherParams();
          presetInfo.innerHTML = '<strong>Lo-Fi Drums:</strong> 10-bit crushing - noticeable but not extreme. Great for adding crunch to drum loops.';
          break;
        case '8bit':
          switchType('bitcrusher');
          document.getElementById('bitDepth').value = 4;
          updateBitcrusherParams();
          presetInfo.innerHTML = '<strong>8-Bit Crunch:</strong> Heavy 4-bit crushing for retro game sounds. Very obvious effect!';
          break;
        case 'extreme':
          switchType('distortion');
          document.getElementById('distortionAmount').value = 0.8;
          document.getElementById('wetAmount').value = 1;
          updateDistortionParams();
          presetInfo.innerHTML = '<strong>Extreme:</strong> Heavy distortion for demonstration. NOT recommended for actual lofi production!';
          break;
      }
    }

    // Update parameter displays and effects
    function updateDistortionParams() {
      const amount = parseFloat(document.getElementById('distortionAmount').value);
      const wet = parseFloat(document.getElementById('wetAmount').value);
      document.getElementById('distortionVal').textContent = amount.toFixed(2);
      document.getElementById('wetVal').textContent = Math.round(wet * 100) + '%';
      document.getElementById('distortionMeter').style.width = (amount * 100) + '%';
      if (distortion) {
        distortion.distortion = amount;
        distortion.wet.value = wet;
      }
    }

    function updateChebyshevParams() {
      const order = parseInt(document.getElementById('chebyshevOrder').value);
      const wet = parseFloat(document.getElementById('chebyWet').value);
      document.getElementById('orderVal').textContent = order;
      document.getElementById('chebyWetVal').textContent = Math.round(wet * 100) + '%';
      document.getElementById('orderMeter').style.width = (order / 50 * 100) + '%';
      if (chebyshev) {
        chebyshev.order = order;
        chebyshev.wet.value = wet;
      }
    }

    function updateBitcrusherParams() {
      const bits = parseInt(document.getElementById('bitDepth').value);
      document.getElementById('bitsVal').textContent = bits;
      document.getElementById('bitsMeter').style.width = (bits / 16 * 100) + '%';
      if (bitcrusher) {
        bitcrusher.bits.value = bits;
      }
    }

    // Play functions
    async function playNote() {
      await Tone.start();
      synth.triggerAttackRelease('C4', '8n');
    }

    async function playChord() {
      await Tone.start();
      synth.triggerAttackRelease(['C4', 'E4', 'G4', 'B4'], '2n');
    }

    async function playClean() {
      await Tone.start();
      cleanSynth.triggerAttackRelease(['C4', 'E4', 'G4'], '4n');
    }

    async function playDistorted() {
      await Tone.start();
      synth.triggerAttackRelease(['C4', 'E4', 'G4'], '4n');
    }

    // BitCrusher demo
    let bitDemoSynth = null;
    let bitDemoCrusher = null;

    async function playBitDemo() {
      await Tone.start();

      if (!bitDemoSynth) {
        bitDemoCrusher = new Tone.BitCrusher({
          bits: parseInt(document.getElementById('deepBitDepth').value)
        }).toDestination();

        bitDemoSynth = new Tone.Synth({
          oscillator: { type: 'sawtooth' },
          envelope: {
            attack: 0.01,
            decay: 0.2,
            sustain: 0.3,
            release: 0.3
          }
        }).connect(bitDemoCrusher);
        bitDemoSynth.volume.value = -12;
      }

      bitDemoCrusher.bits.value = parseInt(document.getElementById('deepBitDepth').value);
      bitDemoSynth.triggerAttackRelease('C4', '4n');
    }

    // Waveform visualization
    let animationId = null;
    const canvas = document.getElementById('waveformCanvas');
    const ctx = canvas.getContext('2d');

    function resizeCanvas() {
      canvas.width = canvas.offsetWidth * window.devicePixelRatio;
      canvas.height = canvas.offsetHeight * window.devicePixelRatio;
      ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
    }

    function drawWaveform() {
      if (!analyser || !isVisualizationRunning) return;

      const width = canvas.offsetWidth;
      const height = canvas.offsetHeight;
      const values = analyser.getValue();

      ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
      ctx.fillRect(0, 0, width, height);

      ctx.beginPath();
      ctx.strokeStyle = '#e94560';
      ctx.lineWidth = 2;

      const sliceWidth = width / values.length;
      let x = 0;

      for (let i = 0; i < values.length; i++) {
        const v = values[i];
        const y = (v + 1) / 2 * height;

        if (i === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
        x += sliceWidth;
      }

      ctx.stroke();
      animationId = requestAnimationFrame(drawWaveform);
    }

    async function startVisualization() {
      await Tone.start();

      if (!continuousOsc) {
        continuousOsc = new Tone.Oscillator({
          frequency: 220,
          type: 'sawtooth'
        });
        continuousOsc.volume.value = -18;
      }

      // Disconnect and reconnect based on current type
      continuousOsc.disconnect();

      switch(currentType) {
        case 'distortion':
          continuousOsc.connect(distortion);
          distortion.connect(analyser);
          break;
        case 'chebyshev':
          continuousOsc.connect(chebyshev);
          chebyshev.connect(analyser);
          break;
        case 'bitcrusher':
          continuousOsc.connect(bitcrusher);
          bitcrusher.connect(analyser);
          break;
        default:
          continuousOsc.connect(analyser);
      }
      analyser.toDestination();

      continuousOsc.start();
      isVisualizationRunning = true;
      resizeCanvas();
      drawWaveform();

      document.getElementById('startVisualization').disabled = true;
      document.getElementById('stopVisualization').disabled = false;
    }

    function stopVisualization() {
      if (continuousOsc) {
        continuousOsc.stop();
      }
      isVisualizationRunning = false;
      if (animationId) {
        cancelAnimationFrame(animationId);
      }

      document.getElementById('startVisualization').disabled = false;
      document.getElementById('stopVisualization').disabled = true;
    }

    // Event listeners
    function setupEventListeners() {
      // Type selector
      document.querySelectorAll('.type-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          switchType(btn.dataset.type);
          if (isVisualizationRunning) {
            stopVisualization();
            startVisualization();
          }
        });
      });

      // Distortion controls
      document.getElementById('distortionAmount').addEventListener('input', updateDistortionParams);
      document.getElementById('wetAmount').addEventListener('input', updateDistortionParams);

      // Chebyshev controls
      document.getElementById('chebyshevOrder').addEventListener('input', updateChebyshevParams);
      document.getElementById('chebyWet').addEventListener('input', updateChebyshevParams);

      // BitCrusher controls
      document.getElementById('bitDepth').addEventListener('input', updateBitcrusherParams);

      // Play buttons
      document.getElementById('playDemo').addEventListener('click', playNote);
      document.getElementById('playChord').addEventListener('click', playChord);
      document.getElementById('playClean').addEventListener('click', playClean);
      document.getElementById('playDistorted').addEventListener('click', playDistorted);

      // Preset buttons
      document.querySelectorAll('.preset-btn[data-preset]').forEach(btn => {
        btn.addEventListener('click', () => applyPreset(btn.dataset.preset));
      });

      // BitCrusher deep dive
      document.getElementById('deepBitDepth').addEventListener('input', (e) => {
        document.getElementById('deepBitsVal').textContent = e.target.value;
      });

      document.querySelectorAll('.preset-btn[data-bits]').forEach(btn => {
        btn.addEventListener('click', () => {
          const bits = parseInt(btn.dataset.bits);
          document.getElementById('deepBitDepth').value = bits;
          document.getElementById('deepBitsVal').textContent = bits;
        });
      });

      document.getElementById('playBitDemo').addEventListener('click', playBitDemo);

      // Visualization
      document.getElementById('startVisualization').addEventListener('click', startVisualization);
      document.getElementById('stopVisualization').addEventListener('click', stopVisualization);

      // Handle window resize
      window.addEventListener('resize', resizeCanvas);
    }

    // Initialize
    async function init() {
      await initAudio();
      setupEventListeners();
      resizeCanvas();
    }

    init();
  </script>
</body>
</html>
