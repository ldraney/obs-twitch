<!DOCTYPE html>
<html>
<head>
  <title>Project 3: Groove Master - Demo</title>
  <script src="https://unpkg.com/tone@14"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #eee;
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      user-select: none;
    }
    .container { max-width: 1000px; margin: 0 auto; }
    h1 { color: #e94560; margin-bottom: 10px; }
    h2 { color: #4ecdc4; margin-top: 30px; font-size: 18px; }
    .subtitle { color: #888; margin-bottom: 30px; }

    .section {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }

    button {
      background: #e94560;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 8px;
      margin: 5px;
      transition: transform 0.1s, background 0.2s;
    }
    button:hover { background: #ff6b6b; transform: scale(1.02); }
    button:active { transform: scale(0.98); }
    button:disabled { background: #444; cursor: not-allowed; transform: none; }
    button.secondary {
      background: #4ecdc4;
      color: #1a1a2e;
    }
    button.secondary:hover { background: #6ee7df; }
    button.active {
      box-shadow: 0 0 15px rgba(233, 69, 96, 0.5);
    }

    #status {
      text-align: center;
      padding: 10px;
      color: #888;
      font-size: 14px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      margin: 10px 0;
    }
    #status.loading { color: #ffd700; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    .info-box {
      background: rgba(78, 205, 196, 0.1);
      border-left: 4px solid #4ecdc4;
      padding: 15px;
      margin: 15px 0;
      border-radius: 0 8px 8px 0;
    }
    .info-box.tip {
      background: rgba(255, 215, 0, 0.1);
      border-left-color: #ffd700;
    }
    .info-box.compare {
      background: rgba(233, 69, 96, 0.1);
      border-left-color: #e94560;
    }

    /* Transport controls */
    .transport {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 20px 0;
      align-items: center;
    }
    .play-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      font-size: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }
    .play-btn.playing { background: #4ecdc4; }

    /* Controls grid */
    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .control-card {
      background: rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 8px;
    }
    .control-card label {
      display: block;
      color: #888;
      font-size: 12px;
      margin-bottom: 8px;
      text-transform: uppercase;
    }
    .control-card .value {
      color: #e94560;
      font-weight: bold;
      float: right;
    }
    .control-card input[type="range"] {
      width: 100%;
      margin-top: 5px;
      accent-color: #e94560;
    }

    /* Toggle switches */
    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .toggle-row:last-child { border-bottom: none; }
    .toggle-label {
      color: #ccc;
      font-size: 14px;
    }
    .toggle {
      position: relative;
      width: 50px;
      height: 26px;
      background: rgba(0,0,0,0.3);
      border-radius: 13px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .toggle.on { background: #4ecdc4; }
    .toggle-knob {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: left 0.2s;
    }
    .toggle.on .toggle-knob { left: 27px; }
    .toggle-status {
      font-size: 12px;
      color: #888;
      margin-left: 10px;
      min-width: 30px;
    }
    .toggle.on + .toggle-status { color: #4ecdc4; }

    /* A/B Comparison */
    .ab-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }
    .ab-box {
      background: rgba(0,0,0,0.2);
      padding: 25px;
      border-radius: 12px;
      text-align: center;
      border: 3px solid transparent;
      transition: all 0.3s;
      cursor: pointer;
    }
    .ab-box:hover { border-color: #555; }
    .ab-box.active { border-color: #e94560; background: rgba(233, 69, 96, 0.1); }
    .ab-box.groovy.active { border-color: #4ecdc4; background: rgba(78, 205, 196, 0.1); }
    .ab-box h3 {
      margin: 0 0 10px 0;
      font-size: 22px;
    }
    .ab-box.robotic h3 { color: #888; }
    .ab-box.groovy h3 { color: #4ecdc4; }
    .ab-box p { color: #666; font-size: 13px; margin: 10px 0 0 0; }

    /* Drum grid visualization */
    .drum-grid {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 20px 0;
    }
    .drum-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .drum-label {
      width: 60px;
      color: #888;
      font-size: 12px;
      text-align: right;
    }
    .steps {
      display: flex;
      gap: 3px;
      flex: 1;
    }
    .step {
      flex: 1;
      height: 40px;
      background: rgba(0,0,0,0.3);
      border-radius: 4px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      position: relative;
      min-width: 20px;
    }
    .step.downbeat { border-top: 2px solid #e94560; }
    .step.playing { background: rgba(233, 69, 96, 0.4); }
    .velocity-bar {
      width: 70%;
      background: linear-gradient(to top, #e94560, #ff6b6b);
      border-radius: 2px 2px 0 0;
      transition: height 0.05s;
    }
    .velocity-bar.ghost {
      background: linear-gradient(to top, #4ecdc4, #6ee7df);
      opacity: 0.7;
    }
    .beat-markers {
      display: flex;
      gap: 3px;
      margin-left: 68px;
      margin-bottom: 5px;
    }
    .beat-markers span {
      flex: 1;
      text-align: center;
      font-size: 10px;
      color: #555;
      min-width: 20px;
    }
    .beat-markers span.main { color: #e94560; font-weight: bold; }

    /* Legend */
    .legend {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin: 15px 0;
      flex-wrap: wrap;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #888;
    }
    .legend-box {
      width: 14px;
      height: 14px;
      border-radius: 3px;
    }
    .legend-box.main { background: linear-gradient(to top, #e94560, #ff6b6b); }
    .legend-box.ghost { background: linear-gradient(to top, #4ecdc4, #6ee7df); opacity: 0.7; }

    /* BPM display */
    .bpm-display {
      text-align: center;
      background: rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    .bpm-value {
      font-size: 36px;
      font-weight: bold;
      color: #e94560;
    }
    .bpm-label {
      font-size: 12px;
      color: #888;
      text-transform: uppercase;
    }

    @media (max-width: 600px) {
      .ab-container { grid-template-columns: 1fr; }
      .controls-grid { grid-template-columns: 1fr; }
      .step { min-width: 15px; height: 30px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Project 3: Groove Master</h1>
    <p class="subtitle">Transform a robotic beat into a groovy, head-nodding lofi beat</p>

    <div id="status" class="loading">Initializing...</div>

    <!-- A/B Comparison -->
    <div class="section">
      <h2>A/B Comparison</h2>
      <p>Click to switch between robotic and groovy versions. Hear the difference swing, ghost notes, and velocity make.</p>

      <div class="ab-container">
        <div class="ab-box robotic" id="roboticBox">
          <h3>Robotic</h3>
          <p>No swing, no ghosts, identical velocities</p>
        </div>
        <div class="ab-box groovy active" id="groovyBox">
          <h3>Groovy</h3>
          <p>Swing + ghost notes + velocity variation</p>
        </div>
      </div>

      <div class="info-box compare">
        <strong>What to listen for:</strong> The robotic version sounds stiff and mechanical. The groovy version breathes and makes you nod your head.
      </div>
    </div>

    <!-- Transport -->
    <div class="section">
      <div class="transport">
        <button class="play-btn" id="playBtn">&#9658;</button>
        <button class="secondary" id="stopBtn">Stop</button>
      </div>

      <div class="bpm-display">
        <div class="bpm-value" id="bpmValue">85</div>
        <div class="bpm-label">BPM</div>
      </div>
    </div>

    <!-- Drum Grid Visualization -->
    <div class="section">
      <h2>Drum Pattern</h2>
      <p>Watch the pattern play. Teal bars are ghost notes - quieter hits that add texture.</p>

      <div class="legend">
        <div class="legend-item"><div class="legend-box main"></div>Main hits</div>
        <div class="legend-item"><div class="legend-box ghost"></div>Ghost notes</div>
      </div>

      <div class="beat-markers">
        <span class="main">1</span><span>e</span><span>+</span><span>a</span>
        <span class="main">2</span><span>e</span><span>+</span><span>a</span>
        <span class="main">3</span><span>e</span><span>+</span><span>a</span>
        <span class="main">4</span><span>e</span><span>+</span><span>a</span>
      </div>

      <div class="drum-grid" id="drumGrid">
        <!-- Built by JS -->
      </div>
    </div>

    <!-- Controls -->
    <div class="section">
      <h2>Groove Controls</h2>

      <div class="controls-grid">
        <div class="control-card">
          <label>Swing Amount <span class="value" id="swingValue">0.20</span></label>
          <input type="range" id="swingSlider" min="0" max="0.5" step="0.01" value="0.2">
        </div>
        <div class="control-card">
          <label>Velocity Variation <span class="value" id="variationValue">10%</span></label>
          <input type="range" id="variationSlider" min="0" max="30" step="1" value="10">
        </div>
        <div class="control-card">
          <label>Tempo <span class="value" id="tempoValue">85 BPM</span></label>
          <input type="range" id="tempoSlider" min="60" max="120" step="1" value="85">
        </div>
      </div>
    </div>

    <!-- Toggles -->
    <div class="section">
      <h2>Feature Toggles</h2>
      <p>Toggle each feature on/off to hear what it contributes to the groove.</p>

      <div class="toggle-row">
        <span class="toggle-label">Ghost Notes</span>
        <div style="display: flex; align-items: center;">
          <div class="toggle on" id="ghostToggle"><div class="toggle-knob"></div></div>
          <span class="toggle-status" id="ghostStatus">ON</span>
        </div>
      </div>

      <div class="toggle-row">
        <span class="toggle-label">Bass Line</span>
        <div style="display: flex; align-items: center;">
          <div class="toggle on" id="bassToggle"><div class="toggle-knob"></div></div>
          <span class="toggle-status" id="bassStatus">ON</span>
        </div>
      </div>

      <div class="info-box tip">
        <strong>Tip:</strong> Try turning off ghost notes while the beat plays. Notice how the pattern suddenly feels empty and mechanical?
      </div>
    </div>
  </div>

  <script>
    // State
    let isPlaying = false;
    let isGroovy = true;
    let ghostsEnabled = true;
    let bassEnabled = true;
    let variationAmount = 0.1;
    let currentStep = -1;

    // Instruments
    let kick, snare, hihat, bass;
    let kickSeq, snareSeq, hihatSeq, bassPart;

    // Patterns
    const STEPS = 16;

    const kickPattern = [0, null, null, null, null, null, 0, null, 0, null, null, null, null, null, null, null];
    const snarePattern = [null, null, null, null, 0, null, null, null, null, null, null, null, 0, null, null, null];

    const hihatPattern = [
      { step: 0, vel: 0.7, ghost: false },
      { step: 1, vel: 0.15, ghost: true },
      { step: 2, vel: 0.65, ghost: false },
      { step: 3, vel: 0.18, ghost: true },
      { step: 4, vel: 0.7, ghost: false },
      { step: 5, vel: 0.12, ghost: true },
      { step: 6, vel: 0.65, ghost: false },
      { step: 7, vel: 0.2, ghost: true },
      { step: 8, vel: 0.7, ghost: false },
      { step: 9, vel: 0.15, ghost: true },
      { step: 10, vel: 0.65, ghost: false },
      { step: 11, vel: 0.18, ghost: true },
      { step: 12, vel: 0.7, ghost: false },
      { step: 13, vel: 0.12, ghost: true },
      { step: 14, vel: 0.65, ghost: false },
      { step: 15, vel: 0.2, ghost: true },
    ];

    const bassNotes = [
      { time: '0:0', note: 'D2' },
      { time: '1:0', note: 'G2' },
      { time: '2:0', note: 'C3' },
      { time: '3:0', note: 'A2' },
    ];

    // Humanization
    function humanize(baseVelocity, variation) {
      if (!isGroovy || variation === 0) return baseVelocity;
      const offset = (Math.random() - 0.5) * 2 * variation;
      return Math.max(0.1, Math.min(1, baseVelocity + offset));
    }

    function updateStatus(msg, loading = false) {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.className = loading ? 'loading' : '';
    }

    // Build drum grid UI
    function buildDrumGrid() {
      const grid = document.getElementById('drumGrid');
      grid.innerHTML = '';

      const instruments = [
        { name: 'Hi-hat', id: 'hihat' },
        { name: 'Snare', id: 'snare' },
        { name: 'Kick', id: 'kick' },
      ];

      instruments.forEach(inst => {
        const row = document.createElement('div');
        row.className = 'drum-row';

        const label = document.createElement('div');
        label.className = 'drum-label';
        label.textContent = inst.name;
        row.appendChild(label);

        const steps = document.createElement('div');
        steps.className = 'steps';

        for (let i = 0; i < STEPS; i++) {
          const step = document.createElement('div');
          step.className = 'step';
          if (i % 4 === 0) step.classList.add('downbeat');
          step.id = `${inst.id}-step-${i}`;

          const bar = document.createElement('div');
          bar.className = 'velocity-bar';
          bar.id = `${inst.id}-bar-${i}`;
          step.appendChild(bar);

          steps.appendChild(step);
        }

        row.appendChild(steps);
        grid.appendChild(row);
      });

      updateGridVisuals();
    }

    function updateGridVisuals() {
      // Kick
      for (let i = 0; i < STEPS; i++) {
        const bar = document.getElementById(`kick-bar-${i}`);
        if (kickPattern[i] !== null) {
          bar.style.height = '90%';
          bar.classList.remove('ghost');
        } else {
          bar.style.height = '0';
        }
      }

      // Snare
      for (let i = 0; i < STEPS; i++) {
        const bar = document.getElementById(`snare-bar-${i}`);
        if (snarePattern[i] !== null) {
          bar.style.height = '90%';
          bar.classList.remove('ghost');
        } else {
          bar.style.height = '0';
        }
      }

      // Hi-hat with ghost notes
      for (let i = 0; i < STEPS; i++) {
        const bar = document.getElementById(`hihat-bar-${i}`);
        const note = hihatPattern.find(n => n.step === i);

        if (note) {
          if (note.ghost && !ghostsEnabled) {
            bar.style.height = '0';
            bar.classList.remove('ghost');
          } else {
            bar.style.height = (note.vel * 100) + '%';
            if (note.ghost) {
              bar.classList.add('ghost');
            } else {
              bar.classList.remove('ghost');
            }
          }
        } else {
          bar.style.height = '0';
        }
      }
    }

    function highlightStep(step) {
      document.querySelectorAll('.step').forEach(s => s.classList.remove('playing'));
      document.querySelectorAll(`.step:nth-child(${step + 1})`).forEach(s => s.classList.add('playing'));

      // More specific targeting
      ['kick', 'snare', 'hihat'].forEach(inst => {
        const stepEl = document.getElementById(`${inst}-step-${step}`);
        if (stepEl) stepEl.classList.add('playing');
      });
    }

    // Initialize instruments - MUST be called after Tone.start()
    let isInitialized = false;
    async function init() {
      if (isInitialized) return;
      updateStatus('Creating instruments...', true);

      kick = new Tone.MembraneSynth({
        pitchDecay: 0.05,
        octaves: 6,
        oscillator: { type: 'sine' },
        envelope: { attack: 0.001, decay: 0.3, sustain: 0, release: 0.1 }
      }).toDestination();
      kick.volume.value = -6;

      snare = new Tone.NoiseSynth({
        noise: { type: 'white' },
        envelope: { attack: 0.001, decay: 0.15, sustain: 0, release: 0.05 }
      }).toDestination();
      snare.volume.value = -10;

      hihat = new Tone.MetalSynth({
        frequency: 200,
        envelope: { attack: 0.001, decay: 0.05, release: 0.01 },
        harmonicity: 5.1,
        modulationIndex: 32,
        resonance: 4000,
        octaves: 1.5
      }).toDestination();
      hihat.volume.value = -18;

      bass = new Tone.MonoSynth({
        oscillator: { type: 'triangle' },
        filter: { type: 'lowpass', frequency: 800, Q: 1 },
        envelope: { attack: 0.05, decay: 0.3, sustain: 0.6, release: 0.5 },
        filterEnvelope: {
          attack: 0.1, decay: 0.2, sustain: 0.4, release: 0.5,
          baseFrequency: 200, octaves: 2
        }
      }).toDestination();
      bass.volume.value = -8;

      buildDrumGrid();

      isInitialized = true;
      updateStatus('Ready! Click Play to hear the groove.');
    }

    function createSequences() {
      // Kick - chain .start(0) immediately like the working original
      kickSeq = new Tone.Sequence((time, val) => {
        if (val !== null) {
          const vel = humanize(0.9, variationAmount);
          kick.triggerAttackRelease('C1', '8n', time, vel);
        }
      }, kickPattern, '16n').start(0);

      // Snare
      snareSeq = new Tone.Sequence((time, val) => {
        if (val !== null) {
          const vel = humanize(0.9, variationAmount);
          snare.triggerAttackRelease('16n', time, vel);
        }
      }, snarePattern, '16n').start(0);

      // Hi-hat with step tracking
      hihatSeq = new Tone.Sequence((time, stepIdx) => {
        // Update visual
        Tone.Draw.schedule(() => {
          highlightStep(stepIdx);
        }, time);

        const note = hihatPattern.find(n => n.step === stepIdx);
        if (note) {
          if (note.ghost && !ghostsEnabled) return;
          if (!isGroovy && note.ghost) return;

          let vel = note.vel;
          if (!isGroovy) vel = 0.7; // Flat velocity in robotic mode
          vel = humanize(vel, variationAmount);

          hihat.triggerAttackRelease('32n', time, vel);
        }
      }, Array.from({length: STEPS}, (_, i) => i), '16n').start(0);

      // Bass
      bassPart = new Tone.Part((time, event) => {
        if (bassEnabled) {
          const vel = humanize(0.8, variationAmount);
          bass.triggerAttackRelease(event.note, '2n', time, vel);
        }
      }, bassNotes);
      bassPart.loop = true;
      bassPart.loopEnd = '4m';
      bassPart.start(0);
    }

    let sequencesCreated = false;

    async function startPlayback() {
      await Tone.start();
      await init();

      // Create sequences after Tone.start() to avoid timing issues
      if (!sequencesCreated) {
        createSequences();
        sequencesCreated = true;
      }

      if (!isPlaying) {
        // Sequences are already started at creation time
        // Just start the transport
        Tone.Transport.start();
        isPlaying = true;

        document.getElementById('playBtn').innerHTML = '&#10074;&#10074;';
        document.getElementById('playBtn').classList.add('playing');
        updateStatus('Playing - ' + (isGroovy ? 'Groovy mode' : 'Robotic mode'));
      } else {
        Tone.Transport.pause();
        isPlaying = false;
        document.getElementById('playBtn').innerHTML = '&#9658;';
        document.getElementById('playBtn').classList.remove('playing');
        updateStatus('Paused');
      }
    }

    function stopPlayback() {
      Tone.Transport.stop();
      Tone.Transport.position = 0;
      isPlaying = false;

      document.querySelectorAll('.step').forEach(s => s.classList.remove('playing'));
      document.getElementById('playBtn').innerHTML = '&#9658;';
      document.getElementById('playBtn').classList.remove('playing');
      updateStatus('Stopped');
    }

    function setGroovyMode(groovy) {
      isGroovy = groovy;

      // Update UI
      document.getElementById('roboticBox').classList.toggle('active', !groovy);
      document.getElementById('groovyBox').classList.toggle('active', groovy);

      // Update transport swing
      if (groovy) {
        Tone.Transport.swing = parseFloat(document.getElementById('swingSlider').value);
      } else {
        Tone.Transport.swing = 0;
      }

      updateGridVisuals();

      if (isPlaying) {
        updateStatus('Playing - ' + (groovy ? 'Groovy mode' : 'Robotic mode'));
      }
    }

    function setupEventListeners() {
      // Play/Stop
      document.getElementById('playBtn').addEventListener('click', startPlayback);
      document.getElementById('stopBtn').addEventListener('click', stopPlayback);

      // A/B boxes
      document.getElementById('roboticBox').addEventListener('click', () => setGroovyMode(false));
      document.getElementById('groovyBox').addEventListener('click', () => setGroovyMode(true));

      // Swing slider
      document.getElementById('swingSlider').addEventListener('input', (e) => {
        const val = parseFloat(e.target.value);
        document.getElementById('swingValue').textContent = val.toFixed(2);
        if (isGroovy) {
          Tone.Transport.swing = val;
        }
      });

      // Variation slider
      document.getElementById('variationSlider').addEventListener('input', (e) => {
        variationAmount = parseInt(e.target.value) / 100;
        document.getElementById('variationValue').textContent = e.target.value + '%';
      });

      // Tempo slider
      document.getElementById('tempoSlider').addEventListener('input', (e) => {
        const bpm = parseInt(e.target.value);
        Tone.Transport.bpm.value = bpm;
        document.getElementById('tempoValue').textContent = bpm + ' BPM';
        document.getElementById('bpmValue').textContent = bpm;
      });

      // Ghost toggle
      document.getElementById('ghostToggle').addEventListener('click', () => {
        ghostsEnabled = !ghostsEnabled;
        const toggle = document.getElementById('ghostToggle');
        const status = document.getElementById('ghostStatus');
        toggle.classList.toggle('on', ghostsEnabled);
        status.textContent = ghostsEnabled ? 'ON' : 'OFF';
        status.style.color = ghostsEnabled ? '#4ecdc4' : '#888';
        updateGridVisuals();
      });

      // Bass toggle
      document.getElementById('bassToggle').addEventListener('click', () => {
        bassEnabled = !bassEnabled;
        const toggle = document.getElementById('bassToggle');
        const status = document.getElementById('bassStatus');
        toggle.classList.toggle('on', bassEnabled);
        status.textContent = bassEnabled ? 'ON' : 'OFF';
        status.style.color = bassEnabled ? '#4ecdc4' : '#888';
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', async (e) => {
        switch(e.key.toLowerCase()) {
          case ' ':
            e.preventDefault();
            await startPlayback();
            break;
          case 'r':
            setGroovyMode(false);
            break;
          case 'g':
            setGroovyMode(true);
            break;
          case 'b':
            document.getElementById('bassToggle').click();
            break;
          case 'h':
            document.getElementById('ghostToggle').click();
            break;
        }
      });
    }

    // Initialize - only set up transport and event listeners at page load
    // Synths are created on first user interaction (in startPlayback)
    function main() {
      Tone.Transport.bpm.value = 85;
      Tone.Transport.swing = 0.2;
      Tone.Transport.swingSubdivision = '16n';

      setupEventListeners();
      updateStatus('Ready! Click Play to hear the groove.');
    }

    main();
  </script>
</body>
</html>
