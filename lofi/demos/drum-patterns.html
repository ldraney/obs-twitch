<!DOCTYPE html>
<html>
<head>
  <title>Drum Patterns - Demo</title>
  <script src="https://unpkg.com/tone@14"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #eee;
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .container { max-width: 900px; margin: 0 auto; }
    h1 { color: #e94560; margin-bottom: 10px; }
    h2 { color: #4ecdc4; margin-top: 30px; }
    .subtitle { color: #888; margin-bottom: 30px; }

    .section {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }

    button {
      background: #e94560;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 8px;
      margin: 5px;
      transition: transform 0.1s, background 0.2s;
    }
    button:hover { background: #ff6b6b; transform: scale(1.02); }
    button:active { transform: scale(0.98); }
    button:disabled { background: #444; cursor: not-allowed; transform: none; }
    button.secondary { background: #4ecdc4; }
    button.secondary:hover { background: #6ee7df; }
    button.active {
      background: #6ee7df;
      color: #1a1a2e;
    }

    #status {
      text-align: center;
      padding: 10px;
      color: #888;
      font-size: 14px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      margin: 10px 0;
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 15px;
      margin: 15px 0;
      flex-wrap: wrap;
    }

    .control {
      background: rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .control label {
      color: #888;
      font-size: 12px;
      min-width: 50px;
    }
    .control .value {
      color: #e94560;
      font-weight: bold;
      min-width: 60px;
      text-align: right;
    }
    .control input[type="range"] {
      width: 120px;
      accent-color: #e94560;
    }

    .transport-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 20px 0;
    }

    .play-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }
    .play-btn.playing { background: #4ecdc4; }

    /* Step Sequencer Grid */
    .sequencer {
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
      padding: 20px;
      overflow-x: auto;
    }

    .sequencer-grid {
      display: grid;
      grid-template-columns: 100px repeat(16, 1fr);
      gap: 4px;
      min-width: 700px;
    }

    .row-label {
      background: rgba(78, 205, 196, 0.2);
      border-radius: 6px;
      padding: 10px;
      font-size: 13px;
      font-weight: bold;
      color: #4ecdc4;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .step-header {
      text-align: center;
      font-size: 10px;
      color: #555;
      padding: 5px 0;
    }
    .step-header.beat { color: #888; font-weight: bold; }

    .step {
      aspect-ratio: 1;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.1s;
      border: 2px solid transparent;
      min-height: 35px;
    }
    .step:hover { background: rgba(255,255,255,0.15); }
    .step.active {
      background: #e94560;
      border-color: #ff6b6b;
    }
    .step.playing {
      border-color: #ffd700;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }
    .step.beat-marker { background: rgba(255,255,255,0.08); }

    /* Row-specific colors */
    .step.kick.active { background: #e94560; border-color: #ff6b6b; }
    .step.snare.active { background: #4ecdc4; border-color: #6ee7df; }
    .step.hihat.active { background: #ffd700; border-color: #ffeb3b; }
    .step.open.active { background: #9b59b6; border-color: #b370cf; }

    /* Presets */
    .presets {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      margin: 15px 0;
    }
    .preset-btn {
      background: rgba(78, 205, 196, 0.2);
      border: 1px solid #4ecdc4;
      color: #4ecdc4;
      padding: 10px 20px;
      font-size: 14px;
    }
    .preset-btn:hover { background: rgba(78, 205, 196, 0.3); }
    .preset-btn.active {
      background: #4ecdc4;
      color: #1a1a2e;
    }

    .info-box {
      background: rgba(78, 205, 196, 0.1);
      border-left: 4px solid #4ecdc4;
      padding: 15px;
      margin: 15px 0;
      border-radius: 0 8px 8px 0;
    }
    .info-box.tip {
      background: rgba(255, 215, 0, 0.1);
      border-left-color: #ffd700;
    }

    .legend {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin: 15px 0;
      flex-wrap: wrap;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #888;
    }
    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
    }
    .legend-color.kick { background: #e94560; }
    .legend-color.snare { background: #4ecdc4; }
    .legend-color.hihat { background: #ffd700; }
    .legend-color.open { background: #9b59b6; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Drum Patterns</h1>
    <p class="subtitle">Interactive step sequencer for lofi drum patterns</p>

    <div id="status">Click Play to start the sequencer</div>

    <div class="section">
      <h2>Step Sequencer</h2>
      <p>Click cells to toggle drum hits. The playhead shows the current step.</p>

      <div class="legend">
        <div class="legend-item"><div class="legend-color kick"></div>Kick</div>
        <div class="legend-item"><div class="legend-color snare"></div>Snare</div>
        <div class="legend-item"><div class="legend-color hihat"></div>Hi-hat (Closed)</div>
        <div class="legend-item"><div class="legend-color open"></div>Hi-hat (Open)</div>
      </div>

      <div class="sequencer">
        <div class="sequencer-grid" id="grid">
          <!-- Header row -->
          <div class="step-header"></div>
          <div class="step-header beat">1</div>
          <div class="step-header">.</div>
          <div class="step-header">.</div>
          <div class="step-header">.</div>
          <div class="step-header beat">2</div>
          <div class="step-header">.</div>
          <div class="step-header">.</div>
          <div class="step-header">.</div>
          <div class="step-header beat">3</div>
          <div class="step-header">.</div>
          <div class="step-header">.</div>
          <div class="step-header">.</div>
          <div class="step-header beat">4</div>
          <div class="step-header">.</div>
          <div class="step-header">.</div>
          <div class="step-header">.</div>

          <!-- Kick row -->
          <div class="row-label">Kick</div>
          <!-- Steps filled by JS -->

          <!-- Snare row -->
          <div class="row-label">Snare</div>
          <!-- Steps filled by JS -->

          <!-- Hi-hat (closed) row -->
          <div class="row-label">Hi-hat</div>
          <!-- Steps filled by JS -->

          <!-- Hi-hat (open) row -->
          <div class="row-label">Open Hat</div>
          <!-- Steps filled by JS -->
        </div>
      </div>

      <div class="transport-buttons">
        <button class="play-btn" id="playBtn">&#9658;</button>
        <button class="secondary" id="clearBtn">Clear All</button>
      </div>

      <div class="controls" style="justify-content: center;">
        <div class="control">
          <label>BPM</label>
          <input type="range" id="bpm" min="60" max="120" value="85">
          <span class="value" id="bpmVal">85</span>
        </div>
        <div class="control">
          <label>Swing</label>
          <input type="range" id="swing" min="0" max="0.5" step="0.05" value="0">
          <span class="value" id="swingVal">0%</span>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>Preset Patterns</h2>
      <p>Load classic lofi drum patterns:</p>

      <div class="presets">
        <button class="preset-btn" id="presetBoomBap">Basic Boom Bap</button>
        <button class="preset-btn" id="presetDilla">J Dilla Style</button>
        <button class="preset-btn" id="presetMinimal">Minimal</button>
        <button class="preset-btn" id="presetBusy">Busy</button>
      </div>

      <div id="presetInfo" class="info-box tip" style="display: none;"></div>
    </div>

    <div class="section">
      <h2>Sound Test</h2>
      <p>Click to hear individual drum sounds:</p>

      <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
        <button id="testKick">Kick</button>
        <button id="testSnare" class="secondary">Snare</button>
        <button id="testHihat" style="background: #ffd700; color: #1a1a2e;">Hi-hat</button>
        <button id="testOpen" style="background: #9b59b6;">Open Hat</button>
      </div>
    </div>

    <div class="info-box">
      <strong>Tips:</strong>
      <ul style="margin: 10px 0; padding-left: 20px; color: #aaa;">
        <li>Classic boom-bap: kick on 1 and 3, snare on 2 and 4</li>
        <li>Add swing for a more human, groovy feel</li>
        <li>Open hats before closed hats create anticipation</li>
        <li>Less is often more in lofi - leave space!</li>
      </ul>
    </div>
  </div>

  <script>
    // Pattern state: 4 rows x 16 steps
    const pattern = {
      kick:  [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      snare: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      hihat: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      open:  [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
    };

    let isPlaying = false;
    let currentStep = -1;
    let stepElements = { kick: [], snare: [], hihat: [], open: [] };

    // Drum synths
    let kick, snare, hihat, openHat, hihatFilter;

    // Sequences
    let mainLoop = null;

    // Initialize drum sounds
    function initDrums() {
      // Kick - MembraneSynth
      kick = new Tone.MembraneSynth({
        pitchDecay: 0.05,
        octaves: 4,
        oscillator: { type: 'sine' },
        envelope: {
          attack: 0.001,
          decay: 0.4,
          sustain: 0,
          release: 0.4
        }
      }).toDestination();
      kick.volume.value = -6;

      // Snare - NoiseSynth
      snare = new Tone.NoiseSynth({
        noise: { type: 'white' },
        envelope: {
          attack: 0.001,
          decay: 0.15,
          sustain: 0,
          release: 0.1
        }
      }).toDestination();
      snare.volume.value = -10;

      // Hi-hat filter (shared)
      hihatFilter = new Tone.Filter(8000, 'lowpass').toDestination();

      // Closed hi-hat
      hihat = new Tone.NoiseSynth({
        noise: { type: 'white' },
        envelope: {
          attack: 0.001,
          decay: 0.08,
          sustain: 0,
          release: 0.05
        }
      }).connect(hihatFilter);
      hihat.volume.value = -12;

      // Open hi-hat
      openHat = new Tone.NoiseSynth({
        noise: { type: 'white' },
        envelope: {
          attack: 0.001,
          decay: 0.25,
          sustain: 0.05,
          release: 0.15
        }
      }).connect(hihatFilter);
      openHat.volume.value = -14;
    }

    // Build the sequencer grid
    function buildGrid() {
      const grid = document.getElementById('grid');
      const rows = ['kick', 'snare', 'hihat', 'open'];

      rows.forEach(row => {
        // Row label already exists in HTML
        // Add 16 step cells
        for (let i = 0; i < 16; i++) {
          const step = document.createElement('div');
          step.className = `step ${row}`;
          if (i % 4 === 0) step.classList.add('beat-marker');
          step.dataset.row = row;
          step.dataset.step = i;

          step.addEventListener('click', () => toggleStep(row, i, step));

          grid.appendChild(step);
          stepElements[row].push(step);
        }
      });
    }

    // Toggle a step on/off
    function toggleStep(row, stepIndex, element) {
      pattern[row][stepIndex] = pattern[row][stepIndex] ? 0 : 1;
      element.classList.toggle('active', pattern[row][stepIndex]);
    }

    // Update visual playhead
    function updatePlayhead(step) {
      // Remove previous playhead
      document.querySelectorAll('.step.playing').forEach(el => {
        el.classList.remove('playing');
      });

      if (step >= 0) {
        Object.keys(stepElements).forEach(row => {
          stepElements[row][step].classList.add('playing');
        });
      }
    }

    // Main sequencer loop
    function createLoop() {
      mainLoop = new Tone.Sequence((time, step) => {
        currentStep = step;

        // Visual update on next frame
        Tone.Draw.schedule(() => {
          updatePlayhead(step);
        }, time);

        // Play sounds
        if (pattern.kick[step]) {
          kick.triggerAttackRelease('C1', '8n', time);
        }
        if (pattern.snare[step]) {
          snare.triggerAttackRelease('8n', time);
        }
        if (pattern.hihat[step]) {
          hihat.triggerAttackRelease('16n', time);
        }
        if (pattern.open[step]) {
          openHat.triggerAttackRelease('8n', time);
        }
      }, [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15], '16n');

      mainLoop.start(0);
    }

    // Play/Stop
    async function togglePlayback() {
      await Tone.start();

      if (isPlaying) {
        Tone.Transport.stop();
        Tone.Transport.position = 0;
        isPlaying = false;
        currentStep = -1;
        updatePlayhead(-1);
        document.getElementById('playBtn').innerHTML = '&#9658;';
        document.getElementById('playBtn').classList.remove('playing');
        document.getElementById('status').textContent = 'Stopped';
      } else {
        Tone.Transport.start();
        isPlaying = true;
        document.getElementById('playBtn').innerHTML = '&#9632;';
        document.getElementById('playBtn').classList.add('playing');
        document.getElementById('status').textContent = 'Playing...';
      }
    }

    // Clear all steps
    function clearPattern() {
      Object.keys(pattern).forEach(row => {
        for (let i = 0; i < 16; i++) {
          pattern[row][i] = 0;
          stepElements[row][i].classList.remove('active');
        }
      });
      document.getElementById('presetInfo').style.display = 'none';
    }

    // Load a preset
    function loadPreset(name, data, description) {
      clearPattern();
      Object.keys(data).forEach(row => {
        data[row].forEach((val, i) => {
          pattern[row][i] = val;
          if (val) stepElements[row][i].classList.add('active');
        });
      });

      // Show preset info
      const info = document.getElementById('presetInfo');
      info.innerHTML = `<strong>${name}:</strong> ${description}`;
      info.style.display = 'block';

      // Highlight active preset button
      document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
    }

    // Presets
    const presets = {
      boomBap: {
        kick:  [1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],
        snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
        hihat: [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],
        open:  [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
      },
      dilla: {
        kick:  [1,0,0,0,0,0,1,0,1,0,0,1,0,0,0,0],
        snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,1],
        hihat: [0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],
        open:  [0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0]
      },
      minimal: {
        kick:  [1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],
        snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
        hihat: [0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],
        open:  [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
      },
      busy: {
        kick:  [1,0,0,1,0,0,1,0,1,0,1,0,0,0,1,0],
        snare: [0,0,0,0,1,0,0,0,0,0,0,1,1,0,0,1],
        hihat: [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        open:  [0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1]
      }
    };

    // Event listeners
    function setupEventListeners() {
      // Play/Stop
      document.getElementById('playBtn').addEventListener('click', togglePlayback);

      // Clear
      document.getElementById('clearBtn').addEventListener('click', clearPattern);

      // BPM
      document.getElementById('bpm').addEventListener('input', (e) => {
        const val = parseInt(e.target.value);
        document.getElementById('bpmVal').textContent = val;
        Tone.Transport.bpm.value = val;
      });

      // Swing
      document.getElementById('swing').addEventListener('input', (e) => {
        const val = parseFloat(e.target.value);
        document.getElementById('swingVal').textContent = Math.round(val * 100) + '%';
        Tone.Transport.swing = val;
        Tone.Transport.swingSubdivision = '16n';
      });

      // Presets
      document.getElementById('presetBoomBap').addEventListener('click', () => {
        loadPreset('Basic Boom Bap', presets.boomBap,
          'The foundation of hip-hop. Kick on 1 and 3, snare on 2 and 4, straight 8th note hi-hats.');
      });

      document.getElementById('presetDilla').addEventListener('click', () => {
        loadPreset('J Dilla Style', presets.dilla,
          'Off-grid kicks, syncopated snares, off-beat hi-hats with open hat accents. Try adding 15-20% swing!');
      });

      document.getElementById('presetMinimal').addEventListener('click', () => {
        loadPreset('Minimal', presets.minimal,
          'Space and simplicity. Sparse hi-hats leave room for other elements to breathe.');
      });

      document.getElementById('presetBusy').addEventListener('click', () => {
        loadPreset('Busy', presets.busy,
          'More active pattern with ghost kicks and busy hi-hats. Good for uptempo tracks.');
      });

      // Sound test buttons
      document.getElementById('testKick').addEventListener('click', async () => {
        await Tone.start();
        kick.triggerAttackRelease('C1', '8n');
      });

      document.getElementById('testSnare').addEventListener('click', async () => {
        await Tone.start();
        snare.triggerAttackRelease('8n');
      });

      document.getElementById('testHihat').addEventListener('click', async () => {
        await Tone.start();
        hihat.triggerAttackRelease('16n');
      });

      document.getElementById('testOpen').addEventListener('click', async () => {
        await Tone.start();
        openHat.triggerAttackRelease('8n');
      });
    }

    // Initialize
    function init() {
      initDrums();
      buildGrid();
      createLoop();
      setupEventListeners();

      // Set initial BPM
      Tone.Transport.bpm.value = 85;

      // Load default pattern
      loadPreset('Basic Boom Bap', presets.boomBap,
        'The foundation of hip-hop. Kick on 1 and 3, snare on 2 and 4, straight 8th note hi-hats.');
      document.getElementById('presetBoomBap').classList.add('active');
    }

    init();
  </script>
</body>
</html>
