<!DOCTYPE html>
<html>
<head>
  <title>Project 2: Dusty Chords - Demo</title>
  <script src="https://unpkg.com/tone@14"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #eee;
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .container { max-width: 900px; margin: 0 auto; }
    h1 { color: #e94560; margin-bottom: 10px; }
    h2 { color: #4ecdc4; margin-top: 30px; margin-bottom: 15px; }
    .subtitle { color: #888; margin-bottom: 30px; }

    .section {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }

    /* Play controls */
    .play-controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 15px 0;
    }

    button {
      background: #e94560;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
    }
    button:hover { background: #ff6b6b; transform: scale(1.02); }
    button:active { transform: scale(0.98); }
    button:disabled { background: #444; cursor: not-allowed; transform: none; }

    /* A/B buttons */
    .ab-controls {
      display: flex;
      gap: 10px;
      margin: 15px 0;
    }
    .ab-btn {
      flex: 1;
      padding: 15px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 8px;
      transition: all 0.3s;
    }
    .ab-btn.clean {
      background: rgba(78, 205, 196, 0.15);
      color: #4ecdc4;
      border: 2px solid #4ecdc4;
    }
    .ab-btn.clean:hover { background: rgba(78, 205, 196, 0.3); }
    .ab-btn.clean.active { background: #4ecdc4; color: #1a1a2e; }

    .ab-btn.dusty {
      background: rgba(233, 69, 96, 0.15);
      color: #e94560;
      border: 2px solid #e94560;
    }
    .ab-btn.dusty:hover { background: rgba(233, 69, 96, 0.3); }
    .ab-btn.dusty.active { background: #e94560; color: white; }

    /* Effect toggles */
    .effect-toggles {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin: 15px 0;
    }

    .effect-toggle {
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      transition: all 0.3s;
      cursor: pointer;
      border: 2px solid transparent;
    }
    .effect-toggle:hover { background: rgba(0,0,0,0.4); }
    .effect-toggle.active {
      border-color: #4ecdc4;
      background: rgba(78, 205, 196, 0.15);
    }
    .effect-toggle .name {
      font-weight: bold;
      margin-bottom: 5px;
      color: #fff;
    }
    .effect-toggle .status {
      font-size: 12px;
      color: #888;
    }
    .effect-toggle.active .status { color: #4ecdc4; }

    /* Sliders */
    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }

    .control {
      background: rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 8px;
    }
    .control label {
      display: block;
      color: #888;
      font-size: 12px;
      margin-bottom: 5px;
    }
    .control .value {
      color: #e94560;
      font-weight: bold;
      float: right;
    }
    .control input[type="range"] {
      width: 100%;
      margin-top: 5px;
      accent-color: #4ecdc4;
    }

    /* Signal chain visualization */
    .signal-chain {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 20px;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      overflow-x: auto;
      margin: 15px 0;
    }

    .chain-node {
      background: #2a2a4e;
      border: 2px solid #4ecdc4;
      border-radius: 8px;
      padding: 10px 14px;
      min-width: 90px;
      text-align: center;
      transition: all 0.3s;
    }
    .chain-node.source { border-color: #e94560; background: rgba(233, 69, 96, 0.2); }
    .chain-node.output { border-color: #4ecdc4; background: rgba(78, 205, 196, 0.2); }
    .chain-node.inactive {
      opacity: 0.3;
      border-style: dashed;
      background: rgba(50,50,50,0.3);
    }
    .chain-node .name { font-weight: bold; font-size: 13px; }
    .chain-node .param { font-size: 10px; color: #888; margin-top: 3px; }

    .chain-arrow {
      color: #4ecdc4;
      font-size: 18px;
      flex-shrink: 0;
      transition: opacity 0.3s;
    }
    .chain-arrow.dim { opacity: 0.3; }

    /* Noise indicator */
    .noise-indicator {
      position: absolute;
      bottom: -30px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      color: #888;
      white-space: nowrap;
    }
    .chain-wrapper {
      position: relative;
      padding-bottom: 20px;
    }

    #status {
      padding: 12px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      font-size: 14px;
      color: #888;
      text-align: center;
    }

    .info-box {
      background: rgba(78, 205, 196, 0.1);
      border-left: 4px solid #4ecdc4;
      padding: 15px;
      margin: 15px 0;
      border-radius: 0 8px 8px 0;
    }
    .info-box strong { color: #4ecdc4; }

    .tip-box {
      background: rgba(233, 69, 96, 0.1);
      border-left: 4px solid #e94560;
      padding: 15px;
      margin: 15px 0;
      border-radius: 0 8px 8px 0;
    }
    .tip-box strong { color: #e94560; }

    .mode-indicator {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
    }
    .mode-indicator.clean {
      background: rgba(78, 205, 196, 0.2);
      color: #4ecdc4;
    }
    .mode-indicator.dusty {
      background: rgba(233, 69, 96, 0.2);
      color: #e94560;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Project 2: Dusty Chords</h1>
    <p class="subtitle">Add effects to make clean chords sound lofi - warm, spacious, and textured</p>

    <div class="section">
      <h2>1. A/B Comparison</h2>
      <p>Switch between clean and dusty to hear the transformation:</p>

      <div class="ab-controls">
        <button class="ab-btn clean active" id="cleanBtn">CLEAN</button>
        <button class="ab-btn dusty" id="dustyBtn">DUSTY</button>
      </div>

      <div id="status">Click Play to start - then switch between Clean and Dusty!</div>
    </div>

    <div class="section">
      <h2>2. Signal Chain <span class="mode-indicator clean" id="modeIndicator">CLEAN</span></h2>
      <p>Active effects in the current mode:</p>

      <div class="chain-wrapper">
        <div class="signal-chain" id="signalChain">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>

    <div class="section">
      <h2>3. Effect Toggles</h2>
      <p>In Dusty mode, toggle individual effects to hear what each contributes:</p>

      <div class="effect-toggles">
        <div class="effect-toggle active" id="toggleFilter" data-effect="filter">
          <div class="name">Filter</div>
          <div class="status">ON</div>
        </div>
        <div class="effect-toggle active" id="toggleReverb" data-effect="reverb">
          <div class="name">Reverb</div>
          <div class="status">ON</div>
        </div>
        <div class="effect-toggle active" id="toggleNoise" data-effect="noise">
          <div class="name">Vinyl Noise</div>
          <div class="status">ON</div>
        </div>
        <div class="effect-toggle" id="toggleBitcrusher" data-effect="bitcrusher">
          <div class="name">BitCrusher</div>
          <div class="status">OFF</div>
        </div>
      </div>

      <div class="info-box">
        <strong>Tip:</strong> Toggle effects one at a time to understand what each adds to the sound.
        Filter adds warmth, reverb adds space, noise adds texture.
      </div>
    </div>

    <div class="section">
      <h2>4. Effect Parameters</h2>

      <div class="controls-grid">
        <div class="control">
          <label>Filter Cutoff <span class="value" id="filterVal">1200 Hz</span></label>
          <input type="range" id="filterCutoff" min="300" max="3000" step="50" value="1200">
        </div>
        <div class="control">
          <label>Reverb Amount <span class="value" id="reverbVal">35%</span></label>
          <input type="range" id="reverbWet" min="0" max="80" step="5" value="35">
        </div>
        <div class="control">
          <label>Noise Level <span class="value" id="noiseVal">-28 dB</span></label>
          <input type="range" id="noiseLevel" min="-40" max="-18" step="1" value="-28">
        </div>
        <div class="control">
          <label>BitCrusher Bits <span class="value" id="bitsVal">10</span></label>
          <input type="range" id="bitDepth" min="4" max="14" step="1" value="10">
        </div>
      </div>
    </div>

    <div class="section">
      <h2>5. Play Controls</h2>

      <div class="play-controls">
        <button id="playBtn">Play</button>
        <button id="stopBtn" disabled>Stop</button>
      </div>

      <div class="tip-box">
        <strong>Try This:</strong> Start with Clean, then switch to Dusty while playing.
        Notice how the effects add warmth and atmosphere. Toggle individual effects to isolate
        their contribution.
      </div>
    </div>
  </div>

  <script>
    // State
    let isPlaying = false;
    let isDusty = false;
    let effectsEnabled = {
      filter: true,
      reverb: true,
      noise: true,
      bitcrusher: false
    };

    // Audio nodes
    let synth = null;
    let filter = null;
    let reverb = null;
    let bitcrusher = null;
    let noise = null;
    let noiseFilter = null;
    let noiseGain = null;
    let master = null;
    let loop = null;
    let initialized = false;

    // Chord progression
    const chords = [
      ['D3', 'F3', 'A3', 'C4'],  // Dm7
      ['G3', 'B3', 'D4', 'F4'],  // Gmaj7
      ['C3', 'E3', 'G3', 'B3'],  // Cmaj7
      ['A2', 'C3', 'E3', 'G3']   // Am7
    ];

    // Initialize audio
    async function initAudio() {
      if (initialized) return;

      // Synth
      synth = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: 'triangle' },
        envelope: {
          attack: 0.1,
          decay: 0.3,
          sustain: 0.4,
          release: 1.2
        }
      });
      synth.volume.value = -12;

      // Effects
      bitcrusher = new Tone.BitCrusher(parseInt(document.getElementById('bitDepth').value));

      filter = new Tone.Filter({
        frequency: parseInt(document.getElementById('filterCutoff').value),
        type: 'lowpass',
        rolloff: -24,
        Q: 0.7
      });

      reverb = new Tone.Reverb({
        decay: 2.5,
        preDelay: 0.02,
        wet: parseInt(document.getElementById('reverbWet').value) / 100
      });
      await reverb.generate();

      master = new Tone.Volume(-6);

      // Noise
      noise = new Tone.Noise('brown');
      noiseFilter = new Tone.Filter(3000, 'lowpass');
      noiseGain = new Tone.Gain(0); // Start silent, we'll control via dB

      noise.connect(noiseFilter);
      noiseFilter.connect(noiseGain);
      noiseGain.toDestination();

      // Set initial noise level
      updateNoiseLevel();

      // Transport
      Tone.Transport.bpm.value = 72;

      let chordIndex = 0;
      loop = new Tone.Loop((time) => {
        synth.triggerAttackRelease(chords[chordIndex], '2n', time, 0.5);
        chordIndex = (chordIndex + 1) % chords.length;
      }, '2n');

      initialized = true;
      rebuildChain();
    }

    // Rebuild the audio chain based on current settings
    function rebuildChain() {
      if (!initialized) return;

      // Disconnect everything
      synth.disconnect();
      bitcrusher.disconnect();
      filter.disconnect();
      reverb.disconnect();
      master.disconnect();

      if (!isDusty) {
        // Clean mode: synth -> master -> output
        synth.connect(master);
        master.toDestination();
        noiseGain.gain.value = 0;
      } else {
        // Dusty mode: build chain based on enabled effects
        let lastNode = synth;

        if (effectsEnabled.bitcrusher) {
          lastNode.connect(bitcrusher);
          lastNode = bitcrusher;
        }

        if (effectsEnabled.filter) {
          lastNode.connect(filter);
          lastNode = filter;
        }

        if (effectsEnabled.reverb) {
          lastNode.connect(reverb);
          lastNode = reverb;
        }

        lastNode.connect(master);
        master.toDestination();

        // Noise
        updateNoiseLevel();
      }

      updateSignalChain();
    }

    // Update noise level
    function updateNoiseLevel() {
      if (!initialized) return;

      if (isDusty && effectsEnabled.noise) {
        const dbValue = parseInt(document.getElementById('noiseLevel').value);
        noiseGain.gain.value = Math.pow(10, dbValue / 20);
      } else {
        noiseGain.gain.value = 0;
      }
    }

    // Update signal chain visualization
    function updateSignalChain() {
      const container = document.getElementById('signalChain');
      let html = '';

      // Source
      html += `
        <div class="chain-node source">
          <div class="name">Synth</div>
          <div class="param">triangle</div>
        </div>
        <div class="chain-arrow">&#8594;</div>
      `;

      if (isDusty) {
        // BitCrusher
        const bcActive = effectsEnabled.bitcrusher;
        html += `
          <div class="chain-node ${bcActive ? '' : 'inactive'}">
            <div class="name">BitCrusher</div>
            <div class="param">${document.getElementById('bitDepth').value} bits</div>
          </div>
          <div class="chain-arrow ${bcActive ? '' : 'dim'}">&#8594;</div>
        `;

        // Filter
        const fActive = effectsEnabled.filter;
        html += `
          <div class="chain-node ${fActive ? '' : 'inactive'}">
            <div class="name">Filter</div>
            <div class="param">${document.getElementById('filterCutoff').value} Hz</div>
          </div>
          <div class="chain-arrow ${fActive ? '' : 'dim'}">&#8594;</div>
        `;

        // Reverb
        const rActive = effectsEnabled.reverb;
        html += `
          <div class="chain-node ${rActive ? '' : 'inactive'}">
            <div class="name">Reverb</div>
            <div class="param">wet: ${(parseInt(document.getElementById('reverbWet').value) / 100).toFixed(2)}</div>
          </div>
          <div class="chain-arrow ${rActive ? '' : 'dim'}">&#8594;</div>
        `;
      }

      // Output
      html += `
        <div class="chain-node output">
          <div class="name">Output</div>
          <div class="param">speakers</div>
        </div>
      `;

      // Noise indicator (for dusty mode)
      if (isDusty) {
        const nActive = effectsEnabled.noise;
        html += `
          <div style="margin-left: 20px; opacity: ${nActive ? 1 : 0.3}">
            <div class="chain-node" style="border-color: #888; min-width: 80px;">
              <div class="name">Noise</div>
              <div class="param">${document.getElementById('noiseLevel').value} dB</div>
            </div>
            <div style="font-size: 10px; color: #666; text-align: center; margin-top: 4px;">
              (mixed in)
            </div>
          </div>
        `;
      }

      container.innerHTML = html;

      // Update mode indicator
      const indicator = document.getElementById('modeIndicator');
      indicator.textContent = isDusty ? 'DUSTY' : 'CLEAN';
      indicator.className = 'mode-indicator ' + (isDusty ? 'dusty' : 'clean');
    }

    // Toggle effect
    function toggleEffect(effectId) {
      if (!isDusty) return; // Only works in dusty mode

      effectsEnabled[effectId] = !effectsEnabled[effectId];

      const toggle = document.getElementById('toggle' + effectId.charAt(0).toUpperCase() + effectId.slice(1));
      toggle.classList.toggle('active', effectsEnabled[effectId]);
      toggle.querySelector('.status').textContent = effectsEnabled[effectId] ? 'ON' : 'OFF';

      rebuildChain();
    }

    // Update toggle UI based on dusty mode
    function updateToggles() {
      Object.keys(effectsEnabled).forEach(effectId => {
        const toggle = document.getElementById('toggle' + effectId.charAt(0).toUpperCase() + effectId.slice(1));
        if (isDusty) {
          toggle.style.opacity = '1';
          toggle.style.cursor = 'pointer';
        } else {
          toggle.style.opacity = '0.4';
          toggle.style.cursor = 'not-allowed';
        }
      });
    }

    // Play
    async function play() {
      await Tone.start();
      await initAudio();

      loop.start(0);
      noise.start();
      Tone.Transport.start();

      isPlaying = true;
      document.getElementById('playBtn').disabled = true;
      document.getElementById('stopBtn').disabled = false;
      document.getElementById('status').textContent = 'Playing... switch between Clean and Dusty!';
    }

    // Stop
    function stop() {
      Tone.Transport.stop();
      loop.stop();
      noise.stop();

      isPlaying = false;
      document.getElementById('playBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
      document.getElementById('status').textContent = 'Stopped';
    }

    // Set mode
    function setMode(dusty) {
      isDusty = dusty;

      document.getElementById('cleanBtn').classList.toggle('active', !dusty);
      document.getElementById('dustyBtn').classList.toggle('active', dusty);

      updateToggles();
      rebuildChain();

      if (isPlaying) {
        document.getElementById('status').textContent = dusty ?
          'DUSTY mode - hear the warmth and texture!' :
          'CLEAN mode - pure, unprocessed sound';
      }
    }

    // Event listeners
    document.getElementById('playBtn').addEventListener('click', play);
    document.getElementById('stopBtn').addEventListener('click', stop);

    document.getElementById('cleanBtn').addEventListener('click', () => setMode(false));
    document.getElementById('dustyBtn').addEventListener('click', () => setMode(true));

    // Effect toggles
    document.querySelectorAll('.effect-toggle').forEach(toggle => {
      toggle.addEventListener('click', () => {
        const effectId = toggle.dataset.effect;
        toggleEffect(effectId);
      });
    });

    // Sliders
    document.getElementById('filterCutoff').addEventListener('input', (e) => {
      const val = parseInt(e.target.value);
      document.getElementById('filterVal').textContent = val + ' Hz';
      if (filter) {
        filter.frequency.value = val;
        updateSignalChain();
      }
    });

    document.getElementById('reverbWet').addEventListener('input', (e) => {
      const val = parseInt(e.target.value);
      document.getElementById('reverbVal').textContent = val + '%';
      if (reverb) {
        reverb.wet.value = val / 100;
        updateSignalChain();
      }
    });

    document.getElementById('noiseLevel').addEventListener('input', (e) => {
      const val = parseInt(e.target.value);
      document.getElementById('noiseVal').textContent = val + ' dB';
      updateNoiseLevel();
      updateSignalChain();
    });

    document.getElementById('bitDepth').addEventListener('input', (e) => {
      const val = parseInt(e.target.value);
      document.getElementById('bitsVal').textContent = val;
      if (bitcrusher) {
        bitcrusher.bits.value = val;
        updateSignalChain();
      }
    });

    // Initialize UI
    updateSignalChain();
    updateToggles();
  </script>
</body>
</html>
