<!DOCTYPE html>
<html>
<head>
  <title>Samplers - Demo</title>
  <script src="https://unpkg.com/tone@14"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #eee;
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .container { max-width: 900px; margin: 0 auto; }
    h1 { color: #e94560; margin-bottom: 10px; }
    h2 { color: #4ecdc4; margin-top: 30px; }
    .subtitle { color: #888; margin-bottom: 30px; }

    .section {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }

    .control {
      background: rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 8px;
    }
    .control label {
      display: block;
      color: #888;
      font-size: 12px;
      margin-bottom: 5px;
    }
    .control .value {
      color: #e94560;
      font-weight: bold;
      float: right;
    }
    .control input[type="range"] {
      width: 100%;
      margin-top: 5px;
    }
    .control select {
      width: 100%;
      padding: 8px;
      background: #2a2a4e;
      color: #eee;
      border: 1px solid #444;
      border-radius: 4px;
    }

    button {
      background: #e94560;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 8px;
      margin: 5px;
      transition: transform 0.1s, background 0.2s;
    }
    button:hover { background: #ff6b6b; transform: scale(1.02); }
    button:active { transform: scale(0.98); }
    button:disabled { background: #444; cursor: not-allowed; transform: none; }

    .keyboard {
      display: flex;
      gap: 5px;
      margin: 15px 0;
      flex-wrap: wrap;
    }
    .key {
      background: #4ecdc4;
      color: #1a1a2e;
      border: none;
      padding: 20px 15px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.1s;
      min-width: 45px;
    }
    .key:hover { background: #6ee7df; transform: translateY(-2px); }
    .key:active { transform: translateY(0); }
    .key.black { background: #2a2a4e; color: #eee; padding: 15px 10px; }
    .key.black:hover { background: #3a3a6e; }
    .key:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    #status {
      text-align: center;
      padding: 10px;
      color: #888;
      font-size: 14px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      margin: 10px 0;
    }

    .comparison {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .comparison-box {
      background: rgba(0,0,0,0.2);
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .comparison-box h3 {
      color: #e94560;
      margin-top: 0;
      margin-bottom: 15px;
    }
    .comparison-box.synth h3 { color: #4ecdc4; }

    .loading {
      color: #ffd700;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .info-box {
      background: rgba(78, 205, 196, 0.1);
      border-left: 4px solid #4ecdc4;
      padding: 15px;
      margin: 15px 0;
      border-radius: 0 8px 8px 0;
    }
    .info-box.tip {
      background: rgba(233, 69, 96, 0.1);
      border-left-color: #e94560;
    }

    .grain-visual {
      height: 80px;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      margin: 15px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }
    .grain {
      width: 20px;
      height: 40px;
      background: #e94560;
      margin: 0 2px;
      border-radius: 4px;
      opacity: 0.7;
      transition: height 0.1s;
    }
    .grain.active {
      height: 60px;
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Samplers</h1>
    <p class="subtitle">Using recorded audio as your sound source</p>

    <div id="status" class="loading">Loading samples... This may take a moment.</div>

    <div class="section">
      <h2>1. Sampled vs Synthesized Piano</h2>
      <p>Hear the difference between a real piano recording and a synthesized approximation.</p>

      <div class="comparison">
        <div class="comparison-box">
          <h3>Sampled Piano</h3>
          <p style="color: #888; font-size: 12px;">Real Salamander piano recordings</p>
          <div class="keyboard" id="samplerKeys">
            <button class="key" data-note="C4" disabled>C</button>
            <button class="key black" data-note="C#4" disabled>C#</button>
            <button class="key" data-note="D4" disabled>D</button>
            <button class="key black" data-note="D#4" disabled>D#</button>
            <button class="key" data-note="E4" disabled>E</button>
            <button class="key" data-note="F4" disabled>F</button>
            <button class="key black" data-note="F#4" disabled>F#</button>
            <button class="key" data-note="G4" disabled>G</button>
          </div>
          <button id="playChordSampled" disabled>Play Chord (Cmaj7)</button>
        </div>

        <div class="comparison-box synth">
          <h3>Synthesized Piano</h3>
          <p style="color: #888; font-size: 12px;">Triangle wave approximation</p>
          <div class="keyboard" id="synthKeys">
            <button class="key" data-note="C4">C</button>
            <button class="key black" data-note="C#4">C#</button>
            <button class="key" data-note="D4">D</button>
            <button class="key black" data-note="D#4">D#</button>
            <button class="key" data-note="E4">E</button>
            <button class="key" data-note="F4">F</button>
            <button class="key black" data-note="F#4">F#</button>
            <button class="key" data-note="G4">G</button>
          </div>
          <button id="playChordSynth">Play Chord (Cmaj7)</button>
        </div>
      </div>

      <div class="info-box">
        <strong>Notice the difference?</strong> Sampled instruments capture the natural harmonics,
        resonance, and imperfections of real recordings. Synthesizers generate mathematically
        perfect waveforms that can sound "sterile" in comparison.
      </div>
    </div>

    <div class="section">
      <h2>2. Pitch Shifting Samples</h2>
      <p>Classic lofi technique: slow down samples for a dreamy, warm character.</p>

      <div class="controls">
        <div class="control">
          <label>Playback Rate <span class="value" id="rateVal">1.0x</span></label>
          <input type="range" id="playbackRate" min="0.5" max="1.5" step="0.05" value="1">
        </div>
        <div class="control">
          <label>Detune (cents) <span class="value" id="detuneVal">0</span></label>
          <input type="range" id="detune" min="-1200" max="1200" step="100" value="0">
        </div>
      </div>

      <button id="playPitched" disabled>Play Pitched Sample</button>
      <button id="resetPitch">Reset to Normal</button>

      <div class="info-box tip">
        <strong>Tip:</strong> In classic lofi, samples are often pitched down
        (0.8x - 0.9x) to add warmth and nostalgia. This also lowers the pitch,
        creating that characteristic "slowed" sound.
      </div>
    </div>

    <div class="section">
      <h2>3. Granular Texture</h2>
      <p>GrainPlayer chops audio into tiny pieces and reassembles them for unique textures.</p>

      <div class="grain-visual" id="grainVisual">
        <div class="grain"></div>
        <div class="grain"></div>
        <div class="grain"></div>
        <div class="grain"></div>
        <div class="grain"></div>
        <div class="grain"></div>
        <div class="grain"></div>
        <div class="grain"></div>
        <div class="grain"></div>
        <div class="grain"></div>
      </div>

      <div class="controls">
        <div class="control">
          <label>Grain Size <span class="value" id="grainSizeVal">0.1s</span></label>
          <input type="range" id="grainSize" min="0.01" max="0.5" step="0.01" value="0.1">
        </div>
        <div class="control">
          <label>Overlap <span class="value" id="overlapVal">0.05s</span></label>
          <input type="range" id="overlap" min="0" max="0.2" step="0.01" value="0.05">
        </div>
        <div class="control">
          <label>Playback Rate <span class="value" id="grainRateVal">1.0x</span></label>
          <input type="range" id="grainRate" min="0.25" max="2" step="0.05" value="1">
        </div>
      </div>

      <button id="startGrain" disabled>Start Granular</button>
      <button id="stopGrain" disabled>Stop</button>

      <div class="info-box">
        <strong>Granular magic:</strong> Unlike normal playback, granular synthesis can
        change speed without changing pitch (and vice versa). Perfect for creating
        ambient textures and experimental soundscapes.
      </div>
    </div>

    <div class="section">
      <h2>4. Lofi Chord Progression</h2>
      <p>A classic lofi progression using sampled piano with effects.</p>

      <div class="controls">
        <div class="control">
          <label>Reverb <span class="value" id="reverbVal">30%</span></label>
          <input type="range" id="reverb" min="0" max="1" step="0.05" value="0.3">
        </div>
        <div class="control">
          <label>Filter Cutoff <span class="value" id="filterVal">2000 Hz</span></label>
          <input type="range" id="filter" min="200" max="8000" step="100" value="2000">
        </div>
      </div>

      <button id="startProgression" disabled>Start Progression</button>
      <button id="stopProgression" disabled>Stop</button>
    </div>
  </div>

  <script>
    // Global state
    let sampler = null;
    let synth = null;
    let grainPlayer = null;
    let filter = null;
    let reverb = null;
    let progressionLoop = null;
    let samplerReady = false;
    let grainReady = false;

    // Status updates
    function updateStatus(msg, isLoading = false) {
      const status = document.getElementById('status');
      status.textContent = msg;
      status.className = isLoading ? 'loading' : '';
    }

    // Initialize sampled piano (Salamander)
    async function initSampler() {
      updateStatus('Loading Salamander piano samples...', true);

      try {
        // Create effects chain
        filter = new Tone.Filter(2000, 'lowpass').toDestination();
        reverb = new Tone.Reverb({ decay: 2.5, wet: 0.3 });
        await reverb.generate();
        reverb.connect(filter);

        // Load sampler with Salamander piano
        sampler = new Tone.Sampler({
          urls: {
            'A0': 'A0.mp3',
            'C1': 'C1.mp3',
            'D#1': 'Ds1.mp3',
            'F#1': 'Fs1.mp3',
            'A1': 'A1.mp3',
            'C2': 'C2.mp3',
            'D#2': 'Ds2.mp3',
            'F#2': 'Fs2.mp3',
            'A2': 'A2.mp3',
            'C3': 'C3.mp3',
            'D#3': 'Ds3.mp3',
            'F#3': 'Fs3.mp3',
            'A3': 'A3.mp3',
            'C4': 'C4.mp3',
            'D#4': 'Ds4.mp3',
            'F#4': 'Fs4.mp3',
            'A4': 'A4.mp3',
            'C5': 'C5.mp3',
            'D#5': 'Ds5.mp3',
            'F#5': 'Fs5.mp3',
            'A5': 'A5.mp3',
          },
          baseUrl: 'https://tonejs.github.io/audio/salamander/',
          release: 1,
          onload: () => {
            samplerReady = true;
            enableSamplerButtons();
            checkAllLoaded();
          }
        }).connect(reverb);

        sampler.volume.value = -6;

      } catch (err) {
        updateStatus('Error loading samples: ' + err.message);
        console.error(err);
      }
    }

    // Initialize synth for comparison
    function initSynth() {
      synth = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: 'triangle' },
        envelope: {
          attack: 0.02,
          decay: 0.3,
          sustain: 0.4,
          release: 1
        }
      }).toDestination();
      synth.volume.value = -6;
    }

    // Initialize grain player with generated buffer
    async function initGrainPlayer() {
      try {
        // Create a simple tone buffer for granular demo
        // Using a generated buffer instead of external file
        const duration = 2;
        const sampleRate = Tone.context.sampleRate;
        const buffer = Tone.context.createBuffer(1, sampleRate * duration, sampleRate);
        const data = buffer.getChannelData(0);

        // Generate a rich tone with harmonics
        for (let i = 0; i < data.length; i++) {
          const t = i / sampleRate;
          // Fundamental + harmonics for a rich sound
          data[i] = 0.3 * Math.sin(2 * Math.PI * 220 * t) +
                    0.2 * Math.sin(2 * Math.PI * 440 * t) +
                    0.1 * Math.sin(2 * Math.PI * 660 * t) +
                    0.05 * Math.sin(2 * Math.PI * 880 * t);
          // Add subtle amplitude variation
          data[i] *= 0.5 + 0.5 * Math.sin(2 * Math.PI * 0.5 * t);
        }

        const toneBuffer = new Tone.ToneAudioBuffer(buffer);

        grainPlayer = new Tone.GrainPlayer({
          url: toneBuffer,
          grainSize: 0.1,
          overlap: 0.05,
          playbackRate: 1,
          loop: true
        }).toDestination();

        grainPlayer.volume.value = -12;
        grainReady = true;

        document.getElementById('startGrain').disabled = false;
        checkAllLoaded();

      } catch (err) {
        console.error('Grain player error:', err);
      }
    }

    // Enable sampler buttons once loaded
    function enableSamplerButtons() {
      document.querySelectorAll('#samplerKeys .key').forEach(key => {
        key.disabled = false;
      });
      document.getElementById('playChordSampled').disabled = false;
      document.getElementById('playPitched').disabled = false;
      document.getElementById('startProgression').disabled = false;
    }

    function checkAllLoaded() {
      if (samplerReady && grainReady) {
        updateStatus('All samples loaded! Click any key to play.');
      } else if (samplerReady) {
        updateStatus('Piano loaded. Preparing granular player...');
      }
    }

    // Play note on sampler
    async function playSamplerNote(note) {
      await Tone.start();
      if (samplerReady) {
        sampler.triggerAttackRelease(note, '4n');
      }
    }

    // Play note on synth
    async function playSynthNote(note) {
      await Tone.start();
      synth.triggerAttackRelease(note, '4n');
    }

    // Setup event listeners
    function setupEventListeners() {
      // Sampler keyboard
      document.querySelectorAll('#samplerKeys .key').forEach(key => {
        key.addEventListener('click', () => {
          playSamplerNote(key.dataset.note);
        });
      });

      // Synth keyboard
      document.querySelectorAll('#synthKeys .key').forEach(key => {
        key.addEventListener('click', () => {
          playSynthNote(key.dataset.note);
        });
      });

      // Chord buttons
      document.getElementById('playChordSampled').addEventListener('click', async () => {
        await Tone.start();
        if (samplerReady) {
          sampler.triggerAttackRelease(['C4', 'E4', 'G4', 'B4'], '2n');
        }
      });

      document.getElementById('playChordSynth').addEventListener('click', async () => {
        await Tone.start();
        synth.triggerAttackRelease(['C4', 'E4', 'G4', 'B4'], '2n');
      });

      // Pitch controls
      document.getElementById('playbackRate').addEventListener('input', (e) => {
        const val = parseFloat(e.target.value);
        document.getElementById('rateVal').textContent = val.toFixed(2) + 'x';
      });

      document.getElementById('detune').addEventListener('input', (e) => {
        const val = parseInt(e.target.value);
        document.getElementById('detuneVal').textContent = val;
      });

      document.getElementById('playPitched').addEventListener('click', async () => {
        await Tone.start();
        if (samplerReady) {
          // Create a temporary player-like experience with the sampler
          const rate = parseFloat(document.getElementById('playbackRate').value);
          const detune = parseInt(document.getElementById('detune').value);

          // Apply detune to sampler temporarily
          const originalDetune = sampler.detune;
          sampler.set({ detune: detune });

          // Play a melody with rate-adjusted timing
          const notes = ['C4', 'E4', 'G4', 'C5'];
          notes.forEach((note, i) => {
            setTimeout(() => {
              sampler.triggerAttackRelease(note, '8n');
            }, i * (400 / rate));
          });
        }
      });

      document.getElementById('resetPitch').addEventListener('click', () => {
        document.getElementById('playbackRate').value = 1;
        document.getElementById('rateVal').textContent = '1.0x';
        document.getElementById('detune').value = 0;
        document.getElementById('detuneVal').textContent = '0';
      });

      // Grain controls
      document.getElementById('grainSize').addEventListener('input', (e) => {
        const val = parseFloat(e.target.value);
        document.getElementById('grainSizeVal').textContent = val.toFixed(2) + 's';
        if (grainPlayer) grainPlayer.grainSize = val;
      });

      document.getElementById('overlap').addEventListener('input', (e) => {
        const val = parseFloat(e.target.value);
        document.getElementById('overlapVal').textContent = val.toFixed(2) + 's';
        if (grainPlayer) grainPlayer.overlap = val;
      });

      document.getElementById('grainRate').addEventListener('input', (e) => {
        const val = parseFloat(e.target.value);
        document.getElementById('grainRateVal').textContent = val.toFixed(2) + 'x';
        if (grainPlayer) grainPlayer.playbackRate = val;
      });

      document.getElementById('startGrain').addEventListener('click', async () => {
        await Tone.start();
        if (grainReady) {
          grainPlayer.start();
          document.getElementById('startGrain').disabled = true;
          document.getElementById('stopGrain').disabled = false;
          animateGrains();
        }
      });

      document.getElementById('stopGrain').addEventListener('click', () => {
        if (grainPlayer) {
          grainPlayer.stop();
          document.getElementById('startGrain').disabled = false;
          document.getElementById('stopGrain').disabled = true;
          stopGrainAnimation();
        }
      });

      // Effects controls
      document.getElementById('reverb').addEventListener('input', (e) => {
        const val = parseFloat(e.target.value);
        document.getElementById('reverbVal').textContent = Math.round(val * 100) + '%';
        if (reverb) reverb.wet.value = val;
      });

      document.getElementById('filter').addEventListener('input', (e) => {
        const val = parseInt(e.target.value);
        document.getElementById('filterVal').textContent = val + ' Hz';
        if (filter) filter.frequency.value = val;
      });

      // Progression
      const chords = [
        ['C3', 'E3', 'G3', 'B3'],    // Cmaj7
        ['A2', 'C3', 'E3', 'G3'],    // Am7
        ['F2', 'A2', 'C3', 'E3'],    // Fmaj7
        ['G2', 'B2', 'D3', 'F3'],    // G7
      ];
      let chordIndex = 0;

      document.getElementById('startProgression').addEventListener('click', async () => {
        await Tone.start();
        if (!samplerReady) return;

        Tone.Transport.bpm.value = 72;

        progressionLoop = new Tone.Loop((time) => {
          sampler.triggerAttackRelease(chords[chordIndex], '2n', time);
          chordIndex = (chordIndex + 1) % chords.length;
        }, '1n').start(0);

        Tone.Transport.start();
        document.getElementById('startProgression').disabled = true;
        document.getElementById('stopProgression').disabled = false;
      });

      document.getElementById('stopProgression').addEventListener('click', () => {
        Tone.Transport.stop();
        if (progressionLoop) {
          progressionLoop.dispose();
          progressionLoop = null;
        }
        chordIndex = 0;
        document.getElementById('startProgression').disabled = false;
        document.getElementById('stopProgression').disabled = true;
      });
    }

    // Grain animation
    let grainAnimationId = null;
    function animateGrains() {
      const grains = document.querySelectorAll('.grain');
      let activeIndex = 0;

      function animate() {
        grains.forEach((g, i) => g.classList.remove('active'));
        grains[activeIndex].classList.add('active');
        activeIndex = (activeIndex + 1) % grains.length;
        grainAnimationId = setTimeout(animate, 100);
      }
      animate();
    }

    function stopGrainAnimation() {
      if (grainAnimationId) {
        clearTimeout(grainAnimationId);
        grainAnimationId = null;
      }
      document.querySelectorAll('.grain').forEach(g => g.classList.remove('active'));
    }

    // Keyboard input
    const keyMap = {
      'a': 'C4', 'w': 'C#4', 's': 'D4', 'e': 'D#4', 'd': 'E4',
      'f': 'F4', 't': 'F#4', 'g': 'G4'
    };

    document.addEventListener('keydown', (e) => {
      const note = keyMap[e.key.toLowerCase()];
      if (note && samplerReady) {
        playSamplerNote(note);
      }
    });

    // Initialize everything
    async function init() {
      initSynth();
      setupEventListeners();
      await initSampler();
      await initGrainPlayer();
    }

    init();
  </script>
</body>
</html>
