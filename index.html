<!DOCTYPE html>
<html>
<head>
  <title>Lofi Generator</title>
  <script src="https://unpkg.com/tone@14"></script>
  <style>
    body {
      background: #1a1a2e;
      color: #eee;
      font-family: monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }
    button {
      background: #e94560;
      color: white;
      border: none;
      padding: 20px 40px;
      font-size: 24px;
      cursor: pointer;
      border-radius: 8px;
      margin: 10px;
    }
    button:hover { background: #ff6b6b; }
    #status { margin-top: 20px; font-size: 18px; }
  </style>
</head>
<body>
  <h1>Lofi Generator</h1>
  <button id="start">Start Lofi</button>
  <button id="stop" disabled>Stop</button>
  <div id="status">Click Start to play</div>

  <script>
    // Richer jazz chords with extensions
    const chords = [
      ['D2', 'A2', 'C3', 'E3', 'F3'],      // Dm9
      ['G2', 'D3', 'F3', 'A3', 'B3'],      // G13
      ['C2', 'G2', 'B2', 'D3', 'E3'],      // Cmaj9
      ['A2', 'E3', 'G3', 'B3', 'D4'],      // Am9
      ['F2', 'C3', 'E3', 'G3', 'A3'],      // Fmaj9
      ['E2', 'B2', 'D3', 'G3', 'A3'],      // Em11
    ];

    const bassNotes = ['D2', 'G2', 'C2', 'A1', 'F2', 'E2'];

    let playing = false;

    async function startLofi() {
      await Tone.start();

      // Master volume (~10% - perfect background music level)
      // Site always outputs at this level, user controls their system volume
      const master = new Tone.Gain(0.1).toDestination();

      // Slow breathing volume LFO - gentle swells around 10%
      const breathLFO = new Tone.LFO({
        frequency: 0.08,   // ~12 sec cycle
        min: 0.08,
        max: 0.12
      }).start();
      breathLFO.connect(master.gain);

      // Master effects chain
      const reverb = new Tone.Reverb({ decay: 3, wet: 0.3 });
      await reverb.generate();  // Reverb needs async init
      reverb.connect(master);
      const delay = new Tone.FeedbackDelay('8n.', 0.3).connect(reverb);
      delay.wet.value = 0.2;

      // Lowpass for lofi warmth
      const lopass = new Tone.Filter(2500, 'lowpass').connect(delay);

      // Bitcrusher for that dusty feel
      const crusher = new Tone.BitCrusher(8).connect(lopass);

      // Warm Rhodes-like EP
      const ep = new Tone.PolySynth(Tone.FMSynth, {
        harmonicity: 2,
        modulationIndex: 1.5,
        oscillator: { type: 'sine' },
        envelope: { attack: 0.01, decay: 0.3, sustain: 0.5, release: 1.5 },
        modulation: { type: 'triangle' },
        modulationEnvelope: { attack: 0.01, decay: 0.2, sustain: 0.3, release: 0.5 }
      }).connect(crusher);
      ep.volume.value = -14;

      // Sub bass
      const bass = new Tone.MonoSynth({
        oscillator: { type: 'triangle' },
        envelope: { attack: 0.05, decay: 0.3, sustain: 0.7, release: 0.5 },
        filterEnvelope: { attack: 0.05, decay: 0.2, sustain: 0.5, release: 0.5, baseFrequency: 200, octaves: 2 }
      }).connect(lopass);
      bass.volume.value = -10;

      // Vinyl crackle + hiss
      const noise = new Tone.Noise('brown').start();
      const noiseFilter = new Tone.Filter(1000, 'lowpass').toDestination();
      noise.connect(noiseFilter);
      noise.volume.value = -30;

      // Crackle pops
      const crackle = new Tone.Noise('white');
      const crackleEnv = new Tone.AmplitudeEnvelope({ attack: 0.001, decay: 0.02, sustain: 0, release: 0.01 }).toDestination();
      crackle.connect(crackleEnv);
      crackle.start();
      crackleEnv.volume.value = -25;

      // Drums with swing
      Tone.Transport.swing = 0.3;
      Tone.Transport.swingSubdivision = '16n';

      const kick = new Tone.MembraneSynth({
        pitchDecay: 0.08,
        octaves: 6,
        envelope: { attack: 0.001, decay: 0.25, sustain: 0, release: 0.4 }
      }).connect(lopass);
      kick.volume.value = -6;

      const snare = new Tone.NoiseSynth({
        noise: { type: 'white' },
        envelope: { attack: 0.001, decay: 0.15, sustain: 0, release: 0.1 }
      }).connect(lopass);
      snare.volume.value = -12;

      const hihat = new Tone.MetalSynth({
        frequency: 300,
        envelope: { attack: 0.001, decay: 0.06, release: 0.01 },
        harmonicity: 5.1,
        modulationIndex: 32,
        resonance: 4000,
        octaves: 1
      }).connect(lopass);
      hihat.volume.value = -22;

      // Shaker
      const shaker = new Tone.NoiseSynth({
        noise: { type: 'pink' },
        envelope: { attack: 0.005, decay: 0.05, sustain: 0, release: 0.03 }
      }).connect(lopass);
      shaker.volume.value = -24;

      Tone.Transport.bpm.value = 72;

      let chordIndex = 0;

      // Chord progression with humanization
      new Tone.Loop((time) => {
        const chord = chords[chordIndex];
        // Stagger notes slightly for human feel
        chord.forEach((note, i) => {
          const offset = i * 0.02 + Math.random() * 0.01;
          const vel = 0.4 + Math.random() * 0.2;
          ep.triggerAttackRelease(note, '2n', time + offset, vel);
        });

        // Bass follows root
        bass.triggerAttackRelease(bassNotes[chordIndex], '2n', time + 0.01, 0.7);

        chordIndex = (chordIndex + 1) % chords.length;
      }, '2n').start(0);

      // Kick pattern - boom bap
      new Tone.Sequence((time, note) => {
        if (note) kick.triggerAttackRelease('C1', '8n', time, 0.8 + Math.random() * 0.2);
      }, [1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 0], '16n').start(0);

      // Snare on 2 and 4
      new Tone.Sequence((time, note) => {
        if (note) snare.triggerAttackRelease('8n', time, 0.5 + Math.random() * 0.2);
      }, [0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0], '16n').start(0);

      // Hihat pattern with ghost notes
      new Tone.Sequence((time, vel) => {
        if (vel > 0) hihat.triggerAttackRelease('32n', time, vel * (0.8 + Math.random() * 0.4));
      }, [0.6, 0.2, 0.4, 0.2, 0.6, 0.2, 0.5, 0.3, 0.6, 0.2, 0.4, 0.2, 0.6, 0.2, 0.5, 0.2], '16n').start(0);

      // Shaker fills
      new Tone.Loop((time) => {
        if (Math.random() > 0.6) {
          shaker.triggerAttackRelease('16n', time, 0.3 + Math.random() * 0.3);
        }
      }, '16n').start(0);

      // Random vinyl crackle
      new Tone.Loop((time) => {
        if (Math.random() > 0.85) {
          crackleEnv.triggerAttack(time);
        }
      }, '32n').start(0);

      Tone.Transport.start();
      playing = true;
      document.getElementById('status').textContent = 'Playing lofi beats...';
      document.getElementById('start').disabled = true;
      document.getElementById('stop').disabled = false;
    }

    function stopLofi() {
      Tone.Transport.stop();
      Tone.Transport.cancel();
      playing = false;
      document.getElementById('status').textContent = 'Stopped';
      document.getElementById('start').disabled = false;
      document.getElementById('stop').disabled = true;
      // Reload to clean up all nodes
      setTimeout(() => location.reload(), 100);
    }

    document.getElementById('start').addEventListener('click', startLofi);
    document.getElementById('stop').addEventListener('click', stopLofi);
  </script>
</body>
</html>
